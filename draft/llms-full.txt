# Universal Commerce Protocol (UCP)

> The Universal Commerce Protocol (UCP) is a solution for enabling gen AI agents to make payments on behalf of users, safely, securely, and in a decentralized and privacy protecting manner. This protocol is a part of the broader ecosystem, which includes agentic protocols like A2A and MCP, and encompasses the global nature of payments.


# Introduction

# Universal Commerce Protocol

The common language for platforms, agents and businesses.

UCP defines building blocks for agentic commerce—from discovering and buying to post purchase experiences—allowing the ecosystem to interoperate through one standard, without custom builds.

### Learn

Protocol overview, core concepts, and design principles

[Read the docs](https://ucp.dev/draft/specification/overview/index.md)

### Implement

GitHub repo, technical spec, SDKs, and reference implementations

[View on GitHub](https://github.com/Universal-Commerce-Protocol/ucp)

## Co-developed and adopted by industry leaders

UCP was built by the industry, for the industry to solve for fragmented commerce journeys that lead to abandoned carts and frustrated shoppers, and enable agentic commerce.

Google

Shopify

Etsy

Wayfair

Target

Walmart

## Built for flexibility, security, and scale

Agentic commerce demands interoperability. UCP is built on industry standards — REST and JSON-RPC transports; [Agent Payments Protocol (AP2)](https://ap2-protocol.org/), [Agent2Agent (A2A)](https://a2a-protocol.org/latest/), and [Model Context Protocol (MCP)](https://modelcontextprotocol.io/docs/getting-started/intro) support built-in — so different systems can work together without custom integration.

### Scalable and universal

Surface-agnostic design that can scale to support any commerce entity (from small businesses to enterprise scale) and all modalities (chat, visual commerce, voice, etc).

### Businesses at the center

Built to facilitate commerce, ensuring retailers retain control of their business rules and remain the Merchant of Record with full ownership of the customer relationship.

### Open and extensible

Open and extensible by design, enabling development of community-driven capabilities and extensions across verticals.

### Secure and private

Built on proven security standards for account linking (OAuth 2.0) and secure payment (AP2) via payment mandates and verifiable credentials.

### Frictionless payments

Open wallet ecosystem with interoperability between providers to ensure buyers can pay with their preferred payment methods.

## See it in action

UCP is designed to facilitate the entire commerce lifecycle, from initial product discovery and search to final sale and post-purchase support. The protocol's initial launch focuses on three core capabilities: Checkout, Identity Linking, and Order Management.

Checkout Identity Linking Order

SEE IT IN ACTION

### Checkout

Support complex cart logic, dynamic pricing, tax calculations, and more across millions of businesses through unified checkout sessions.

[Learn more](https://ucp.dev/draft/specification/checkout-rest/index.md)

```json
{
  "ucp": { ... },
  "id": "chk_123456789",
  "status": "ready_for_complete",
  "currency": "USD",
  "buyer": {
    "email": "e.beckett@example.com",
    "first_name": "Elisa",
    "last_name": "Beckett"
  },
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Monos Carry-On Pro suitcase",
        "price": 26550
      },
      "quantity": 1,
      ...
    }
  ],
  "totals": [ ... ],
  "links": [ ... ],
  "payment": { ... },
  "fulfillment": {
    "methods": [
      {
        "id": "method_1",
        "type": "shipping",
        "line_item_ids": ["li_1"],
        "selected_destination_id": "dest_1",
        "destinations": [
          {
            "id": "dest_1",
            "first_name": "Elisa",
            "last_name": "Beckett",
            "street_address": "1600 Amphitheatre Pkwy",
            "address_locality": "Mountain View",
            "address_region": "CA",
            "postal_code": "94043",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "group_1",
            "line_item_ids": ["li_1"],
            "selected_option_id": "free-shipping",
            "options": [
              {
                "id": "free-shipping",
                "title": "Free Shipping",
                "totals": [ {"type": "total", "amount": 0} ]
              }
            ]
          }
        ]
      }
    ]
  }
}
```

SEE IT IN ACTION

### Identity Linking

OAuth 2.0 standard enables agents to maintain secure, authorized relationships without sharing credentials.

[Learn more](https://ucp.dev/draft/specification/identity-linking/index.md)

```json
Sample of /.well-known/oauth-authorization-server

{
  "issuer": "https://example.com",
  "authorization_endpoint": "https://example.com/oauth2/authorize",
  "token_endpoint": "https://example.com/oauth2/token",
  "revocation_endpoint": "https://example.com/oauth2/revoke",
  "scopes_supported": [
    "ucp:scopes:checkout_session",
  ],
  "response_types_supported": [
    "code"
  ],
  "grant_types_supported": [
    "authorization_code",
    "refresh_token"
  ],
  "token_endpoint_auth_methods_supported": [
    "client_secret_basic"
  ],
  "service_documentation": "https://example.com/docs/oauth2"
}
```

SEE IT IN ACTION

### Order

From purchase confirmation to delivery. Real-time webhooks power status updates, shipment tracking, and return processing across every channel.

[Learn more](https://ucp.dev/draft/specification/order/index.md)

```json
{
  "ucp": { ... },
  "id": "order_123456789",
  "checkout_id": "chk_123456789",
  "permalink_url": ...,
  "line_items": [ ... ],
  "fulfillment": {
    "expectations": [
      {
        "id": "exp_1",
        "line_items": [{ "id": "li_1", "quantity": 1 }],
        "method_type": "shipping",
        "destination": {
          "first_name": "Elisa",
          "last_name": "Beckett",
          "street_address": "1600 Amphitheatre Pkwy",
          "address_locality": "Mountain View",
          "address_region": "CA",
          "postal_code": "94043",
          "address_country": "US"
        },
        "description": "Arrives in 2-3 business days",
        "fulfillable_on": "now"
      }
      ...
    ],
    "events": [
      {
        "id": "evt_1",
        "occurred_at": "2026-01-11T10:30:00Z",
        "type": "delivered",
        "line_items": [{ "id": "li_1", "quantity": 1 }],
        "tracking_number": "123456789",
        "tracking_url": "https://fedex.com/track/123456789",
        "description": "Delivered to front door"
      }
    ]
  },
  "adjustments": [
    {
      "id": "adj_1",
      "type": "refund",
      "occurred_at": "2026-01-12T14:30:00Z",
      "status": "completed",
      "line_items": [{ "id": "li_1", "quantity": 1 }],
      "amount": 26550,
      "description": "Defective item"
    }
  ],
  "totals": [ ... ]
}
```

### Power native checkout

Integrate and negotiate directly with a seller's checkout API to power native UI and workflows for your platform.

[See how it works](https://ucp.dev/draft/specification/checkout-rest/index.md)

### Embed business checkout

Embed and render business checkout UI to support complex checkout flows, with advanced capabilities like bidirectional communication, and payment and shipping address delegation.

[Learn more](https://ucp.dev/draft/specification/embedded-checkout/index.md)

## Designed for the entire commerce ecosystem

### For Developers

Build the future of commerce on an open foundation. Join our community in evolving an open-source standard designed for the next generation of digital commerce.

[View the technical spec](https://ucp.dev/draft/specification/overview/index.md)

### For Businesses

UCP empowers retailers to meet customers wherever they are—AI assistants, shopping agents, embedded experiences—without rebuilding your checkout for each. You remain the Merchant of Record and your business logic stays intact.

[Integrate with UCP](https://developers.google.com/merchant/ucp/)

### For AI Platforms

Simplify business onboarding with standardized APIs and provide your audience with an integrated shopping experience. Compatible with MCP, A2A, and existing agent frameworks.

[Learn more about UCP core concepts](https://ucp.dev/draft/documentation/core-concepts/index.md)

### For Payment Providers

Universal payments that are provable—every authorization backed by cryptographic proof of user consent. Open, modular payment handler design enables open interoperability and choice of payment methods.

[Learn more about UCP and AP2](https://ucp.dev/draft/documentation/ucp-and-ap2/index.md)

## Endorsed across the ecosystem

Adyen

Amex

Ant International

Best Buy

Carrefour

Chewy

Commerce

Flipkart

Gap

Kroger

Lowe's

Macy's

Mastercard

Paypal

Salesforce

Sephora

Shopee

Stripe

The Home Depot

Ulta

Visa

Worldpay

Zalando

Adyen

Amex

Ant International

Best Buy

Carrefour

Chewy

Commerce

Flipkart

Gap

Kroger

Lowe's

Macy's

Mastercard

Paypal

Salesforce

Sephora

Shopee

Stripe

The Home Depot

Ulta

Visa

Worldpay

Zalando

## Get started today

UCP is an open standard designed to let AI agents, apps, businesses, and payment providers interact seamlessly without needing custom, one-off integrations for every connection. We actively seek your feedback and contributions to help build the future of commerce.

The complete technical specification, documentation, and reference implementations are hosted in our public GitHub repository.

### [Download](https://github.com/Universal-Commerce-Protocol/samples)

Download and run our code samples

### [Experiment](https://ucp.dev/playground/)

Experiment with the protocol and its different agent roles

### [Contribute](https://github.com/Universal-Commerce-Protocol/ucp/blob/main/CONTRIBUTING.md)

Contribute your feedback and code to the public repository

[Visit the GitHub repository](https://github.com/Universal-Commerce-Protocol/ucp)

# Core Concepts

The Universal Commerce Protocol (UCP) is an open standard designed to facilitate communication and interoperability between diverse commerce entities. In a fragmented landscape where consumer surfaces/platforms, businesses, payment providers, and identity providers operate on different systems, UCP provides a standardized common language and functional primitives.

This document provides the detailed technical specification for UCP. For a complete definition of all data models and schemas, see the [Schema Reference](https://ucp.dev/draft/specification/reference/index.md).

Its primary goal is to enable:

- **Consumer Surfaces/Platforms:** To discover business capabilities and facilitate purchases.
- **Businesses:** To expose their inventory and retail logic in a standard way without building custom integrations for every platform.
- **Payment & Credential Providers:** To securely exchange tokens and credentials to facilitate transactions.

## High level architecture

## Key Goals of UCP

- **Interoperability:** Bridge the gap between consumer surfaces, businesses, and payment ecosystems.
- **Discovery:** Allow consumer surfaces to dynamically discover what businesses support (e.g., "Do they support guest checkout?", "Do they have loyalty programs?").
- **Security:** Facilitate secure, standards-based (OAuth 2.0, PCI-DSS compliant patterns) exchanges of sensitive user and payment data.
- **Agentic Commerce:** Enable AI agents to act on behalf of users to complete complex tasks like "Find a headset under $100 and buy it."

## Roles & Participants

UCP defines the interactions between four primary distinct actors, each playing a specific role in the commerce lifecycle.

### Platform (Application/Agent)

The platform is the consumer-facing surface (such as an AI agent, mobile app, or social media site) acting on behalf of the User. It orchestrates the commerce journey by discovering businesses and facilitating user intent.

- **Responsibilities:** Discovering businesses capabilities via profiles, initiating checkout sessions, and presenting the UI or conversational interface to the user.
- **Examples:** AI Shopping Assistants, Super Apps, Search Engines.

### Business

The entity selling goods or services. In the UCP model, businesses act as the **Merchant of Record (MoR)**, retaining financial liability and ownership of the order.

- **Responsibilities:** Exposing commerce capabilities (inventory, pricing, tax calculation), fulfilling orders, and processing payments via their chosen PSP.
- **Examples:** Retailers, Airlines, Hotel Chains, Service Providers.

### Credential Provider (CP)

A trusted entity responsible for securely managing and sharing sensitive user data, particularly payment instruments and shipping addresses.

- **Responsibilities:** Authenticating the user, issuing payment tokens (to keep raw card data off the platform), and holding PII securely to minimize compliance scope for other parties.
- **Examples:** Digital Wallets (e.g., Google Wallet, Apple Pay), Identity Providers.

### Payment Service Provider (PSP)

The financial infrastructure provider that processes payments on behalf of businesses.

- **Responsibilities:** Authorizing and capturing transactions, handling settlements, and communicating with card networks. The PSP often interacts directly with tokens provided by the Credential Provider.
- **Examples:** Stripe, Adyen, PayPal, Braintree, Chase Paymentech.

## Core Concepts Summary

UCP revolves around three fundamental constructs that define how entities interact.

- **Capabilities:** Standalone core features that a business supports. These are the "verbs" of the protocol.
  - *Examples:* Checkout, Identity Linking, Order.
- **Extensions:** Optional capabilities that augment another capability via the `extends` field. Extensions appear in `ucp.capabilities[]` alongside core capabilities.
  - *Examples:* Discounts (extends Checkout), AP2 Mandates (extends Checkout).
- **Services:** The lower-level communication layers used to exchange data. UCP is transport-agnostic but defines specific bindings for interoperability.
  - *Examples:* REST API (primary), MCP (Model Context Protocol), A2A (Agent2Agent).
# UCP and AP2

# UCP and AP2

UCP is fully compatible with [Agent Payments Protocol (AP2)](https://ap2-protocol.org/). AP2 serves as the trust layer for agent-led transactions completed on behalf of a user, mandating a secure, verifiable exchange of intents and authorizations between Platforms and businesses. By using Verifiable Digital Credentials (VDCs), AP2 eliminates the need for middleman "trust referees." It allows businesses to receive signed checkout commitments—ensuring the price and terms don't change mid-flow—and allows Platforms to provide cryptographically signed payment authorizations that are mathematically tied to the specific state of the cart.

## Key benefits

- **Binding proof:** Both parties have cryptographic evidence of exactly what was offered and what was agreed upon, ensuring the transaction is final and authentic.
- **Fraud reduction:** Payment mandates are scoped specifically to a checkout hash, preventing "token replay" or amount manipulation.
- **Agentic readiness:** Allows autonomous AI agents to transact on behalf of users with pre-defined, verifiable boundaries.

## Protocol flow

1. **Discovery:** The business publishes their discovery document, declaring support for the AP2 extension.
1. **Session Activation:** When creating or updating a checkout session, the Platform signals the activation of AP2.
1. **Signing (business):** The business responds with a `checkoutSignature` (a detached JWT signing the checkout state) and lists supported verifiable presentation formats (e.g., `sd-jwt`).
1. **Authorization:** Upon user consent, the Platform generates two credentials:
   - **CheckoutMandate:** Contains the hash of the `CheckoutObject`.
   - **PaymentMandate:** An SD-JWT-VC containing the payment authorization.
1. **Completion:** The Platform submits both mandates to the business’ `/complete` endpoint.
1. **Verification:**
   - The business verifies the `CheckoutMandate`.
   - The Payment Processor verifies the `PaymentMandate`.
1. **Confirmation:** If valid, the payment is processed, and the order is confirmed.

**Dependencies:** Checkout capability

[See here for full AP2 mandates extension](https://ucp.dev/draft/specification/ap2-mandates/index.md)

[Learn more about AP2](https://ap2-protocol.org)
# Playground

# UCP Playground

Walk through a complete UCP checkout flow step-by-step. This interactive demo runs entirely in the browser, simulating payloads and validating against real UCP schemas at each stage.

## 1. Platform Profile

Select the capability profile for the Platform. This determines which extensions (e.g., fulfillment, discounts) are negotiated.

### Configuration

Platform Type Standard (Core Only) Advanced (All Extensions)

Supports basic checkout and order retrieval.

Capabilities Copy

Continue →

## 2. Discovery

The Platform fetches `/.well-known/ucp`. The response below is filtered to show the intersection of the Business's capabilities and the Platform's profile.

GET Request

```
GET /.well-known/ucp HTTP/1.1
Host: business.example.com
Accept: application/json
```

Response (Filtered)

← Back Continue →

## 3. Capability Negotiation

Intersection of Platform and Business capabilities. Orphaned extensions are pruned.

Business Capabilities

Resulting Intersection

← Back Continue →

## 4. Create Checkout

The Platform initiates a session. The error response below follows the strict `message.json` schema.

Request Payload

Response

Simulation Scenario:

Missing Buyer Email Missing Shipping Destination Run Request

← Back Next Step →

## 5. Update Checkout

Patch the checkout with missing information to resolve validation errors.

PATCH Request Run Update

Response

← Back Next Step →

## 6. Mint Instrument

Simulate the payment handler flow to acquire a payment credential.

### Select Handler

**Shop Pay**\
com.shopify.shop_pay

**Google Pay**\
com.google.pay

Mint Credential

Minted Instrument

← Back Next Step →

## 7. Complete Checkout

Submit the minted instrument to finalize the transaction and create an order.

Request Finalize

Response (Order Created)

**Success!** Order ID: created.

← Back Next Step →

## 8. Webhook Simulation

Simulate a backend event (e.g., shipping center update) triggering a webhook push to the Agent.

### Trigger Event

This action runs on the Business server and pushes data to the Platform's webhook URL.

Simulate "Shipped" Event

Webhook Payload (POST) Push Notification

```
// Waiting for event trigger...
```

← Back

About this demo

This playground is a simulation running entirely in your browser. It uses mocked logic to demonstrate the UCP protocol flow and isn't intended as a reference for production code. For real-world implementation examples and best practices, please check out our [samples on GitHub](https://github.com/Universal-Commerce-Protocol/samples).
# Roadmap

# Roadmap

This roadmap is meant to provide transparency into our strategic priorities and to align our partners on the critical path toward a fully agentic, global commerce standard. Our goal is to move beyond isolated transactions and build a cohesive, intelligent commerce layer that works across borders and verticals.

**Note:** This roadmap reflects our current direction and intends to guide planning, but it does not constitute a commitment to deliver specific features. Our approach to these challenges may evolve, and initiatives are subject to change, removal, or addition as business priorities shift and we receive community feedback.

## Upcoming roadmap priorities

### Deeper support for the full consumer journey

To move beyond isolated transactions, we are expanding the protocol's scope to tackle key user journeys such as multi-item checkout, loyalty, and lifecycle management, while ensuring the business's brand and logic remain central to all shopping experiences. Key upcoming initiatives include:

- **Product discovery and post-order management:** By facilitating the entire journey, we help businesses maximize lifetime and average order value rather than just processing a single item for checkout.
- **Cart and basket building:** Support for multi-item checkout from a business, complex basket rules (e.g., promotions, tax, shipping), and varied fulfillment logic that reflects how people actually shop.
- **Loyalty & Member benefits:** Capabilities to enable loyalty and member benefits to help users find the best value and businesses achieve a deeper connection with their consumers through account linking.
- **Native cross-sell and upsell modules:** Capabilities for businesses to provide personalized recommendations and upsells based on user context.

### Support for global markets

We are building a scalable ecosystem that is inclusive of all business sizes and geographies, ensuring that "simple and open" means accessible to everyone. We plan to do this through a phased rollout across markets, including India, Indonesia, Latin America, and others. We are adapting the protocol to support broader regional use cases and localized payment interoperability.

## Build with us

The future of commerce cannot be built in a vacuum. We invite businesses, developers, and payment providers to join us in refining these specifications. Your feedback on our early builds helps us shape the standards that will power the next generation of global commerce.

[Become a UCP contributor](https://github.com/Universal-Commerce-Protocol/ucp?tab=contributing-ov-file)
# Specification Overview

# Universal Commerce Protocol (UCP) Official Specification

## Overarching guidelines

The key words **MUST**, **MUST NOT**, **REQUIRED**, **SHALL**, **SHALL NOT**, **SHOULD**, **SHOULD NOT**, **RECOMMENDED**, **MAY**, and **OPTIONAL** in this document are to be interpreted as described in [RFC 2119](https://www.rfc-editor.org/rfc/rfc2119.html) and [RFC 8174](https://www.rfc-editor.org/rfc/rfc8174.html).

Schema notes:

- Date format: Always specified as [RFC 3339](https://www.rfc-editor.org/rfc/rfc3339.html) unless otherwise specified
- Amounts format: Minor units (cents)

## Discovery, Governance, and Negotiation

UCP employs a server-selects architecture where the business (server) chooses the protocol version and capabilities from the intersection of both parties' capabilities. Both business and platform profiles can be cached by both parties, allowing efficient capability negotiation within the normal request/response flow between platform and business.

### Namespace Governance

UCP uses reverse-domain naming to encode governance authority directly into capability identifiers. This eliminates the need for a central registry.

#### Naming Convention

All capability and service names **MUST** use the format:

```text
{reverse-domain}.{service}.{capability}
```

**Components:**

- `{reverse-domain}` - Authority identifier derived from domain ownership
- `{service}` - Service/vertical category (e.g., `shopping`, `common`)
- `{capability}` - The specific capability name

**Examples:**

| Name                                | Authority   | Service  | Capability       |
| ----------------------------------- | ----------- | -------- | ---------------- |
| `dev.ucp.shopping.checkout`         | ucp.dev     | shopping | checkout         |
| `dev.ucp.shopping.fulfillment`      | ucp.dev     | shopping | fulfillment      |
| `dev.ucp.common.identity_linking`   | ucp.dev     | common   | identity_linking |
| `com.example.payments.installments` | example.com | payments | installments     |

#### Spec URL Binding

The `spec` and `schema` fields are **REQUIRED** for all capabilities. The origin of these URLs **MUST** match the namespace authority:

| Namespace       | Required Origin           |
| --------------- | ------------------------- |
| `dev.ucp.*`     | `https://ucp.dev/...`     |
| `com.example.*` | `https://example.com/...` |

Platform **MUST** validate this binding and **SHOULD** reject capabilities where the spec origin does not match the namespace authority.

#### Governance Model

| Namespace Pattern | Authority    | Governance          |
| ----------------- | ------------ | ------------------- |
| `dev.ucp.*`       | ucp.dev      | UCP governing body  |
| `com.{vendor}.*`  | {vendor}.com | Vendor organization |
| `org.{org}.*`     | {org}.org    | Organization        |

The `dev.ucp.*` namespace is reserved for capabilities sanctioned by the UCP governing body. Vendors **MUST** use their own reverse-domain namespace for custom capabilities.

### Services

A **service** defines the API surface for a vertical (shopping, common, etc.). Services include operations, events, and transport bindings defined via standard formats:

- **REST**: OpenAPI 3.x (JSON format)
- **MCP**: OpenRPC (JSON format)
- **A2A**: Agent Card Specification
- **EP(embedded)**: OpenRPC (JSON format)

#### Service Definition

| Field             | Type   | Required | Description                         |
| ----------------- | ------ | -------- | ----------------------------------- |
| `version`         | string | Yes      | Service version (YYYY-MM-DD format) |
| `spec`            | string | Yes      | URL to service documentation        |
| `rest`            | object | No       | REST transport binding              |
| `rest.schema`     | string | Yes      | URL to OpenAPI spec (JSON)          |
| `rest.endpoint`   | string | Yes      | Business's REST endpoint            |
| `mcp`             | object | No       | MCP transport binding               |
| `mcp.schema`      | string | Yes      | URL to OpenRPC spec (JSON)          |
| `mcp.endpoint`    | string | Yes      | Business's MCP endpoint             |
| `a2a`             | object | No       | A2A transport binding               |
| `a2a.endpoint`    | string | Yes      | Business's A2A Agent Card URL       |
| `embedded`        | string | No       | Embedded transport binding          |
| `embedded.schema` | string | Yes      | URL to OpenRPC spec (JSON)          |

Transport definitions **MUST** be thin: they declare method names and reference base schemas only. See [Requirements](#requirements) for details.

#### Endpoint Resolution

The `endpoint` field provides the base URL for API calls. OpenAPI paths are appended to this endpoint to form the complete URL.

**Example:**

```json
{
  "version": "2026-01-11",
  "transport": "rest",
  "schema": "https://ucp.dev/services/shopping/rest.openapi.json",
  "endpoint": "https://business.example.com/api/v2"
}
```

With OpenAPI path `/checkout-sessions`, the resolved URL is:

```text
POST https://business.example.com/api/v2/checkout-sessions
```

**Rules:**

- `endpoint` **MUST** be a valid URL with scheme (https)
- `endpoint` **SHOULD NOT** have a trailing slash
- OpenAPI paths are relative and appended directly to endpoint
- Same resolution applies to MCP endpoints for JSON-RPC calls
- `endpoint` for A2A transport refers to the Agent Card URL for the agent

### Capabilities

A **capability** is a feature within a service. It declares what functionality is supported and where to find documentation and schemas.

#### Capability Definition

**Error:** Definition '#/$defs/discovery' not found in 'source/schemas/capability.json'

#### Extensions

An **extension** is an optional module that augments another capability. Extensions use the `extends` field to declare their parent(s):

```json
{
  "dev.ucp.shopping.fulfillment": [
    {
      "version": "2026-01-23",
      "spec": "https://ucp.dev/2026-01-23/specification/fulfillment",
      "schema": "https://ucp.dev/2026-01-23/schemas/shopping/fulfillment.json",
      "extends": "dev.ucp.shopping.checkout"
    }
  ]
}
```

##### Multi-Parent Extensions

Extensions **MAY** extend multiple parent capabilities by using an array:

```json
{
  "dev.ucp.shopping.discount": [
    {
      "version": "2026-01-23",
      "spec": "https://ucp.dev/2026-01-23/specification/discount",
      "schema": "https://ucp.dev/2026-01-23/schemas/shopping/discount.json",
      "extends": ["dev.ucp.shopping.checkout", "dev.ucp.shopping.cart"]
    }
  ]
}
```

When an extension declares multiple parents:

- The extension **MAY** define different fields for each capability it extends (e.g., `loyalty_earned` for checkout, `loyalty_preview` for cart)
- See [Intersection Algorithm](#intersection-algorithm) for negotiation rules

Extensions can be:

- **Official**: `dev.ucp.shopping.fulfillment` extends `dev.ucp.shopping.checkout`
- **Vendor**: `com.example.installments` extends `dev.ucp.shopping.checkout`

### Schema Composition

Extensions can add new fields and modify shared structures (e.g., discounts modify `totals`, fulfillment adds fulfillment to `totals.type`).

#### Requirements

- Transport definitions (OpenAPI/OpenRPC) **MUST** reference base schemas only. They **MUST NOT** enumerate fields or define payload shapes inline.
- Extensions **MUST** be self-describing. Each extension schema **MUST** declare the types it introduces and how it modifies base types using `allOf` composition.
- Platforms **MUST** resolve schemas client-side by fetching and composing base schemas with active extension schemas.

#### Extension Schema Pattern

Extension schemas define composed types using `allOf`. The `$defs` key **MUST** use the full parent capability name (reverse-domain format) to enable deterministic schema resolution:

```json
{
  "$defs": {
    "discounts_object": { ... },
    "dev.ucp.shopping.checkout": {
      "title": "Checkout with Discount",
      "allOf": [
        {"$ref": "checkout.json"},
        {
          "type": "object",
          "properties": {
            "discounts": {
              "$ref": "#/$defs/discounts_object"
            }
          }
        }
      ]
    }
  }
}
```

**Requirements:**

- Extension schemas **MUST** have a `$defs` entry for each parent declared in `extends`
- The `$defs` key **MUST** match the parent's full capability name exactly

This convention ensures:

- **Self-documenting**: The schema declares exactly which parents it extends
- **Deterministic resolution**: The `extends` value maps directly to the `$defs` key
- **Verifiable**: Build-time checks can confirm each `extends` entry has a matching `$defs` key

#### Schema Resolution Convention

To validate payloads, implementations resolve extension schemas as follows:

1. Determine the root capability from the operation (e.g., checkout operations use `dev.ucp.shopping.checkout`)
1. For each active extension, resolve and apply its `$defs[{root_capability}]`

**Example:** A checkout response includes the discount extension.

- Root capability: `dev.ucp.shopping.checkout`
- Extension schema: `discount.json`
- Resolve: `discount.json#/$defs/dev.ucp.shopping.checkout`

#### Resolution Flow

Platforms **MUST** resolve schemas following this sequence:

1. **Discovery**: Fetch business profile from `/.well-known/ucp`
1. **Negotiation**: Compute capability intersection (see [Intersection Algorithm](#intersection-algorithm))
1. **Schema Fetch**: Fetch base schema and all active extension schemas
1. **Compose**: Merge schemas via `allOf` chains based on active extensions
1. **Validate**: Validate requests and responses against the composed schema

### Profile Structure

#### Business Profile

Businesses publish their profile at `/.well-known/ucp`. An example:

```json
{
  "ucp": {
    "version": "2026-01-11",
    "services": {
      "dev.ucp.shopping": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/overview",
          "transport": "rest",
          "endpoint": "https://business.example.com/ucp/v1",
          "schema": "https://ucp.dev/services/shopping/rest.openapi.json"
        },
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/overview",
          "transport": "mcp",
          "endpoint": "https://business.example.com/ucp/mcp",
          "schema": "https://ucp.dev/services/shopping/mcp.openrpc.json"
        },
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/overview",
          "transport": "a2a",
          "endpoint": "https://business.example.com/.well-known/agent-card.json"
        },
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/overview",
          "transport": "embedded",
          "schema": "https://ucp.dev/services/shopping/embedded.openrpc.json"
        }
      ]
    },
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/checkout",
          "schema": "https://ucp.dev/schemas/shopping/checkout.json"
        }
      ],
      "dev.ucp.shopping.fulfillment": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/fulfillment",
          "schema": "https://ucp.dev/schemas/shopping/fulfillment.json",
          "extends": "dev.ucp.shopping.checkout"
        }
      ],
      "dev.ucp.shopping.discount": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/discount",
          "schema": "https://ucp.dev/schemas/shopping/discount.json",
          "extends": "dev.ucp.shopping.checkout"
        }
      ]
    },
    "payment_handlers": {
      "com.example.processor_tokenizer": [
        {
          "id": "processor_tokenizer",
          "version": "2026-01-11",
          "spec": "https://example.com/specs/payments/processor_tokenizer",
          "schema": "https://example.com/specs/payments/merchant_tokenizer.json",
          "config": {
            "type": "CARD",
            "tokenization_specification": {
              "type": "PUSH",
              "parameters": {
                "token_retrieval_url": "https://api.psp.example.com/v1/tokens"
              }
            }
          }
        }
      ]
    }
  },
  "signing_keys": [
    {
      "kid": "business_2025",
      "kty": "EC",
      "crv": "P-256",
      "x": "WbbXwVYGdJoP4Xm3qCkGvBRcRvKtEfXDbWvPzpPS8LA",
      "y": "sP4jHHxYqC89HBo8TjrtVOAGHfJDflYxw7MFMxuFMPY",
      "use": "sig",
      "alg": "ES256"
    }
  ]
}
```

The `ucp` object contains protocol metadata: version, services, capabilities, and payment handlers. The `signing_keys` array contains public keys (JWK format) used to verify signatures on webhooks and other authenticated messages from the business.

#### Platform Profile

Platform profiles are similar and include signing keys for capabilities requiring cryptographic verification. Capabilities **MAY** include a `config` object for capability-specific settings (e.g., callback URLs, feature flags). An example:

```json
{
  "ucp": {
    "version": "2026-01-11",
    "services": {
      "dev.ucp.shopping": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/overview",
          "transport": "rest",
          "schema": "https://ucp.dev/services/shopping/rest.openapi.json"
        }
      ]
    },
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/checkout",
          "schema": "https://ucp.dev/schemas/shopping/checkout.json"
        }
      ],
      "dev.ucp.shopping.fulfillment": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/fulfillment",
          "schema": "https://ucp.dev/schemas/shopping/fulfillment.json",
          "extends": "dev.ucp.shopping.checkout"
        }
      ],
      "dev.ucp.shopping.order": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/order",
          "schema": "https://ucp.dev/schemas/shopping/order.json",
          "config": {
            "webhook_url": "https://platform.example.com/webhooks/ucp/orders"
          }
        }
      ]
    },
    "payment_handlers": {
      "com.google.pay": [
        {
          "id": "gpay_1234",
          "version": "2024-12-03",
          "spec": "https://developers.google.com/merchant/ucp/guides/gpay-payment-handler",
          "schema": "https://pay.google.com/gp/p/ucp/2026-01-11/schemas/gpay_config.json"
        }
      ],
      "dev.shopify.shop_pay": [
        {
          "id": "shop_pay_1234",
          "version": "2026-01-11",
          "spec": "https://shopify.dev/ucp/shop-pay-handler",
          "schema": "https://shopify.dev/ucp/schemas/shop-pay-config.json"
        }
      ],
      "dev.ucp.processor_tokenizer": [
        {
          "id": "processor_tokenizer",
          "version": "2026-01-11",
          "spec": "https://example.com/specs/payments/processor_tokenizer-payment",
          "schema": "https://ucp.dev/schemas/payments/delegate-payment.json"
        }
      ]
    }
  },
  "signing_keys": [
    {
      "kid": "platform_2025",
      "kty": "EC",
      "crv": "P-256",
      "x": "MKBCTNIcKUSDii11ySs3526iDZ8AiTo7Tu6KPAqv7D4",
      "y": "4Etl6SRW2YiLUrN5vfvVHuhp7x8PxltmWWlbbM4IFyM",
      "use": "sig",
      "alg": "ES256"
    }
  ]
}
```

### Platform Advertisement on Request

Platforms **MUST** communicate their profile URI with each request to enable capability negotiation.

**HTTP Transport:** Platforms **MUST** use Dictionary Structured Field syntax ([RFC 8941](https://datatracker.ietf.org/doc/html/rfc8941)) in the UCP-Agent header:

```text
POST /checkout HTTP/1.1
UCP-Agent: profile="https://agent.example/profiles/shopping-agent.json"
Content-Type: application/json

{"line_items": [...]}
```

**MCP Transport:** Platforms **MUST** include a `meta` object containing request metadata:

```json
{
  "jsonrpc": "2.0",
  "method": "create_checkout",
  "params": {
    "meta": {
      "ucp-agent": {
        "profile": "https://agent.example/profiles/shopping-agent.json"
      },
      "idempotency-key": "550e8400-e29b-41d4-a716-446655440000"
    },
    "checkout": {
      "line_items": [...]
    }
  },
  "id": 1
}
```

### Negotiation Protocol

#### Platform Requirements

1. **Profile Advertisement**: Platforms **MUST** include their profile URI in every request using the transport-appropriate mechanism.
1. **Discovery**: Platforms **MAY** fetch the business profile from `/.well-known/ucp` before initiating requests. If fetched, platforms **SHOULD** cache the profile according to HTTP cache-control directives.
1. **Namespace Validation**: Platforms **MUST** validate that capability `spec` URI origins match namespace authorities.
1. **Schema Resolution**: Platforms **MUST** fetch and compose schemas for negotiated capabilities before making requests.

#### Business Requirements

1. **Profile Resolution**: Upon receiving a request with a platform profile URI, businesses **MUST** fetch and validate the platform profile unless already cached.
1. **Capability Intersection**: Businesses **MUST** compute the intersection of platform and business capabilities.
1. **Extension Validation**: Extensions without their parent capability in the intersection **MUST** be excluded.
1. **Response Requirements**: Businesses **MUST** include the `ucp` field in every response containing:
   - `version`: The UCP version used to process the request
   - `capabilities`: Array of active capabilities for this response

#### Intersection Algorithm

The capability intersection algorithm determines which capabilities are active for a session:

1. **Compute intersection**: For each business capability, include it in the result if a platform capability with the same `name` exists.

1. **Prune orphaned extensions**: Remove any capability where `extends` is set but **none** of its parent capabilities are in the intersection.

   - For single-parent extensions (`extends: "string"`): parent must be present
   - For multi-parent extensions (`extends: ["a", "b"]`): at least one parent must be present

1. **Repeat pruning**: Continue step 2 until no more capabilities are removed (handles transitive extension chains).

The result is the set of capabilities both parties support, with extension dependencies satisfied.

#### Error Handling

UCP negotiation can fail in two ways:

1. **Discovery failure**: The business cannot fetch or parse the platform's profile.
1. **Negotiation failure**: The provided profile is valid but capability intersection is empty or versions are incompatible.

These failure types require different handling:

- **Discovery failure** → transport error with optional `continue_url`
- **Negotiation failure** → UCP response with optional `continue_url`

##### Error Codes

| Code                        | Description                                          | REST | MCP    |
| --------------------------- | ---------------------------------------------------- | ---- | ------ |
| `INVALID_PROFILE_URL`       | Profile URL is malformed, missing, or unresolvable   | 400  | error  |
| `PROFILE_UNREACHABLE`       | Resolved URL but fetch failed (timeout, non-2xx)     | 424  | error  |
| `PROFILE_MALFORMED`         | Fetched content is not valid JSON or violates schema | 422  | error  |
| `CAPABILITIES_INCOMPATIBLE` | No compatible capabilities in intersection           | 200  | result |
| `VERSION_UNSUPPORTED`       | Platform's UCP version is not supported              | 200  | result |

##### The `continue_url` Field

When UCP negotiation fails, `continue_url` provides a fallback web experience. Businesses **SHOULD** provide the most contextually relevant URL:

- For checkout operations: link to the cart or checkout page
- For catalog operations: link to the product or search results
- As a fallback: link to the storefront homepage

This enables graceful degradation—agents can redirect buyers to complete their task through the standard web interface.

##### Transport Bindings

**Discovery Failure (424):**

```http
HTTP/1.1 424 Failed Dependency
Content-Type: application/json

{
  "code": "PROFILE_UNREACHABLE",
  "content": "Unable to fetch agent profile: connection timeout",
  "continue_url": "https://merchant.com/cart"
}
```

**Negotiation Failure (200):**

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {}
  },
  "messages": [
    {
      "type": "error",
      "code": "VERSION_UNSUPPORTED",
      "content": "Platform UCP version 2024-01-01 is not supported",
      "severity": "requires_buyer_input"
    }
  ],
  "continue_url": "https://merchant.com/cart"
}
```

**Discovery Failure (JSON-RPC error):**

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32001,
    "message": "UCP discovery failed",
    "data": {
      "code": "PROFILE_UNREACHABLE",
      "content": "Unable to fetch agent profile: connection timeout",
      "continue_url": "https://merchant.com/cart"
    }
  }
}
```

**Negotiation Failure (JSON-RPC result):**

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-11",
      "capabilities": {}
    },
    "messages": [
      {
        "type": "error",
        "code": "VERSION_UNSUPPORTED",
        "content": "Platform UCP version 2024-01-01 is not supported",
        "severity": "requires_buyer_input"
      }
    ],
    "continue_url": "https://merchant.com/cart"
  }
}
```

#### Capability Declaration in Responses

The `capabilities` registry in responses indicates active capabilities:

```json
{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ],
      "dev.ucp.shopping.fulfillment": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.example.processor_tokenizer": [
        {"id": "processor_tokenizer", "version": "2026-01-11"}
      ]
    }
  },
  "id": "checkout_123",
  "line_items": [...]
  ... other fields
}
```

#### Response Capability Selection

Businesses **MUST** include in `ucp.capabilities` only the capabilities that are:

1. In the negotiated intersection for this session, AND
1. Relevant to this response's operation type

**Root Capability Relevance:**

A root capability is relevant if it matches the operation type:

- `create_checkout` / `update_checkout` / `complete_checkout` → `dev.ucp.shopping.checkout`
- `create_cart` / `update_cart` → `dev.ucp.shopping.cart`
- Order webhooks → `dev.ucp.shopping.order`

**Extension Relevance:**

An extension is relevant if **any** of its `extends` values matches a relevant root capability.

**Selection Examples:**

| Response Type | Includes                        | Does NOT Include             |
| ------------- | ------------------------------- | ---------------------------- |
| Checkout      | checkout, discount, fulfillment | cart, order                  |
| Cart          | cart, discount                  | checkout, fulfillment, order |
| Order         | order                           | checkout, cart, discount     |

## Payment Architecture

UCP adopts a decoupled architecture for payments to solve the "N-to-N" complexity problem between **platforms**, **businesses**, and **payment credential providers**. This design separates **Payment Instruments** (what is accepted) from **Payment Handlers** (the specifications for how instruments are processed), ensuring security and scalability.

### Security and Trust Model

The payment architecture is built on a "Trust-by-Design" philosophy. It assumes that while the business and payment credential provider have a trusted legal relationship, the platform (Client) acts as an intermediary that **SHOULD NOT** touch raw financial credentials.

#### The Trust Triangle

1. **Business ↔ Payment Credential Provider:** A pre-existing legal and technical relationship. The business holds API keys and a contract with the payment credential provider.
1. **Platform ↔ Payment Credential Provider:** The platform interacts with the payment credential provider's interface (e.g., an iframe or API) to tokenize data but is not the "owner" of the funds.
1. **Platform ↔ Business:** The platform passes the result (a token or mandate) to the business to finalize the order.

#### Enhanced Security for Autonomous Commerce

For scenarios requiring cryptographic proof of user authorization (e.g., autonomous AI agents), UCP supports the **AP2 Mandates Extension** (`dev.ucp.shopping.ap2_mandate`). This optional extension provides non-repudiable authorization through verifiable digital credentials.

See [Transaction Integrity](#transaction-integrity-and-non-repudiation) and [AP2 Mandates Extension](https://ucp.dev/draft/specification/ap2-mandates/index.md) for details on when and how to use this extension.

#### Credential Flow & PCI Scope

To minimize compliance overhead (PCI-DSS):

1. **Unidirectional Flow:** Credentials flow **Platform → Business** only. Businesses **MUST NOT** echo credentials back in responses.
1. **Opaque Credentials:** Platforms handle tokens (such as network tokens), encrypted payloads, or mandates, not raw PANs.
1. **Handler ID Routing:** The `handler_id` in the payload ensures the business knows exactly which payment credential provider key to use for decryption/charging, preventing key confusion attacks.

### Roles & Responsibilities: Who Implements What?

A common source of confusion is the division of labor. The UCP payment model splits responsibilities as follows:

| Role                            | Responsibility             | Action                                                                                                                                                                                                                                                              |
| ------------------------------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Payment Credential Provider** | **Defines the Spec**       | Creates the **Handler Definition**. They publish the "Blueprint" (JSON Schemas) that dictates how to tokenize a card and what config inputs are needed. *Example: "Here is the schema for the 'com.psp-x.tokenization' handler."*                                   |
| **Business**                    | **Configures the Handler** | Selects the Handler they want to use and provides their specific **Configuration** (Public Keys, Merchant IDs) in the UCP Checkout Response. *Example: "I accept Visa using 'com.psp-x.tokenization' with this Publishable Key."*                                   |
| **Platform**                    | **Executes the Protocol**  | Reads the business's config and executes the logic defined by the payment credential provider's Spec to acquire a token. *Example: "I see the Business uses a payment credential provider. I will call the provider's SDK with the Business's Key to get a token."* |

### Payment in the Checkout Lifecycle

When payment is required, the payment process follows a standard 3-step lifecycle within UCP: **Negotiation**, **Acquisition**, and **Completion**.

1. **Negotiation (Business → Platform):** The business advertises available payment handlers in their UCP profile. This tells the platform *how* to pay (e.g., "Use this specific payment credential provider endpoint with this public key").
1. **Acquisition (Platform ↔ Payment Credential Provider):** The platform executes the handler's logic. This happens client-side or agent-side, directly with the payment credential provider (e.g., exchanging credentials for a network token). The business is not involved, ensuring raw data never touches the business's frontend API.
1. **Completion (Platform → Business):** The platform submits the opaque credential (token) to the business. The business uses it to capture funds via their backend integration with the payment credential provider.

### Payment Handlers

Payment Handlers are **specifications** (not entities) that define how payment instruments are processed. They are the contract that binds the three participants together.

**Important distinction:**

- **Payment Credential Provider** = The participant (entity like Google Pay, Shop Pay)
- **Payment Handler** = The specification the provider authors (e.g., `com.google.pay`, `dev.shopify.shop_pay`)

Payment handlers allow for a variety of different payment instruments and token-types to be supported, including network tokens. They are standardized definitions typically authored by payment credential providers or the UCP governing body.

**Dynamic Filtering:** Businesses **MUST** filter the `handlers` list based on the context of the cart (e.g., removing "Buy Now Pay Later" for subscription items, or filtering regional methods based on shipping address).

### Risk Signals

To aid in fraud assessment, the Platform **MAY** include additional risk signals in the `complete` call, providing the Business with more context about the transaction's legitimacy. The structure and content of these risk signals are not strictly defined by this specification, allowing flexibility based on the agreement between the Platform and Business or specific payment handler requirements.

**Example (Flexible Structure):**

```json
{
  "risk_signals": {
    "session_id": "abc_123_xyz",
    "score": 0.95,
  }
}
```

### Implementation Scenarios

The following scenarios illustrate how different payment handlers and instruments are negotiated and executed using concrete data examples.

#### Scenario A: Digital Wallet

In this scenario, the platform identifies a payment credential provider (e.g., `com.google.pay`, `dev.shopify.shop_pay`) and uses their API to acquire an encrypted payment token.

##### 1. Business Advertisement (Response from Create Checkout)

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "com.google.pay": [
        {
          "id": "8c9202bd-63cc-4241-8d24-d57ce69ea31c",
          "version": "2026-01-11",
          "config": {
            "api_version": 2,
            "api_version_minor": 0,
            "environment": "TEST",
            "merchant_info": {
              "merchant_name": "Example Merchant",
              "merchant_id": "01234567890123456789",
              "merchant_origin": "checkout.merchant.com"
            },
            "allowed_payment_methods": [
              {
                "type": "CARD",
                "parameters": {
                  "allowed_auth_methods": ["PAN_ONLY"],
                  "allowed_card_networks": ["VISA", "MASTERCARD"]
                },
                "tokenization_specification": {
                  "type": "PAYMENT_GATEWAY",
                  "parameters": {
                    "gateway": "example",
                    "gatewayMerchantId": "exampleGatewayMerchantId"
                  }
                }
              }
            ]
          }
        }
      ],
      "dev.shopify.shop_pay": [
        {
          "id": "shop_pay_1234",
          "version": "2026-01-11",
          "config": {
            "shop_id": "shopify-559128571",
            "environment": "production"
          }
        }
      ]
    }
  }
}
```

##### 2. Token Execution (Platform Side)

The platform recognizes `com.google.pay` or `dev.shopify.shop_pay`. It passes the `config` into the respective handler API. The handler returns the encrypted token data.

##### 3. Complete Checkout (Request to Business)

The Platform wraps the payment handler response into a payment instrument.

```json
POST /checkout-sessions/{id}/complete

{
  "payment": {
    "instruments": [
      {
        "id": "pm_1234567890abc",
        "handler_id": "8c9202bd-63cc-4241-8d24-d57ce69ea31c",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "visa",
          "last_digits": "4242"
        },
        "billing_address": {
          "street_address": "123 Main Street",
          "extended_address": "Suite 400",
          "address_locality": "Charleston",
          "address_region": "SC",
          "postal_code": "29401",
          "address_country": "US",
          "first_name": "Jane",
          "last_name": "Smith"
        },
        "credential": {
          "type": "PAYMENT_GATEWAY",
          "token": "{\"signature\":\"...\",\"protocolVersion\":\"ECv2\"...}"
        }
      }
    ]
  },
  "risk_signals": {
      // ...
  }
}
```

#### Scenario B: Direct Tokenization with Challenge (SCA)

In this scenario, the platform uses a generic tokenizer to request a session token or network tokens. The bank requires Strong Customer Authentication (SCA/3DS), forcing the business to pause completion and request a challenge.

##### 1. Business Advertisement

```json
{
  "ucp": {
    "payment_handlers": {
      "com.example.tokenizer": [
        {
          "id": "merchant_tokenizer",
          "version": "2026-01-11",
          "spec": "https://example.com/specs/tokenizer",
          "schema": "https://example.com/schemas/tokenizer.json",
          "config": {
            "token_url": "https://api.psp.com/tokens",
            "public_key": "pk_123"
          }
        }
      ]
    }
  }
}
```

##### 2. Token Execution (Platform Side)

The platform calls `https://api.psp.com/tokens` which identity **SHOULD** have previous legal binding connection with them and receives `tok_visa_123` (which could represent a vaulted card or network token).

##### 3. Complete Checkout (Request to Business)

```json
POST /checkout-sessions/{id}/complete

{
  "payment": {
    "instruments": [
      {
        "handler_id": "merchant_tokenizer",
        // ... more instrument required field
        "credential": { "token": "tok_visa_123" }
      }
    ]
  },
  "risk_signals": {
    // ... host could send risk_signals here
  }
}
```

##### 4. Challenge Required (Response from Business)

The business attempts the charge, but the PSP returns a "Soft Decline" requiring 3DS.

```json
HTTP/1.1 200 OK
{
  "status": "requires_escalation",
  "messages": [{
    "type": "error",
    "code": "requires_3ds",
    "content": "bank requires verification.",
    "severity": "requires_buyer_input"
  }],
  "continue_url": "https://psp.com/challenge/123"
}
```

*The platform* *MUST* *now open `continue_url` in a WebView/Window for the user to complete the bank check, then retry the completion.*

#### Scenario C: Autonomous Agent (AP2)

This scenario demonstrates the **Recommended Flow for Agents**. Instead of a session token, the agent generates cryptographic mandates.

##### 1. Business Advertisement

```json
{
  "ucp": {
    "payment_handlers": {
      "dev.ucp.ap2_mandate_compatible_handlers": [
        {
          "id": "ap2_234352",
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specs/ap2-handler",
          "schema": "https://ucp.dev/schemas/ap2-handler.json"
        }
      ]
    }
  }
}
```

##### 2. Agent Execution

The agent cryptographically signs objects using the user's private key on a non-agentic surface.

##### 3. Complete Checkout

```json
POST /checkout-sessions/{id}/complete

{
  "payment": {
    "instruments": [
      {
        "handler_id": "ap2_234352",
        // other required instruments fields
        "credential": {
          "type": "card",
          "token": "eyJhbGciOiJ...", // Token would contain payment_mandate, the signed proof of funds auth
        }
      }
    ]
  },
  "risk_signals": {
    "session_id": "abc_123_xyz",
    "score": 0.95
  },
  "ap2": {
    "checkout_mandate": "eyJhbGciOiJ...", // Signed proof of checkout terms
  }
}
```

*This provides the business with non-repudiable proof that the user authorized this specific transaction, enabling safe autonomous processing.*

### PCI-DSS Scope Management

#### Platform Scope

Most platform implementations can **avoid PCI-DSS scope** by:

- Using handlers that provide opaque credentials (encrypted data, token references, etc.)
- Never accessing or storing raw payment data (card numbers, CVV, etc.)
- Forwarding credentials without the ability to use them directly
- Using PSP tokenization payment handlers where raw credentials never pass through the platform

#### Business Scope

Businesses can minimize PCI scope by:

- Using payment credential provider-hosted tokenization (provider stores credentials, business receives token reference)
- Using wallet providers that provide encrypted credentials (Google Pay, Shop Pay)
- Never logging raw credentials
- Delegating credential processing to PCI-certified payment credential providers

#### Payment Credential Provider Scope

Payment credential providers (PSPs, wallets) are typically PCI-DSS Level 1 certified and handle:

- Raw credential collection
- Credential protection (tokenization, encryption, secure storage)
- Credential validation and processing
- PCI-compliant infrastructure

### Security Best Practices

**For Businesses:**

1. Validate handler_id before processing (ensure handler is in advertised set)
1. Use separate PSP credentials for TEST vs PRODUCTION environments
1. Implement idempotency for payment processing (prevent double-charges)
1. Log payment events without logging credentials
1. Set appropriate credential timeouts
1. For autonomous commerce scenarios requiring cryptographic proof, consider supporting the `dev.ucp.shopping.ap2_mandate` extension (see [AP2 Mandates Extension](https://ucp.dev/draft/specification/ap2-mandates/index.md))

**For Platforms:**

1. Always use HTTPS for checkout API calls
1. Validate handler configurations before executing protocols
1. Implement timeout handling for credential acquisition
1. Clear credentials from memory after submission
1. Handle credential expiration gracefully (re-acquire if needed)
1. For autonomous agents, consider using the `dev.ucp.shopping.ap2_mandate` extension for cryptographic proof of authorization (see [AP2 Mandates Extension](https://ucp.dev/draft/specification/ap2-mandates/index.md))

**For Payment Credential Providers:**

1. Secure credentials for the specific business (encryption, tokenization, or other handler-specific methods)
1. Implement rate limiting on credential acquisition
1. Validate platform authorization before providing credentials
1. Set reasonable credential expiration (e.g., 15 minutes for tokens, time- limited encrypted payloads)
1. Ensure credentials cannot be used by platforms directly (only by the intended business)

### Fraud Prevention Integration

While UCP does not define fraud prevention APIs, the payment architecture supports fraud signal integration:

- Businesses can require additional fields in handler configurations (e.g., 3DS requirements)
- Platforms can submit device fingerprints and session data alongside credentials
- Payment credential providers can perform risk assessment during credential acquisition
- Businesses can reject high-risk transactions and request additional verification

Future extensions **MAY** standardize fraud signal schemas, but the current architecture allows flexible integration with existing fraud prevention systems.

### Payment Architecture Extensions

The core payment architecture described above can be extended for specialized use cases:

- **AP2 Mandates Extension** (`dev.ucp.shopping.ap2_mandate`): Adds cryptographic proof of user authorization for autonomous commerce scenarios where non-repudiable evidence is required. See [AP2 Mandates Extension](https://ucp.dev/draft/specification/ap2-mandates/index.md).
- **Custom Handler Types**: Payment credential providers can define custom handlers to support new payment instruments. See [Payment Handler Guide](https://ucp.dev/draft/specification/payment-handler-guide/index.md) for details.

The extension model ensures the core architecture remains simple while supporting advanced security and compliance requirements when needed.

## Transport Layer

UCP supports multiple transport protocols. Platforms and businesses effectively negotiate the transport via `services` on their profiles.

### REST Transport (Core)

The primary transport for UCP is **HTTP/1.1** (or higher) using RESTful patterns.

- **Content-Type:** Requests and responses **MUST** use `application/json`.
- **Methods:** Implementations **MUST** use standard HTTP verbs (e.g., `POST` for creation, `GET` for retrieval).
- **Status Codes:** Implementations **MUST** use standard HTTP status codes (e.g., 200, 201, 400, 401, 500).

### Model Context Protocol (MCP)

UCP capabilities map 1:1 to MCP tools. A business **MAY** expose an MCP server that wraps their UCP implementation, allowing LLMs to call tools like `create_checkout` directly.

### Agent-to-Agent Protocol (A2A)

A business **MAY** expose an A2A agent that supports UCP as an A2A Extension, allowing integration with platforms over structured UCP data types.

### Embedded Protocol (EP)

A business **MAY** embed an interface onto an eligible host that would receive events as the user interacts with the interface and delegate key user actions.

Initiation comes through a `continue_url` that is returned by the business.

## Standard Capabilities

UCP defines a set of standard capabilities:

| Capability Name      | ID (URI)                                         | Description                                                                                                  |
| -------------------- | ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------ |
| **Checkout**         | `https://ucp.dev/schemas/shopping/checkout.json` | Facilitates the creation and management of checkout sessions, including cart management and tax calculation. |
| **Identity Linking** | -                                                | Enables platforms to obtain authorization via OAuth 2.0 to perform actions on a user's behalf.               |
| **Order**            | `https://ucp.dev/schemas/shopping/order.json`    | Allows businesses to push asynchronous updates about an order's lifecycle (shipping, delivery, returns).     |

### Definition & Extensions

Detailed definitions for endpoints, schemas, and valid extensions for each capability are provided in their respective specification files. Extensions are typically versioned and defined alongside their parent capability.

## Security & Authentication

### Transport Security

All UCP communication **MUST** occur over **HTTPS**.

### Request Authentication

- **Platform to Business:** Requests **SHOULD** be authenticated using standard headers (e.g., `Authorization: Bearer <token>`).
- **Business to Platform (Webhooks):** Webhooks **MUST** be signed using a shared secret or asymmetric key to verify integrity and origin.

### Data Privacy

Sensitive data (such as Payment Credentials or PII) **MUST** be handled according to PCI-DSS and GDPR guidelines. UCP encourages the use of tokenized payment data to minimize business and platform liability.

### Transaction Integrity and Non-Repudiation

For scenarios requiring cryptographic proof of authorization (e.g., autonomous agents, high-value transactions), UCP supports the **AP2 Mandates Extension** (`dev.ucp.shopping.ap2_mandate`). When this optional extension is negotiated:

- Businesses provide a cryptographic signature on checkout terms
- Platforms provide cryptographic mandates proving user authorization

This mechanism provides strong, end-to-end cryptographic assurances about transaction details and participant consent, significantly reducing risks of tampering and disputes.

See [AP2 Mandates Extension](https://ucp.dev/draft/specification/ap2-mandates/index.md) for complete specification, implementation guide, and examples.

## Versioning

### Version Format

UCP uses date-based versioning in the format `YYYY-MM-DD`. This provides clear chronological ordering and unambiguous version comparison.

### Version Discovery and Negotiation

UCP prioritizes strong backwards compatibility. Businesses implementing a version **SHOULD** handle requests from platforms using that version or older.

Both businesses and platforms declare a single version in their profiles:

#### Example

```json
{
  "ucp": {
    "version": "2026-01-11",
    "services": { ... },
    "capabilities": { ... },
    "payment_handlers": { ... }
  }
}
```

```json
{
  "ucp": {
    "version": "2026-01-11",
    "services": { ... },
    "capabilities": { ... },
    "payment_handlers": { ... }
  }
}
```

### Version Negotiation

Businesses **MUST** validate the platform's version and determine compatibility:

1. Platform declares version via profile referenced in request
1. Business validates:
   - If platform version ≤ business version: Business **MUST** process the request
   - If platform version > business version: Business **MUST** return `version_unsupported` error
1. Businesses **MUST** include the version used for processing in every response.

Response with version confirmation:

```json
{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": { ... },
    "payment_handlers": { ... }
  },
  "id": "checkout_123",
  "status": "incomplete"
  ...other checkout fields
}
```

Version unsupported error:

```json
{
  "status": "requires_escalation",
  "messages": [{
    "type": "error",
    "code": "version_unsupported",
    "content": "Version 2026-01-12 is not supported. This business implements version 2026-01-11.",
    "severity": "requires_buyer_input"
  }]
}
```

### Backwards Compatibility

#### Backwards-Compatible Changes

The following changes **MAY** be introduced without a new version:

- Adding new non-required fields to responses
- Adding new non-required parameters to requests
- Adding new endpoints, methods, or operations to a transport
- Adding new error codes with existing error structures
- Adding new values to enums (unless explicitly documented as exhaustive)
- Changing the order of fields in responses
- Changing the length or format of opaque strings (IDs, tokens)

#### Breaking Changes

The following changes **MUST NOT** be introduced without a new version:

- Removing or renaming existing fields
- Changing field types or semantics
- Making non-required fields required
- Removing operations, methods, or endpoints
- Changing authentication or authorization requirements
- Modifying existing protocol flow or state machine
- Changing the meaning of existing error codes

### Independent Component Versioning

- UCP protocol versions independently from capabilities.
- Each capability versions independently from other capabilities.
- Capabilities **MUST** follow the same backwards compatibility rules as the protocol.
- Businesses **MUST** validate capability version compatibility using the same logic as what's described above.
- Transports **MAY** define their own version handling mechanisms.

#### UCP Capabilities (`dev.ucp.*`)

UCP-authored capabilities version with protocol releases by default. Individual capabilities **MAY** version independently when breaking changes are required outside the protocol release cycle.

#### Vendor Capabilities (`com.{vendor}.*`)

Capabilities outside the `dev.ucp.*` namespace version fully independently. Vendors control their own release schedules and versioning strategy.

## Glossary

| Term                              | Acronym | Definition                                                                                                                                                |
| --------------------------------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Agent Payments Protocol**       | AP2     | An open protocol designed to enable AI agents to securely interoperate and complete payments autonomously. UCP leverages AP2 for secure payment mandates. |
| **Agent2Agent Protocol**          | A2A     | An open standard for secure, collaborative communication between diverse AI agents. UCP can use A2A as a transport layer.                                 |
| **Capability**                    | -       | A standalone core feature that a business supports (e.g., Checkout, Identity Linking). Capabilities are the fundamental "verbs" of UCP.                   |
| **Credential Provider**           | CP      | A trusted entity (like a digital wallet) responsible for securely managing and executing the user's payment and identity credentials.                     |
| **Extension**                     | -       | An optional capability that augments another capability via the `extends` field. Extensions appear in `ucp.capabilities[]` alongside core capabilities.   |
| **Profile**                       | -       | A JSON document hosted by businesses and platforms at a well-known URI, declaring their identity, supported capabilities, and endpoints.                  |
| **Business**                      | -       | The entity selling goods or services. In UCP, they act as the **Merchant of Record (MoR)**, retaining financial liability and ownership of the order.     |
| **Model Context Protocol**        | MCP     | A protocol standardizing how AI models connect to external data and tools. UCP capabilities map 1:1 to MCP tools.                                         |
| **Universal Commerce Protocol**   | UCP     | The standard defined in this document, enabling interoperability between commerce entities via standardized capabilities and discovery.                   |
| **Payment Service Provider**      | PSP     | The financial infrastructure provider that processes payments, authorizations, and settlements on behalf of the business.                                 |
| **Platform**                      | -       | The consumer-facing surface (AI agent, app, website) acting on behalf of the user to discover businesses and facilitate commerce.                         |
| **Verifiable Digital Credential** | VDC     | An Issuer-signed credential (set of claims) whose authenticity can be verified cryptographically. Used in UCP for secure payment authorizations.          |
# Checkout Capability

# Checkout Capability

- **Capability Name:** `dev.ucp.shopping.checkout`

## Overview

Allows platforms to facilitate checkout sessions. The checkout has to be finalized manually by the user through a trusted UI unless the AP2 Mandates extension is supported.

The business remains the Merchant of Record (MoR), and they don't need to become PCI DSS compliant to accept card payments through this Capability.

### Flow overview

### Payments

Payment handlers are discovered from the business's UCP profile at `/.well-known/ucp` and checkout.ucp.payment_handlers. The handlers define the processing specifications for collecting payment instruments (e.g., Google Pay, Shop Pay). When the buyer submits payment, the platform populates the `payment.instruments` array with the collected instrument data.

The `payment` object is optional on checkout creation and may be omitted for use cases that don't require payment processing (e.g., quote generation, cart management).

### Fulfillment

Fulfillment is modelled as an extension in UCP to account for diverse use cases.

Fulfillment is optional in the checkout object. This is done to enable a platform to perform checkout for digital goods without needing to furnish fulfillment details more relevant for physical goods.

### Checkout Status Lifecycle

The checkout `status` field indicates the current phase of the session and determines what action is required next. The business sets the status; the platform receives messages indicating what's needed to progress.

```text
┌────────────┐    ┌─────────────────────┐
│ incomplete │◀──▶│ requires_escalation │
└─────┬──────┘    │                     │
      │           │  (buyer handoff     │
      │           │   via continue_url) │
      │           └──────────┬──────────┘
      │                      │
      │ all info collected   │ continue_url
      ▼                      │
┌──────────────────┐         │
│ready_for_complete│         │
│                  │         │
│ (platform can    │         │
│ call Complete    │         │
│   Checkout).     │         │
└────────┬─────────┘         │
         │                   │
         │ Complete Checkout │
         ▼                   │
┌────────────────────┐       │
│complete_in_progress│       │
└─────────┬──────────┘       │
          │                  │
          └────────┬─────────┘
                   ▼
            ┌─────────────┐
            │  completed  │
            └─────────────┘

            ┌─────────────┐
            │  canceled   │  (session invalid/expired - can occur from any state)
            └─────────────┘
```

### Status Values

- **`incomplete`**: Checkout session is missing required information or has issues that need resolution. Platform should inspect `messages` array for context and should attempt to resolve via Update Checkout.
- **`requires_escalation`**: Checkout session requires information that cannot be provided via API, or buyer input is required. Platform should inspect `messages` to understand what's needed (see Error Handling below). If any `recoverable` errors exist, resolve those first. Then hand off to buyer via `continue_url`.
- **`ready_for_complete`**: Checkout session has all necessary information and platform can finalize programmatically. Platform can call Complete Checkout.
- **`complete_in_progress`**: Business is processing the Complete Checkout request.
- **`completed`**: Order placed successfully.
- **`canceled`**: Checkout session is invalid or expired. Platform should start a new checkout session if needed.

### Error Handling

The `messages` array contains errors, warnings, and informational messages about the checkout state. Error messages include a `severity` field that declares **who resolves the error**:

| Severity                | Meaning                                       | Platform Action               |
| ----------------------- | --------------------------------------------- | ----------------------------- |
| `recoverable`           | Platform can fix via API                      | Resolve using Update Checkout |
| `requires_buyer_input`  | Business requires input not available via API | Hand off via `continue_url`   |
| `requires_buyer_review` | Buyer review and authorization is required    | Hand off via `continue_url`   |

Errors with `requires_*` severity contribute to `status: requires_escalation`. Both result in buyer handoff, but represent different checkout states.

- `requires_buyer_input` means the checkout is **incomplete** — the business requires information their API doesn't support collecting programmatically.
- `requires_buyer_review` means the checkout is **complete** — but policy, regulatory, or entitlement rules require buyer authorization before order placement (e.g., high-value order approval, first-purchase policy).

#### Error Processing Algorithm

When status is `incomplete` or `requires_escalation`, platforms should process errors as a prioritized stack. The example below illustrates a checkout with three error types: a recoverable error (invalid phone), a buyer input requirement (delivery scheduling), and a review requirement (high-value order). The latter two require handoff and serve as explicit signals to the platform. Businesses **SHOULD** surface such messages as early as possible, and platforms **SHOULD** prioritize resolving recoverable errors before initiating handoff.

```json
{
  "status": "requires_escalation",
  "messages": [
    {
      "type": "error",
      "code": "invalid_phone",
      "severity": "recoverable",
      "content": "Phone number format is invalid"
    },
    {
      "type": "error",
      "code": "schedule_delivery",
      "severity": "requires_buyer_input",
      "content": "Select delivery window for your purchase"
    },
    {
      "type": "error",
      "code": "high_value_order",
      "severity": "requires_buyer_review",
      "content": "Orders over $500 require additional verification"
    }
  ]
}
```

Example error processing algorithm:

```text
GIVEN checkout with messages array
FILTER errors FROM messages WHERE type = "error"

PARTITION errors INTO
  recoverable           WHERE severity = "recoverable"
  requires_buyer_input  WHERE severity = "requires_buyer_input"
  requires_buyer_review WHERE severity = "requires_buyer_review"

IF recoverable is not empty
  FOR EACH error IN recoverable
    ATTEMPT to fix error (e.g., reformat phone number)
  CALL Update Checkout
  RETURN and re-evaluate response

IF requires_buyer_input is not empty
  handoff_context = "incomplete, additional input from buyer is required"
ELSE IF requires_buyer_review is not empty
  handoff_context = "ready for final review by the buyer"
```

## Continue URL

The `continue_url` field enables checkout handoff from platform to business UI, allowing the buyer to continue and finalize the checkout session.

### Availability

Businesses **MUST** provide `continue_url` when returning `status` = `requires_escalation`. For all other non-terminal statuses (`incomplete`, `ready_for_complete`, `complete_in_progress`), businesses **SHOULD** provide `continue_url`. For terminal states (`completed`, `canceled`), `continue_url` **SHOULD** be omitted.

### Format

The `continue_url` **MUST** be an absolute HTTPS URL and **SHOULD** preserve checkout state for seamless handoff. Businesses **MAY** implement state preservation using either approach:

#### Server-Side State (Recommended)

An opaque URL backed by server-side checkout state:

```text
https://business.example.com/checkout-sessions/{checkout_id}
```

- Server maintains checkout state tied to `checkout_id`
- Simple, secure, recommended for most implementations
- URL lifetime typically tied to `expires_at`

#### Checkout Permalink

A stateless URL that encodes checkout state directly, allowing reconstruction without server-side persistence. Businesses **SHOULD** implement support for this format to facilitate checkout handoff and accelerated entry—for example, a platform can prefill checkout state when initiating a buy-now flow.

> **Note:** Checkout permalinks are a REST-specific construct that extends the [REST transport binding](https://ucp.dev/draft/specification/checkout-rest/index.md). Accessing a permalink returns a redirect to the checkout UI or renders the checkout page directly.

## Guidelines

(In addition to the overarching guidelines)

### Platform

- **MAY** engage an agent to facilitate the checkout session (e.g. add items to the checkout session, select fulfillment address). However, the agent must hand over the checkout session to a trusted and deterministic UI for the user to review the checkout details and place the order.
- **MAY** send the user from the trusted, deterministic UI back to the agent at any time. For example, when the user decides to exit the checkout screen to keep adding items to the cart.
- **MAY** provide agent context when the platform indicates that the request was done by an agent.
- **MUST** use `continue_url` when checkout status is `requires_escalation`.
- **MAY** use `continue_url` to hand off to business UI in other situations.
- When performing handoff, **SHOULD** prefer business-provided `continue_url` over platform-constructed checkout permalinks.

### Business

- **MUST** send a confirmation email after the checkout has been completed.
- **SHOULD** provide accurate error messages.
- Logic handling the checkout sessions **MUST** be deterministic.
- **MUST** provide `continue_url` when returning `status` = `requires_escalation`.
- **MUST** include at least one message with `severity: escalation` when returning `status` = `requires_escalation`.
- **SHOULD** provide `continue_url` in all non-terminal checkout responses.
- After a checkout session reaches the state "completed", it is considered immutable.

## Capability Schema Definition

| Name         | Type                                                                                        | Required | Description                                                                                                                                                                                                                                                     |
| ------------ | ------------------------------------------------------------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Checkout Schema](/draft/specification/checkout/#ucp-response-checkout-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                                                                                                                                         |
| id           | string                                                                                      | **Yes**  | Unique identifier of the checkout session.                                                                                                                                                                                                                      |
| line_items   | Array\[[Line Item Response](/draft/specification/checkout/#line-item-response)\]            | **Yes**  | List of line items being checked out.                                                                                                                                                                                                                           |
| buyer        | [Buyer](/draft/specification/checkout/#buyer)                                               | No       | Representation of the buyer.                                                                                                                                                                                                                                    |
| status       | string                                                                                      | **Yes**  | Checkout state indicating the current phase and required action. See Checkout Status lifecycle documentation for state transition details. **Enum:** `incomplete`, `requires_escalation`, `ready_for_complete`, `complete_in_progress`, `completed`, `canceled` |
| currency     | string                                                                                      | **Yes**  | ISO 4217 currency code reflecting the merchant's market determination. Derived from address, context, and geo IP—buyers provide signals, merchants determine currency.                                                                                          |
| totals       | Array\[[Total Response](/draft/specification/checkout/#total-response)\]                    | **Yes**  | Different cart totals.                                                                                                                                                                                                                                          |
| messages     | Array\[[Message](/draft/specification/checkout/#message)\]                                  | No       | List of messages with error and info about the checkout session state.                                                                                                                                                                                          |
| links        | Array\[[Link](/draft/specification/checkout/#link)\]                                        | **Yes**  | Links to be displayed by the platform (Privacy Policy, TOS). Mandatory for legal compliance.                                                                                                                                                                    |
| expires_at   | string                                                                                      | No       | RFC 3339 expiry timestamp. Default TTL is 6 hours from creation if not sent.                                                                                                                                                                                    |
| continue_url | string                                                                                      | No       | URL for checkout handoff and session recovery. MUST be provided when status is requires_escalation. See specification for format and availability requirements.                                                                                                 |
| payment      | [Payment](/draft/specification/checkout/#payment)                                           | No       | Payment configuration containing handlers.                                                                                                                                                                                                                      |
| order        | [Order Confirmation](/draft/specification/checkout/#order-confirmation)                     | No       | Details about an order created for this checkout session.                                                                                                                                                                                                       |

## Operations

The Checkout capability defines the following logical operations.

| Operation             | Description                                                                        |
| --------------------- | ---------------------------------------------------------------------------------- |
| **Create Checkout**   | Initiates a new checkout session. Called as soon as a user adds an item to a cart. |
| **Get Checkout**      | Retrieves the current state of a checkout session.                                 |
| **Update Checkout**   | Updates a checkout session.                                                        |
| **Complete Checkout** | Finalizes the checkout and places the order.                                       |
| **Cancel Checkout**   | Cancels a checkout session.                                                        |

### Create Checkout

To be invoked by the platform when the user has expressed purchase intent (e.g., click on Buy) to initiate the checkout session with the item details.

**Recommendation**: To minimize discrepancies and a streamlined user experience, product data (price/title etc.) provided by the business through the feeds **SHOULD** match the actual attributes returned in the response.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

### Get Checkout

It provides the latest state of the checkout resource. After cancellation or completion it is up to the business on what to return (i.e this can be a long lived state or expire after a particular TTL - resulting in a 'not found' error). From the platform there is no specific enforcement for a TTL of the checkout.

The platform will honor the TTL provided by the business via `expires_at` at the time of checkout session creation.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

### Update Checkout

Performs a full replacement of the checkout resource. The platform is **REQUIRED** to send the entire checkout resource containing any data updates to write-only data fields. The resource provided in the request will replace the existing checkout session state on the business side.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

### Complete Checkout

This is the final checkout placement call. To be invoked when the user has committed to pay and place an order for the chosen items. The response of this call is the checkout object with the `order` field populated in it. The returned `order` provides necessary identifiers, such as `id` and `permalink_url`, that can be used to reference the full state of the placed order. At the time of order persistence, fields from `Checkout` **MAY** be used to construct the order representation (i.e. information like `line_items`, `fulfillment` will be used to create the initial order representation).

After this call, other details will be updated through subsequent events as the order, and its associated items, moves through the supply chain.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

### Cancel Checkout

This operation will be used to cancel a checkout session, if it can be canceled. If the checkout session cannot be canceled (e.g. checkout session is already canceled or completed), then businesses **SHOULD** send back an error indicating the operation is not allowed. Any checkout session with a status that is not equal to `completed` or `canceled` **SHOULD** be cancelable.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

## Transport Bindings

The abstract operations above are bound to specific transport protocols as defined below:

- [REST Binding](https://ucp.dev/draft/specification/checkout-rest/index.md): RESTful API mapping using standard HTTP verbs and JSON payloads.
- [MCP Binding](https://ucp.dev/draft/specification/checkout-mcp/index.md): Model Context Protocol mapping for agentic interaction.
- [A2A Binding](https://ucp.dev/draft/specification/checkout-a2a/index.md): Agent-to-Agent Protocol mapping for agentic interactions.
- [Embedded Checkout Binding](https://ucp.dev/draft/specification/embedded-checkout/index.md): JSON-RPC for powering embedded checkout.

## Entities

### Buyer

| Name         | Type   | Required | Description              |
| ------------ | ------ | -------- | ------------------------ |
| first_name   | string | No       | First name of the buyer. |
| last_name    | string | No       | Last name of the buyer.  |
| email        | string | No       | Email of the buyer.      |
| phone_number | string | No       | E.164 standard.          |

### Context

Context signals are provisional hints. Businesses SHOULD use these values when authoritative data (e.g. address) is absent, and MAY ignore unsupported values without returning errors. This differs from authoritative selections which require explicit validation and error feedback.

| Name            | Type   | Required | Description                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| address_country | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. Optional hint for market context (currency, availability, pricing)—higher-resolution data (e.g., shipping address) supersedes this value. |
| address_region  | string | No       | The region in which the locality is, and which is in the country. For example, California or another appropriate first-level Administrative division. Optional hint for progressive localization—higher-resolution data (e.g., shipping address) supersedes this value.                                                                                                             |
| postal_code     | string | No       | The postal code. For example, 94043. Optional hint for regional refinement—higher-resolution data (e.g., shipping address) supersedes this value.                                                                                                                                                                                                                                   |
| intent          | string | No       | Background context describing buyer's intent (e.g., 'looking for a gift under $50', 'need something durable for outdoor use'). Informs relevance, recommendations, and personalization.                                                                                                                                                                                             |

### Fulfillment Option

**Error:** Schema file 'fulfillment_resp.json' not found in any schema directory.

### Item

#### Item Create Request

**Error:** Schema 'types/item.create' not found in any schema directory.

#### Item Update Request

**Error:** Schema 'types/item.update' not found in any schema directory.

#### Item Response

| Name      | Type    | Required | Description                                                                                                                                                                 |
| --------- | ------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id        | string  | **Yes**  | The product identifier, often the SKU, required to resolve the product details associated with this line item. Should be recognized by both the Platform, and the Business. |
| title     | string  | **Yes**  | Product title.                                                                                                                                                              |
| price     | integer | **Yes**  | Unit price in minor (cents) currency units.                                                                                                                                 |
| image_url | string  | No       | Product image URI.                                                                                                                                                          |

### Line Item

#### Line Item Create Request

**Error:** Schema 'types/line_item.create' not found in any schema directory.

#### Line Item Update Request

**Error:** Schema 'types/line_item.update' not found in any schema directory.

#### Line Item Response

| Name      | Type                                                   | Required | Description                                            |
| --------- | ------------------------------------------------------ | -------- | ------------------------------------------------------ |
| id        | string                                                 | **Yes**  |                                                        |
| item      | [Item](/draft/specification/checkout/#item)            | **Yes**  |                                                        |
| quantity  | integer                                                | **Yes**  | Quantity of the item being purchased.                  |
| totals    | Array\[[Total](/draft/specification/checkout/#total)\] | **Yes**  | Line item totals breakdown.                            |
| parent_id | string                                                 | No       | Parent line item identifier for any nested structures. |

### Link

| Name  | Type   | Required | Description                                                                                                                                                                                                                          |
| ----- | ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| type  | string | **Yes**  | Type of link. Well-known values: `privacy_policy`, `terms_of_service`, `refund_policy`, `shipping_policy`, `faq`. Consumers SHOULD handle unknown values gracefully by displaying them using the `title` field or omitting the link. |
| url   | string | **Yes**  | The actual URL pointing to the content to be displayed.                                                                                                                                                                              |
| title | string | No       | Optional display text for the link. When provided, use this instead of generating from type.                                                                                                                                         |

#### Well-Known Link Types

Businesses **SHOULD** provide all relevant links for the transaction. The following are the recommended well-known types:

| Type               | Description                                       |
| ------------------ | ------------------------------------------------- |
| `privacy_policy`   | Link to the business's privacy policy             |
| `terms_of_service` | Link to the business's terms of service           |
| `refund_policy`    | Link to the business's refund policy              |
| `shipping_policy`  | Link to the business's shipping policy            |
| `faq`              | Link to the business's frequently asked questions |

Businesses **MAY** define custom types for domain-specific needs. Platforms **SHOULD** handle unknown types gracefully by displaying them using the `title` field or omitting them.

### Message

This object MUST be one of the following types: [Message Error](/draft/specification/checkout/#message-error), [Message Warning](/draft/specification/checkout/#message-warning), [Message Info](/draft/specification/checkout/#message-info).

### Message Error

| Name         | Type   | Required | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------------ | ------ | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = error**. Message type discriminator.                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| code         | string | **Yes**  | Error code. Possible values include: missing, invalid, out_of_stock, payment_declined, requires_sign_in, requires_3ds, requires_identity_linking. Freeform codes also allowed.                                                                                                                                                                                                                                                                                                                                 |
| path         | string | No       | RFC 9535 JSONPath to the component the message refers to (e.g., $.items[1]).                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown`                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| content      | string | **Yes**  | Human-readable message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| severity     | string | **Yes**  | Declares who resolves this error. 'recoverable': agent can fix via API. 'requires_buyer_input': merchant requires information their API doesn't support collecting programmatically (checkout incomplete). 'requires_buyer_review': buyer must authorize before order placement due to policy, regulatory, or entitlement rules (checkout complete). Errors with 'requires\_*' severity contribute to 'status: requires_escalation'.* *Enum:*\* `recoverable`, `requires_buyer_input`, `requires_buyer_review` |

### Message Info

| Name         | Type   | Required | Description                                                    |
| ------------ | ------ | -------- | -------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = info**. Message type discriminator.               |
| path         | string | No       | RFC 9535 JSONPath to the component the message refers to.      |
| code         | string | No       | Info code for programmatic handling.                           |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown` |
| content      | string | **Yes**  | Human-readable message.                                        |

### Message Warning

| Name         | Type   | Required | Description                                                                                                                           |
| ------------ | ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = warning**. Message type discriminator.                                                                                   |
| path         | string | No       | JSONPath (RFC 9535) to related field (e.g., $.line_items[0]).                                                                         |
| code         | string | **Yes**  | Warning code. Machine-readable identifier for the warning type (e.g., final_sale, prop65, fulfillment_changed, age_restricted, etc.). |
| content      | string | **Yes**  | Human-readable warning message that MUST be displayed.                                                                                |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown`                                                                        |

### Payment

| Name        | Type                                                                                               | Required | Description                                                                                                                                                                                                                |
| ----------- | -------------------------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| instruments | Array\[[Selected Payment Instrument](/draft/specification/checkout/#selected-payment-instrument)\] | No       | The payment instruments available for this payment. Each instrument is associated with a specific handler via the handler_id field. Handlers can extend the base payment_instrument schema to add handler-specific fields. |

### Payment Instrument

| Name            | Type                                                                    | Required | Description                                                                                                                                                  |
| --------------- | ----------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| id              | string                                                                  | **Yes**  | A unique identifier for this instrument instance, assigned by the platform.                                                                                  |
| handler_id      | string                                                                  | **Yes**  | The unique identifier for the handler instance that produced this instrument. This corresponds to the 'id' field in the Payment Handler definition.          |
| type            | string                                                                  | **Yes**  | The broad category of the instrument (e.g., 'card', 'tokenized_card'). Specific schemas will constrain this to a constant value.                             |
| billing_address | [Postal Address](/draft/specification/checkout/#postal-address)         | No       | The billing address associated with this payment method.                                                                                                     |
| credential      | [Payment Credential](/draft/specification/checkout/#payment-credential) | No       | The base definition for any payment credential. Handlers define specific credential types.                                                                   |
| display         | object                                                                  | No       | Display information for this payment instrument. Each payment instrument schema defines its specific display properties, as outlined by the payment handler. |

### Payment Credential

| Name | Type   | Required | Description                                                                                  |
| ---- | ------ | -------- | -------------------------------------------------------------------------------------------- |
| type | string | **Yes**  | The credential type discriminator. Specific schemas will constrain this to a constant value. |

### Postal Address

| Name             | Type   | Required | Description                                                                                                                                                                                                                               |
| ---------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extended_address | string | No       | An address extension such as an apartment number, C/O or alternative name.                                                                                                                                                                |
| street_address   | string | No       | The street address.                                                                                                                                                                                                                       |
| address_locality | string | No       | The locality in which the street address is, and which is in the region. For example, Mountain View.                                                                                                                                      |
| address_region   | string | No       | The region in which the locality is, and which is in the country. Required for applicable countries (i.e. state in US, province in CA). For example, California or another appropriate first-level Administrative division.               |
| address_country  | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. |
| postal_code      | string | No       | The postal code. For example, 94043.                                                                                                                                                                                                      |
| first_name       | string | No       | Optional. First name of the contact associated with the address.                                                                                                                                                                          |
| last_name        | string | No       | Optional. Last name of the contact associated with the address.                                                                                                                                                                           |
| phone_number     | string | No       | Optional. Phone number of the contact associated with the address.                                                                                                                                                                        |

### Response

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |

### Total

#### Total Response

| Name         | Type    | Required | Description                                                                                                                   |
| ------------ | ------- | -------- | ----------------------------------------------------------------------------------------------------------------------------- |
| type         | string  | **Yes**  | Type of total categorization. **Enum:** `items_discount`, `subtotal`, `discount`, `fulfillment`, `tax`, `fee`, `total`        |
| display_text | string  | No       | Text to display against the amount. Should reflect appropriate method (e.g., 'Shipping', 'Delivery').                         |
| amount       | integer | **Yes**  | If type == total, sums subtotal - discount + fulfillment + tax + fee. Should be >= 0. Amount in minor (cents) currency units. |

### UCP Response Checkout

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |
| services                                                                                    | any  | No       |             |
| capabilities                                                                                | any  | No       |             |
| payment_handlers                                                                            | any  | **Yes**  |             |

### Order Confirmation

| Name          | Type   | Required | Description                                     |
| ------------- | ------ | -------- | ----------------------------------------------- |
| id            | string | **Yes**  | Unique order identifier.                        |
| permalink_url | string | **Yes**  | Permalink to access the order on merchant site. |

# Checkout Capability - REST Binding

This document specifies the REST binding for the [Checkout Capability](https://ucp.dev/draft/specification/checkout/index.md).

## Protocol Fundamentals

### Base URL

All UCP REST endpoints are relative to the business's base URL, which is discovered through the UCP profile at `/.well-known/ucp`. The endpoint for the checkout capability is defined in the `rest.endpoint` field of the business profile.

### Content Types

- **Request**: `application/json`
- **Response**: `application/json`

All request and response bodies **MUST** be valid JSON as specified in [RFC 8259](https://tools.ietf.org/html/rfc8259).

### Transport Security

All REST endpoints **MUST** be served over HTTPS with minimum TLS version 1.3.

## Operations

| Operation                                                                            | Method | Endpoint                           | Description                |
| ------------------------------------------------------------------------------------ | ------ | ---------------------------------- | -------------------------- |
| [Create Checkout](https://ucp.dev/draft/specification/checkout/#create-checkout)     | `POST` | `/checkout-sessions`               | Create a checkout session. |
| [Get Checkout](https://ucp.dev/draft/specification/checkout/#get-checkout)           | `GET`  | `/checkout-sessions/{id}`          | Get a checkout session.    |
| [Update Checkout](https://ucp.dev/draft/specification/checkout/#update-checkout)     | `PUT`  | `/checkout-sessions/{id}`          | Update a checkout session. |
| [Complete Checkout](https://ucp.dev/draft/specification/checkout/#complete-checkout) | `POST` | `/checkout-sessions/{id}/complete` | Place the order.           |
| [Cancel Checkout](https://ucp.dev/draft/specification/checkout/#cancel-checkout)     | `POST` | `/checkout-sessions/{id}/cancel`   | Cancel a checkout session. |

## Examples

### Create Checkout

```json
POST /checkout-sessions HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "line_items": [
    {
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "id": "li_1",
      "quantity": 2
    }
  ]
}
```

```json
HTTP/1.1 201 Created
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.shopify.shop_pay": [
        {
          "id": "shop_pay_1234",
          "version": "2026-01-11",
          "config": {
            "merchant_id": "shop_merchant_123"
          }
        }
      ]
    }
  },
  "id": "chk_1234567890",
  "status": "incomplete",
  "messages": [
    {
      "type": "error",
      "code": "missing",
      "path": "$.buyer.email",
      "content": "Buyer email is required",
      "severity": "recoverable"
    }
  ],
  "currency": "USD",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "tax",
      "amount": 400
    },
    {
      "type": "total",
      "amount": 5400
    }
  ],
  "links": [
    {
      "type": "terms_of_service",
      "url": "https://business.example.com/terms"
    }
  ],
  "payment": {
    "instruments": [
      {
        "id": "instr_shop_pay_1",
        "handler_id": "shop_pay_1234",
        "type": "shop_pay",
        "selected": true,
        "display": {
          "email": "buyer@example.com"
        }
      }
    ]
  }
}
```

### Update Checkout

#### Update Buyer Info

All fields in `buyer` are optional, allowing clients to progressively build the checkout state across multiple calls. Each PUT replaces the entire session, so clients must include all previously set fields they wish to retain.

```json
PUT /checkout-sessions/{id} HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "id": "chk_123456789",
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "line_items": [
    {
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "id": "li_1",
      "quantity": 2
    }
  ]
}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.shopify.shop_pay": [
        {
          "id": "shop_pay_1234",
          "version": "2026-01-11",
          "config": {
            "merchant_id": "shop_merchant_123"
          }
        }
      ]
    }
  },
  "id": "chk_1234567890",
  "status": "incomplete",
  "messages": [
    {
      "type": "error",
      "code": "missing",
      "path": "$.fulfillment.method[0].selected_destination_id",
      "content": "Fulfillment address is required",
      "severity": "recoverable"
    }
  ],
  "currency": "USD",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "tax",
      "amount": 400
    },
    {
      "type": "total",
      "amount": 5400
    }
  ],
  "links": [
    {
      "type": "terms_of_service",
      "url": "https://business.example.com/terms"
    }
  ],
  "payment": {
    "instruments": [
      {
        "id": "instr_shop_pay_1",
        "handler_id": "shop_pay_1234",
        "type": "shop_pay",
        "selected": true,
        "display": {
          "email": "buyer@example.com"
        }
      }
    ]
  }
}
```

#### Update Fulfillment

Fulfillment is an extension to the checkout capability. Most fields are provided by the business based on buyer inputs, which includes desired fulfillment type & addresses.

```json
PUT /checkout-sessions/{id} HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "id": "chk_123456789",
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "line_items": [
    {
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "id": "li_1",
      "quantity": 2
    }
  ],
  "fulfillment": {
    "methods": [
      {
        "type": "shipping",
        "destinations": [
          {
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ]
      }
    ]
  }
}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.google.pay": [
        {
          "id": "gpay_1234",
          "version": "2026-01-11",
          "config": {
            "allowed_payment_methods": [
              {
                "type": "CARD",
                "parameters": {
                  "allowed_card_networks": ["VISA", "MASTERCARD", "AMEX"]
                }
              }
            ]
          }
        }
      ]
    }
  },
  "id": "chk_1234567890",
  "status": "incomplete",
  "messages": [
    {
      "type": "error",
      "code": "missing",
      "path": "$.selected_fulfillment_option",
      "content": "Please select a fulfillment option",
      "severity": "recoverable"
    }
  ],
  "currency": "USD",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "tax",
      "amount": 400
    },
    {
      "type": "total",
      "amount": 5400
    }
  ],
  "links": [
    {
      "type": "terms_of_service",
      "url": "https://merchant.com/terms"
    }
  ],
  "fulfillment": {
    "methods": [
      {
        "id": "shipping_1",
        "type": "shipping",
        "line_item_ids": ["item_123"],
        "selected_destination_id": "dest_home",
        "destinations": [
          {
            "id": "dest_home",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["item_123"],
            "selected_option_id": "standard",
            "options": [
              {
                "id": "standard",
                "title": "Standard Shipping",
                "description": "Arrives in 5-7 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express Shipping",
                "description": "Arrives in 2-3 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "payment": {
    "instruments": [
      {
        "id": "pi_gpay_5678",
        "handler_id": "gpay_1234",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "mastercard",
          "last_digits": "5678",
          "rich_text_description": "Google Pay •••• 5678"
        }
      }
    ]
  }
}
```

#### Update Fulfillment Selection

Follow-up calls after initial `fulfillment` data to update selection.

```json
PUT /checkout-sessions/{id} HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "id": "chk_123456789",
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "line_items": [
    {
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "id": "li_1",
      "quantity": 2,
    }
  ],
  "fulfillment": {
    "methods": [
      {
        "id": "shipping_1",
        "type": "shipping",
        "line_item_ids": ["item_123"],
        "selected_destination_id": "dest_home",
        "destinations": [
          {
            "id": "dest_home",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "selected_option_id": "express"
          }
        ]
      }
    ]
  }
}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.shopify.shop_pay": [
        {
          "id": "shop_pay_1234",
          "version": "2026-01-11",
          "config": {
            "merchant_id": "shop_merchant_123"
          }
        }
      ]
    }
  },
  "id": "chk_1234567890",
  "status": "ready_for_complete",
  "currency": "USD",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "tax",
      "amount": 400
    },
    {
      "type": "total",
      "amount": 5400
    }
  ],
  "links": [
    {
      "type": "terms_of_service",
      "url": "https://merchant.com/terms"
    }
  ],
  "fulfillment": {
    "methods": [
      {
        "id": "shipping_1",
        "type": "shipping",
        "line_item_ids": ["item_123"],
        "selected_destination_id": "dest_home",
        "destinations": [
          {
            "id": "dest_home",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["item_123"],
            "selected_option_id": "express",
            "options": [
              {
                "id": "standard",
                "title": "Standard Shipping",
                "description": "Arrives in 5-7 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express Shipping",
                "description": "Arrives in 2-3 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "payment": {
    "instruments": [
      {
        "id": "instr_shop_pay_1",
        "handler_id": "shop_pay_1234",
        "type": "shop_pay",
        "selected": true,
        "display": {
          "email": "buyer@example.com"
        }
      }
    ]
  }
}
```

### Complete Checkout

If businesses have specific logic to enforce field existence in `buyer` and addresses (i.e. `fulfillment_address`, `billing_address`), this is the right place to set these expectations via `messages`.

```json
POST /checkout-sessions/{id}/complete
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "payment": {
    "instruments": [
      {
        "id": "pi_gpay_5678",
        "handler_id": "gpay_1234",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "mastercard",
          "last_digits": "5678",
          "card_art": "https://cart-art-1.html",
          "description": "Google Pay •••• 5678"
        },
        "billing_address": {
          "street_address": "123 Main St",
          "address_locality": "Anytown",
          "address_region": "CA",
          "address_country": "US",
          "postal_code": "12345"
        },
        "credential": {
          "type": "PAYMENT_GATEWAY",
          "token": "examplePaymentMethodToken"
        }
      }
    ]
  },
  "risk_signals": {
    //... risk signal related data (device fingerprint / risk token)
  }
}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.google.pay": [
        {
          "id": "gpay_1234",
          "version": "2026-01-11",
          "config": {
            "allowed_payment_methods": [
              {
                "type": "CARD",
                "parameters": {
                  "allowed_card_networks": ["VISA", "MASTERCARD", "AMEX"]
                }
              }
            ]
          }
        }
      ]
    }
  },
  "id": "chk_123456789",
  "status": "completed",
  "currency": "USD",
  "order": {
    "id": "ord_99887766",
    "permalink_url": "https://merchant.com/orders/ord_99887766"
  },
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "tax",
      "amount": 400
    },
    {
      "type": "total",
      "amount": 5400
    }
  ],
  "links": [
    {
      "type": "terms_of_service",
      "url": "https://merchant.com/terms"
    }
  ],
  "fulfillment": {
    "methods": [
      {
        "id": "shipping_1",
        "type": "shipping",
        "line_item_ids": ["item_123"],
        "selected_destination_id": "dest_home",
        "destinations": [
          {
            "id": "dest_home",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["item_123"],
            "selected_option_id": "express",
            "options": [
              {
                "id": "standard",
                "title": "Standard Shipping",
                "description": "Arrives in 5-7 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express Shipping",
                "description": "Arrives in 2-3 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "payment": {
    "instruments": [
      {
        "id": "pi_gpay_5678",
        "handler_id": "gpay_1234",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "mastercard",
          "last_digits": "5678",
          "rich_text_description": "Google Pay •••• 5678"
        }
      }
    ]
  }
}
```

### Get Checkout

```json
GET /checkout-sessions/{id}
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.shopify.shop_pay": [
        {
          "id": "shop_pay_1234",
          "version": "2026-01-11",
          "config": {
            "merchant_id": "shop_merchant_123"
          }
        }
      ]
    }
  },
  "id": "chk_123456789",
  "status": "completed",
  "currency": "USD",
  "order": {
    "id": "ord_99887766",
    "permalink_url": "https://merchant.com/orders/ord_99887766"
  },
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "tax",
      "amount": 400
    },
    {
      "type": "total",
      "amount": 5400
    }
  ],
  "links": [
    {
      "type": "terms_of_service",
      "url": "https://merchant.com/terms"
    }
  ],
  "fulfillment": {
    "methods": [
      {
        "id": "shipping_1",
        "type": "shipping",
        "line_item_ids": ["item_123"],
        "selected_destination_id": "dest_home",
        "destinations": [
          {
            "id": "dest_home",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["item_123"],
            "selected_option_id": "express",
            "options": [
              {
                "id": "standard",
                "title": "Standard Shipping",
                "description": "Arrives in 5-7 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express Shipping",
                "description": "Arrives in 2-3 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "payment": {
    "instruments": [
      {
        "id": "instr_shop_pay_1",
        "handler_id": "shop_pay_1234",
        "type": "shop_pay",
        "selected": true,
        "display": {
          "email": "buyer@example.com"
        }
      }
    ]
  }
}
```

### Cancel Checkout

```json
POST /checkout-sessions/{id}/cancel
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {"version": "2026-01-11"}
      ]
    },
    "payment_handlers": {
      "com.google.pay": [
        {
          "id": "gpay_1234",
          "version": "2026-01-11",
          "config": {
            "allowed_payment_methods": [
              {
                "type": "CARD",
                "parameters": {
                  "allowed_card_networks": ["VISA", "MASTERCARD", "AMEX"]
                }
              }
            ]
          }
        }
      ]
    }
  },
  "id": "chk_123456789",
  "status": "canceled", // Status is updated to canceled.
  "currency": "USD",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "buyer": {
    "email": "jane@example.com",
    "first_name": "Jane",
    "last_name": "Doe"
  },
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "tax",
      "amount": 400
    },
    {
      "type": "total",
      "amount": 5400
    }
  ],
  "links": [
    {
      "type": "terms_of_service",
      "url": "https://merchant.com/terms"
    }
  ],
  "fulfillment": {
    "methods": [
      {
        "id": "shipping_1",
        "type": "shipping",
        "line_item_ids": ["item_123"],
        "selected_destination_id": "dest_home",
        "destinations": [
          {
            "id": "dest_home",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["item_123"],
            "selected_option_id": "express",
            "options": [
              {
                "id": "standard",
                "title": "Standard Shipping",
                "description": "Arrives in 5-7 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express Shipping",
                "description": "Arrives in 2-3 business days",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "payment": {
    "instruments": [
      {
        "id": "pi_gpay_5678",
        "handler_id": "gpay_1234",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "mastercard",
          "last_digits": "5678",
          "rich_text_description": "Google Pay •••• 5678"
        }
      }
    ]
  }
}
```

## HTTP Headers

The following headers are defined for the HTTP binding and apply to all operations unless otherwise noted.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

### Specific Header Requirements

- **UCP-Agent**: All requests **MUST** include the `UCP-Agent` header containing the platform profile URI using Dictionary Structured Field syntax ([RFC 8941](https://datatracker.ietf.org/doc/html/rfc8941)). Format: `profile="https://platform.example/profile"`.
- **Idempotency-Key**: Operations that modify state **SHOULD** support idempotency. When provided, the server **MUST**:
  1. Store the key with the operation result for at least 24 hours.
  1. Return the cached result for duplicate keys.
  1. Return `409 Conflict` if the key is reused with different parameters.

## Protocol Mechanics

### Status Codes

UCP uses standard HTTP status codes to indicate the success or failure of an API request.

| Status Code                 | Description                                                                        |
| --------------------------- | ---------------------------------------------------------------------------------- |
| `200 OK`                    | The request was successful.                                                        |
| `201 Created`               | The resource was successfully created.                                             |
| `400 Bad Request`           | The request was invalid or cannot be served.                                       |
| `401 Unauthorized`          | Authentication is required and has failed or has not been provided.                |
| `403 Forbidden`             | The request is authenticated but the user does not have the necessary permissions. |
| `409 Conflict`              | The request could not be completed due to a conflict (e.g., idempotent key reuse). |
| `422 Unprocessable Entity`  | The profile content is malformed (discovery failure).                              |
| `424 Failed Dependency`     | The profile URL is valid but fetch failed (discovery failure).                     |
| `429 Too Many Requests`     | Rate limit exceeded.                                                               |
| `503 Service Unavailable`   | Temporary unavailability.                                                          |
| `500 Internal Server Error` | An unexpected condition was encountered on the server.                             |

### Error Responses

See the [Core Specification](https://ucp.dev/draft/specification/overview/#error-handling) for negotiation error handling (discovery failures, negotiation failures).

#### Business Outcomes

Business outcomes (including errors like unavailable merchandise) are returned with HTTP 200 and the UCP envelope containing `messages`:

```json
{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.checkout": [{"version": "2026-01-11"}]
    }
  },
  "id": "checkout_abc123",
  "status": "incomplete",
  "line_items": [
    {
      "id": "item_456",
      "quantity": 100,
      "available_quantity": 12
    }
  ],
  "messages": [
    {
      "type": "error",
      "code": "INSUFFICIENT_STOCK",
      "content": "Requested 100 units but only 12 available",
      "severity": "requires_buyer_input",
      "path": "$.line_items[0].quantity"
    }
  ],
  "continue_url": "https://merchant.com/checkout/checkout_abc123"
}
```

## Security Considerations

### Authentication

Authentication is optional and depends on business requirements. When authentication is required, the REST transport **MAY** use:

1. **Open API**: No authentication required for public operations.
1. **API Keys**: Via `X-API-Key` header.
1. **OAuth 2.0**: Via `Authorization: Bearer {token}` header, following [RFC 6749](https://tools.ietf.org/html/rfc6749).
1. **Mutual TLS**: For high-security environments.

Businesses **MAY** require authentication for some operations while leaving others open (e.g., public checkout without authentication).

# Checkout Capability - MCP Binding

This document specifies the Model Context Protocol (MCP) binding for the [Checkout Capability](https://ucp.dev/draft/specification/checkout/index.md).

## Protocol Fundamentals

### Discovery

Businesses advertise MCP transport availability through their UCP profile at `/.well-known/ucp`.

```json
{
  "ucp": {
    "version": "2026-01-11",
    "services": {
      "dev.ucp.shopping": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/overview",
          "transport": "mcp",
          "schema": "https://ucp.dev/services/shopping/mcp.openrpc.json",
          "endpoint": "https://business.example.com/ucp/mcp"
        }
      ]
    },
    "capabilities": {
      "dev.ucp.shopping.checkout": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/checkout",
          "schema": "https://ucp.dev/schemas/shopping/checkout.json"
        }
      ],
      "dev.ucp.shopping.fulfillment": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/fulfillment",
          "schema": "https://ucp.dev/schemas/shopping/fulfillment.json",
          "extends": "dev.ucp.shopping.checkout"
        }
      ]
    },
    "payment_handlers": {
      "com.example.vendor.delegate_payment": [
        {
          "id": "handler_1",
          "version": "2026-01-11",
          "spec": "https://example.vendor.com/specs/delegate-payment",
          "schema": "https://example.vendor.com/schemas/delegate-payment-config.json",
          "config": {}
        }
      ]
    }
  }
}
```

### Request Metadata

MCP clients **MUST** include a `meta` object in every request containing protocol metadata:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "create_checkout",
    "arguments": {
      "meta": {
        "ucp-agent": {
          "profile": "https://platform.example/profiles/shopping-agent.json"
        },
        "idempotency-key": "550e8400-e29b-41d4-a716-446655440000"
      },
      "checkout": { ... }
    }
  }
}
```

The `meta["ucp-agent"]` field is **required** on all requests to enable [capability negotiation](https://ucp.dev/draft/specification/overview/#negotiation-protocol). The `complete_checkout` and `cancel_checkout` operations also require `meta["idempotency-key"]` for retry safety. Platforms **MAY** include additional metadata fields.

## Tools

UCP Capabilities map 1:1 to MCP Tools.

### Identifier Pattern

MCP tools separate resource identification from payload data:

- **Requests:** For operations on existing checkouts (`get`, `update`, `complete`, `cancel`), a top-level `id` parameter identifies the target resource. The `checkout` object in the request payload **MUST NOT** contain an `id` field.
- **Responses:** All responses include `checkout.id` as part of the full resource state.
- **Create:** The `create_checkout` operation does not require an `id` in the request, and the response includes the newly assigned `checkout.id`.

| Tool                | Operation                                                                            | Description                |
| ------------------- | ------------------------------------------------------------------------------------ | -------------------------- |
| `create_checkout`   | [Create Checkout](https://ucp.dev/draft/specification/checkout/#create-checkout)     | Create a checkout session. |
| `get_checkout`      | [Get Checkout](https://ucp.dev/draft/specification/checkout/#get-checkout)           | Get a checkout session.    |
| `update_checkout`   | [Update Checkout](https://ucp.dev/draft/specification/checkout/#update-checkout)     | Update a checkout session. |
| `complete_checkout` | [Complete Checkout](https://ucp.dev/draft/specification/checkout/#complete-checkout) | Place the order.           |
| `cancel_checkout`   | [Cancel Checkout](https://ucp.dev/draft/specification/checkout/#cancel-checkout)     | Cancel a checkout session. |

### `create_checkout`

Maps to the [Create Checkout](https://ucp.dev/draft/specification/checkout/#create-checkout) operation.

#### Input Schema

- `checkout` ([Checkout](https://ucp.dev/draft/specification/checkout/#create-checkout)): **Required**. Contains the initial checkout session data and optional extensions.
  - Extensions (Optional):
    - `dev.ucp.shopping.buyer_consent`: [Buyer Consent](https://ucp.dev/draft/specification/buyer-consent/index.md)
    - `dev.ucp.shopping.fulfillment`: [Fulfillment](https://ucp.dev/draft/specification/fulfillment/index.md)
    - `dev.ucp.shopping.discount`: [Discount](https://ucp.dev/draft/specification/discount/index.md)
    - `dev.ucp.shopping.ap2_mandate`: [AP2 Mandates](https://ucp.dev/draft/specification/ap2-mandates/index.md)

#### Output Schema

- [Checkout](https://ucp.dev/draft/specification/checkout/#create-checkout) object.

#### Example

```json
{
  "jsonrpc": "2.0",
  "method": "create_checkout",
  "params": {
    "meta": {
      "ucp-agent": {
        "profile": "https://platform.example/profiles/v2026-01/shopping-agent.json"
      }
    },
    "checkout": {
      "buyer": {
        "email": "jane.doe@example.com",
        "first_name": "Jane",
        "last_name": "Doe"
      },
      "line_items": [
        {
          "item": {
            "id": "item_123"
          },
          "quantity": 1
        }
      ],
      "currency": "USD",
      "fulfillment": {
        "methods": [
          {
            "type": "shipping",
            "destinations": [
              {
                "street_address": "123 Main St",
                "address_locality": "Springfield",
                "address_region": "IL",
                "postal_code": "62701",
                "address_country": "US"
              }
            ]
          }
        ]
      }
    }
  },
  "id": 1
}
```

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-11",
      "capabilities": {
        "dev.ucp.shopping.checkout": [
          {"version": "2026-01-11"}
        ],
        "dev.ucp.shopping.fulfillment": [
          {"version": "2026-01-11"}
        ]
      },
      "payment_handlers": {
        "com.example.vendor.delegate_payment": [
          {"id": "handler_1", "version": "2026-01-11", "config": {}}
        ]
      }
    },
    "id": "checkout_abc123",
    "status": "incomplete",
    "buyer": {
      "email": "jane.doe@example.com",
      "first_name": "Jane",
      "last_name": "Doe"
    },
    "line_items": [
      {
        "id": "item_123",
        "item": {
          "id": "item_123",
          "title": "Blue Jeans",
          "price": 5000
        },
        "quantity": 1,
        "totals": [
          {"type": "subtotal", "amount": 5000},
          {"type": "total", "amount": 5000}
        ]
      }
    ],
    "currency": "USD",
    "totals": [
      {
        "type": "subtotal",
        "amount": 5000
      },
      {
        "type": "fulfillment",
        "display_text": "Shipping",
        "amount": 500
      },
      {
        "type": "total",
        "amount": 5500
      }
    ],
    "fulfillment": {
      "methods": [
        {
          "id": "shipping_1",
          "type": "shipping",
          "line_item_ids": ["item_123"],
          "selected_destination_id": "dest_home",
          "destinations": [
            {
              "id": "dest_home",
              "street_address": "123 Main St",
              "address_locality": "Springfield",
              "address_region": "IL",
              "postal_code": "62701",
              "address_country": "US"
            }
          ],
          "groups": [
            {
              "id": "package_1",
              "line_item_ids": ["item_123"],
              "selected_option_id": "standard",
              "options": [
                {
                  "id": "standard",
                  "title": "Standard Shipping",
                  "description": "Arrives in 5-7 business days",
                  "totals": [
                    {
                      "type": "total",
                      "amount": 500
                    }
                  ]
                },
                {
                  "id": "express",
                  "title": "Express Shipping",
                  "description": "Arrives in 2-3 business days",
                  "totals": [
                    {
                      "type": "total",
                      "amount": 1000
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "links": [
      {
        "type": "privacy_policy",
        "url": "https://business.example.com/privacy"
      },
      {
        "type": "terms_of_service",
        "url": "https://business.example.com/terms"
      }
    ],
    "continue_url": "https://business.example.com/checkout-sessions/checkout_abc123",
    "expires_at": "2026-01-11T18:30:00Z"
  }
}
```

### `get_checkout`

Maps to the [Get Checkout](https://ucp.dev/draft/specification/checkout/#get-checkout) operation.

#### Input Schema

- `id` (String): **Required**. The ID of the checkout session.

#### Output Schema

- [Checkout](https://ucp.dev/draft/specification/checkout/#get-checkout) object.

### `update_checkout`

Maps to the [Update Checkout](https://ucp.dev/draft/specification/checkout/#update-checkout) operation.

#### Input Schema

- `id` (String): **Required**. The ID of the checkout session to update.
- `checkout` ([Checkout](https://ucp.dev/draft/specification/checkout/#update-checkout)): **Required**. Contains the updated checkout session data.
  - Extensions (Optional):
    - `dev.ucp.shopping.buyer_consent`: [Buyer Consent](https://ucp.dev/draft/specification/buyer-consent/index.md)
    - `dev.ucp.shopping.fulfillment`: [Fulfillment](https://ucp.dev/draft/specification/fulfillment/index.md)
    - `dev.ucp.shopping.discount`: [Discount](https://ucp.dev/draft/specification/discount/index.md)
    - `dev.ucp.shopping.ap2_mandate`: [AP2 Mandates](https://ucp.dev/draft/specification/ap2-mandates/index.md)

#### Output Schema

- [Checkout](https://ucp.dev/draft/specification/checkout/#update-checkout) object.

#### Example

```json
{
  "jsonrpc": "2.0",
  "method": "update_checkout",
  "params": {
    "meta": {
      "ucp-agent": {
        "profile": "https://platform.example/profiles/v2026-01/shopping-agent.json"
      }
    },
    "id": "checkout_abc123",
    "checkout": {
      "buyer": {
        "email": "jane.doe@example.com",
        "first_name": "Jane",
        "last_name": "Doe"
      },
      "line_items": [
        {
          "item": {
            "id": "item_123"
          },
          "quantity": 1
        }
      ],
      "currency": "USD",
      "fulfillment": {
        "methods": [
          {
            "id": "shipping_1",
            "line_item_ids": ["item_123"],
            "groups": [
              {
                "id": "package_1",
                "selected_option_id": "express"
              }
            ]
          }
        ]
      }
    }
  },
  "id": 2
}
```

```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "ucp": {
      "version": "2026-01-11",
      "capabilities": {
        "dev.ucp.shopping.checkout": [
          {"version": "2026-01-11"}
        ],
        "dev.ucp.shopping.fulfillment": [
          {"version": "2026-01-11"}
        ]
      },
      "payment_handlers": {
        "com.example.vendor.delegate_payment": [
          {"id": "handler_1", "version": "2026-01-11", "config": {}}
        ]
      }
    },
    "id": "checkout_abc123",
    "status": "incomplete",
    "buyer": {
      "email": "jane.doe@example.com",
      "first_name": "Jane",
      "last_name": "Doe"
    },
    "line_items": [
      {
        "id": "item_123",
        "item": {
          "id": "item_123",
          "title": "Blue Jeans",
          "price": 5000
        },
        "quantity": 1,
        "totals": [
          {"type": "subtotal", "amount": 5000},
          {"type": "total", "amount": 5000}
        ]
      }
    ],
    "currency": "USD",
    "totals": [
      {
        "type": "subtotal",
        "amount": 5000
      },
      {
        "type": "fulfillment",
        "display_text": "Shipping",
        "amount": 1000
      },
      {
        "type": "total",
        "amount": 6000
      }
    ],
    "fulfillment": {
      "methods": [
        {
          "id": "shipping_1",
          "type": "shipping",
          "line_item_ids": ["item_123"],
          "selected_destination_id": "dest_home",
          "destinations": [
            {
              "id": "dest_home",
              "street_address": "123 Main St",
              "address_locality": "Springfield",
              "address_region": "IL",
              "postal_code": "62701",
              "address_country": "US"
            }
          ],
          "groups": [
            {
              "id": "package_1",
              "line_item_ids": ["item_123"],
              "selected_option_id": "express",
              "options": [
                {
                  "id": "standard",
                  "title": "Standard Shipping",
                  "description": "Arrives in 5-7 business days",
                  "totals": [
                    {
                      "type": "total",
                      "amount": 500
                    }
                  ]
                },
                {
                  "id": "express",
                  "title": "Express Shipping",
                  "description": "Arrives in 2-3 business days",
                  "totals": [
                    {
                      "type": "total",
                      "amount": 1000
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "links": [
      {
        "type": "privacy_policy",
        "url": "https://business.example.com/privacy"
      },
      {
        "type": "terms_of_service",
        "url": "https://business.example.com/terms"
      }
    ],
    "continue_url": "https://business.example.com/checkout-sessions/checkout_abc123",
    "expires_at": "2026-01-11T18:30:00Z"
  }
}
```

### `complete_checkout`

Maps to the [Complete Checkout](https://ucp.dev/draft/specification/checkout/#complete-checkout) operation.

#### Input Schema

- `meta` (Object): **Required**. Request metadata containing:
  - `ucp-agent` (Object): **Required**. Platform agent identification.
  - `idempotency-key` (String, UUID): **Required**. Unique key for retry safety.
- `id` (String): **Required**. The ID of the checkout session.
- `checkout` ([Checkout](https://ucp.dev/draft/specification/checkout/#complete-checkout)): **Required**. Contains payment credentials and other finalization data to execute the transaction.

#### Output Schema

- [Checkout](https://ucp.dev/draft/specification/checkout/#complete-checkout) object, containing a partial `order` that holds only `id` and `permalink_url`.

### `cancel_checkout`

Maps to the [Cancel Checkout](https://ucp.dev/draft/specification/checkout/#cancel-checkout) operation.

#### Input Schema

- `meta` (Object): **Required**. Request metadata containing:
  - `ucp-agent` (Object): **Required**. Platform agent identification.
  - `idempotency-key` (String, UUID): **Required**. Unique key for retry safety.
- `id` (String): **Required**. The ID of the checkout session.

#### Output Schema

- [Checkout](https://ucp.dev/draft/specification/checkout/#cancel-checkout) object with `status: canceled`.

## Error Handling

See the [Core Specification](https://ucp.dev/draft/specification/overview/#error-handling) for negotiation error handling (discovery failures, negotiation failures).

### Business Outcomes

Business outcomes (including errors like unavailable merchandise) are returned as JSON-RPC `result` with the UCP envelope and `messages`:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-11",
      "capabilities": {
        "dev.ucp.shopping.checkout": [{"version": "2026-01-11"}]
      }
    },
    "id": "checkout_abc123",
    "status": "incomplete",
    "line_items": [
      {
        "id": "item_456",
        "quantity": 100,
        "available_quantity": 12
      }
    ],
    "messages": [
      {
        "type": "error",
        "code": "INSUFFICIENT_STOCK",
        "content": "Requested 100 units but only 12 available",
        "severity": "requires_buyer_input",
        "path": "$.line_items[0].quantity"
      }
    ],
    "continue_url": "https://merchant.com/checkout/checkout_abc123"
  }
}
```

## Conformance

A conforming MCP transport implementation **MUST**:

1. Implement JSON-RPC 2.0 protocol correctly.
1. Provide all core checkout tools defined in this specification.
1. Return negotiation failures per the [Core Specification](https://ucp.dev/draft/specification/overview/#error-handling).
1. Return business outcomes as JSON-RPC `result` with UCP envelope and `messages` array.
1. Validate tool inputs against UCP schemas.
1. Support HTTP transport with streaming.

## Implementation

UCP operations are defined using [OpenRPC](https://open-rpc.org/) (JSON-RPC schema format). The [MCP specification](https://modelcontextprotocol.io/) requires all tool invocations to use a `tools/call` method with the operation name and arguments wrapped in `params`. Implementers **MUST** apply this transformation:

| OpenRPC  | MCP                |
| -------- | ------------------ |
| `method` | `params.name`      |
| `params` | `params.arguments` |

**Param conventions:**

- `meta` contains request metadata
- `id` identifies the target resource (path parameter equivalent)
- `checkout` contains the domain payload (body equivalent)

**Example:** Given the `complete_checkout` operation defined in OpenRPC:

```json
{
  "method": "complete_checkout",
  "params": {
    "meta": {
      "ucp-agent": { "profile": "https://..." },
      "idempotency-key": "550e8400-e29b-41d4-a716-446655440000"
    },
    "id": "checkout_abc123",
    "checkout": { "payment": {...} }
  }
}
```

Implementers **MUST** expose this as an MCP `tools/call` endpoint:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "complete_checkout",
    "arguments": {
      "meta": {
        "ucp-agent": { "profile": "https://..." },
        "idempotency-key": "550e8400-e29b-41d4-a716-446655440000"
      },
      "id": "checkout_abc123",
      "checkout": { "payment": {...} }
    }
  }
}
```

# Checkout Capability - A2A Binding

This document specifies the Agent2Agent Protocol (A2A) binding for [Checkout Capability](https://ucp.dev/draft/specification/checkout/index.md).

## Transport Discovery

Businesses that support A2A transport must specify the agent card endpoint as part of `services` in UCP Profile at `/.well-known/ucp`. This allows capable platforms to interact with the business services over A2A Protocol.

```json
{
  "ucp": {
    "version": "2026-01-11",
    "services": {
      "dev.ucp.shopping": [
        {
          "version": "2026-01-11",
          "spec": "https://ucp.dev/specification/overview",
          "transport": "a2a",
          "endpoint": "https://example-business.com/.well-known/agent-card.json"
        }
      ]
    }
  }
}
```

## Shopping Agent Profile Advertisement

Shopping platforms interacting with the business agent must send their profile URI as `UCP-Agent` request headers with every request.

```text
UCP-Agent: profile="https://agent.example/profiles/v2025-11/shopping-agent.json"
Content-Type: application/json
```

### Header Mapping Reference

The following table defines the required headers for enabling an A2A Agent to communicate UCP data types with platforms.

| Header Name        | Description                                |
| ------------------ | ------------------------------------------ |
| `UCP-Agent`        | Shopping platform application profile URI. |
| `X-A2A-Extensions` | UCP Extension URI (specified below).       |

## A2A Interactions

The A2A Protocol provides a strong foundation for inter-agent communication. [A2A extensions](https://a2a-protocol.org/latest/topics/extensions/) enable communication between agents with structured data types. This enables businesses to build AI applications to leverage UCP data types for communication with platforms.

The URI for UCP A2A extension: `https://ucp.dev/specification/reference?v=2026-01-11`

Businesses supporting UCP must advertise the extension and any optional capabilities in their A2A Agent Card to allow platforms to activate the extension.

An example:

```json
{
  "extensions": [
    {
      "uri": "https://ucp.dev/specification/reference?v=2026-01-11",
      "description": "Business agent supporting UCP",
      "params": {
        "capabilities": {
          "dev.ucp.shopping.checkout": [
            {"version": "2026-01-11"}
          ],
          "dev.ucp.shopping.fulfillment": [
            {
              "version": "2026-01-11",
              "extends": "dev.ucp.shopping.checkout"
            }
          ]
        }
      }
    }
  ]
}
```

### Agent2Agent Negotiation

The business agents can leverage A2A `Message` objects for allowing interaction with shopping agents/platforms. The A2A `Message` object returned by the agent will return structured data in `DataPart` objects within the message. Platforms must pass the business agent generated `contextId` for subsequent turns in a session to preserve the current context.

Business agents may also leverage A2A `Task` objects for scenarios where applicable. In such scenarios, the business agent will return `Task` objects with appropriate payload for interaction with the platforms. Platforms must pass the server generated `taskId` along with the `contextId` for subsequent turns until the task is completed.

Platforms must be capable of handling further negotiation in the same session even after a task reaches a terminal state (e.g. user places an order and wants to place another order in the same context or if the task reaches a failed state due to an exception). Platforms must reset the `taskId` once a task reaches terminal state to allow further interactions with the agent, although the current `contextId` can be reused for subsequent interactions.

## Request Idempotency

Business agents must leverage the `messageId` sent as part of the A2A `Message` to detect duplicate messages from platform retries.

## Checkout Functionality

The Checkout capability allows consumers to manage items in a checkout session and complete the purchase process. The business agent typically integrates with the business's checkout APIs for offering this functionality.

The extension defines the data schema for representing the Checkout functionality by business agent for any checkout related actions, completing or canceling the checkout. `Checkout` entity is a profile of an A2A `Message`. The Checkout entity must be returned by the business agent to the platform that activated UCP-A2A Extension in an A2A `Message`'s `DataPart`. The checkout object **MUST** be returned as part of a `DataPart` object with key `a2a.ucp.checkout`.

**Request format:** Agentic applications can accept natural language input from users interacting with the agent to identify the user's intent, negotiate with the user to capture any required information and then invoke the appropriate tools to perform the operation. Inputs from platforms can be sent to the remote business agent as an A2A `Message`.

Examples:

- Natural language input

```json
{
  "message": {
    "role": "user",
    "parts": [
      {
        "type": "text",
        "text": "add Pixel 10 Pro to my checkout"
      }
    ],
    "messageId": "69da8f87-991b-479e-80dc-ed92fcb57cbe",
    "kind": "message",
    "contextId": "aad14abc-4082-4748-84ca-4afff85aedfa"
  }
}
```

- Structured inputs on user actions

```json
{
  "message": {
    "role": "user",
    "parts": [
      {
        "type": "data",
        "data": {
          "action": "add_to_checkout",
          "product_id": "PIXEL-10-PRO",
          "quantity": 1
        }
      }
    ],
    "messageId": "e94a8c10-69f4-4c4c-b988-21a298302da6",
    "kind": "message",
    "contextId": "aad14abc-4082-4748-84ca-4afff85aedfa"
  }
}
```

**Response format:** Following is an example response from a business agent implementing Checkout functionality:

```json
{
  "id": 33,
  "jsonrpc": "2.0",
  "result": {
    "contextId": "4629ea79-7201-4ece-bc7a-ce19fff76e61",
    "kind": "message",
    "messageId": "8e8566e0-6d7c-4f29-bd90-26a132385baa",
    "parts": [
      {
        "data": {
          "a2a.ucp.checkout": {...checkoutObject}
        },
        "kind": "data"
      }
    ],
    "role": "agent"
  }
}
```

### Checkout Completion

When a user is ready to make a payment, `payment` must be submitted to the business agent to complete the checkout process. `payment` is a structured data type specified as part of UCP. When processing a payment to complete the checkout, `payment` must be submitted to the business agent as a `DataPart` with attribute name `a2a.ucp.checkout.payment`. Any associated risk signals should be sent with attribute name `a2a.ucp.checkout.risk_signals`.

Upon completion of the checkout process, the business agent must return the checkout object containing an `order` attribute with `id` and `permalink_url`.

**Request format:**

```json
{
  "message": {
    "role": "user",
    "parts": [
      {
        "type": "data",
        "data": {"action":"complete_checkout"}
      },
      {
        "kind": "data",
        "data": {
          "a2a.ucp.checkout.payment": {
            ...paymentObject
          },
          "a2a.ucp.checkout.risk_signals":{...content}
        }
      }
    ],
    "messageId": "e94a8c10-69f4-4c4c-b988-21a298302da6",
    "kind": "message",
    "contextId": "aad14abc-4082-4748-84ca-4afff85aedfa"
  }
}
```

**Response format:** Following is an example response from a business agent implementing Checkout functionality:

```json
{
  "id": 33,
  "jsonrpc": "2.0",
  "result": {
    "contextId": "4629ea79-7201-4ece-bc7a-ce19fff76e61",
    "kind": "message",
    "messageId": "8e8566e0-6d7c-4f29-bd90-26a132385baa",
    "parts": [
      {
        "data": {
          "a2a.ucp.checkout": { ...checkoutObject }
        },
        "kind": "data"
      }
    ],
    "role": "agent"
  }
}
```

#### AP2 based Checkout Completion

Business agents can implement AP2 mandates extension that enables secure exchange of user intents and authorizations for Agent-to-Agent payment interactions. Businesses that support AP2 mandates extension for UCP must specify this in the UCP discovery document and the A2A agent card. The AP2 mandates extension is considered implicitly active when a platform and business agent advertise AP2 mandates extension in their respective profiles.

When AP2 mandates extension is enabled, the business agent must create a detached JWS for the checkout object and must return the generated signature as part of the `DataPart` as `ap2.merchant_authorization`. This will allow the platform to cryptographically verify the checkout payload against the business's public keys.

```json
{
  "id": 33,
  "jsonrpc": "2.0",
  "result": {
    "contextId": "4629ea79-7201-4ece-bc7a-ce19fff76e61",
    "kind": "message",
    "messageId": "8e8566e0-6d7c-4f29-bd90-26a132385baa",
    "parts": [
      {
        "data": {
          "a2a.ucp.checkout": {
            ...checkoutObject,
            "ap2": {
              "merchant_authorization": "<detached jws signature>"
            }
          }
        },
        "kind": "data"
      }
    ],
    "role": "agent"
  }
}
```

When the user confirms the payment on a platform, the user signed checkout and payment mandate objects must be sent as `DataPart`s to the business agent for completing checkout. The `payment` which includes the payment mandate must be submitted as part of a `DataPart` with attribute name `a2a.ucp.checkout.payment`. Signed checkout mandate must be specified in the `DataPart` as `ap2.checkout_mandate`. The `token` attribute of `payment.instruments[*].credential` contains the payment mandate. Refer to [AP2 Mandates Extension](https://ucp.dev/draft/specification/ap2-mandates/index.md) documentation for more details about verification and processing of the mandates to complete the checkout.

**Request format:**

```json
{
  "message": {
    "role": "user",
    "parts": [
      {
        "type": "data",
        "data": {
          "action": "complete_checkout"
        }
      },
      {
        "kind": "data",
        "data": {
          "a2a.ucp.checkout.payment": {
            "instruments": [
              {
                "id": "instr_1",
                "handler_id": "gpay_1234",
                "type": "card",
                "selected": true,
                "display": {
                  "description": "Visa •••• 1234",
                },
                "billing_address": {
                  "street_address": "123 Main St",
                  "address_locality": "Anytown",
                  "address_region": "CA",
                  "address_country": "US",
                  "postal_code": "12345"
                },
                "credential": {
                  "type": "PAYMENT_GATEWAY",
                  "token": "examplePaymentMethodToken"
                }
              }
            ]
          },
          "ap2": {
            "checkout_mandate": "eyJhbGciOiJFUz..."
          }
        }
      }
    ],
    "messageId": "e94a8c10-69f4-4c4c-b988-21a298302da6",
    "kind": "message",
    "contextId": "aad14abc-4082-4748-84ca-4afff85aedfa"
  }
}
```
# Checkout Extensions

# AP2 Mandates Extension

## Overview

The AP2 Mandates extension enables the secure exchange of user intents and authorizations using **Verifiable Digital Credentials**. It extends the standard Shopping Service Checkout capability to support the **[AP2 Protocol](https://ap2-protocol.org/)**.

When this capability is negotiated and active, it transforms a standard checkout session into a cryptographically bound agreement:

- **Businesses** **MUST** embed a cryptographic signature in checkout responses, proving the terms (price, line items) are authentic.
- **Platforms** **MUST** provide cryptographically signed proofs (Mandates) during the `complete` operation, proving the user explicitly authorized the specific checkout state and funds transfer.

**Security Binding:** Once this extension is negotiated in the capability intersection, the session is **Security Locked**. Neither party may revert to a standard (unprotected) checkout flow.

### Design

All AP2-specific fields are nested under an `ap2` object in both requests and responses. This design provides:

- **Schema modularity** — Base checkout schema stays clean; AP2 adds one field containing all its data.
- **Consistent canonicalization** — One rule: exclude `ap2` from the business's signature computation. Future AP2 fields are automatically handled.
- **Extension coexistence** — Multiple security extensions can coexist without namespace collisions.
- **Capability signal** — Presence of `ap2` object clearly indicates AP2 is active.

## Discovery & Negotiation

This extension follows the standard UCP negotiation protocol. It is activated only when it appears in the **Capability Intersection** of both the business and the platform.

### Business Profile Advertisement

Businesses declare support by adding `dev.ucp.shopping.ap2_mandate` to their `capabilities` list in `/.well-known/ucp`.

**Business Profile Example:**

```json
{
  "capabilities": {
    "dev.ucp.shopping.checkout": [
      {
        "version": "2026-01-11",
        "spec": "https://ucp.dev/specification/checkout",
        "schema": "https://ucp.dev/schemas/shopping/checkout.json"
      }
    ],
    "dev.ucp.shopping.ap2_mandate": [
      {
        "version": "2026-01-11",
        "spec": "https://ucp.dev/specification/ap2-mandates",
        "schema": "https://ucp.dev/schemas/shopping/ap2_mandate.json",
        "extends": "dev.ucp.shopping.checkout",
        "config": {
          "vp_formats_supported": {
            "dc+sd-jwt": { }
          }
        }
      }
    ]
  }
}
```

### Platform Profile Advertisement

Platforms declare support in their profile. If the platform is operating under the trusted platform provider model, the platform **MUST** provide at least one key in the top-level `signing_keys` array in their profile.

### Activation and Session Locking

1. The platform advertises its profile URI (transport-specific mechanism).
1. The business fetches the profile and computes the intersection.
1. If `dev.ucp.shopping.ap2_mandate` is present in the intersection:
   - The business **MUST** include `ap2.merchant_authorization` in all checkout responses.
   - The business **MUST NOT** accept a `complete_checkout` request that lacks `ap2.checkout_mandate`.
   - The platform **MUST** verify the business's signature before presenting the checkout to the user.

### Signing Key Requirements

To utilize this extension, a public signing key **MUST** be available for the business to verify the mandate's signature.

- **Platform Provider Flow:** Key provided in the platform profile's `signing_keys`.
- **User Credential Flow:** Key bound to the digital payment credential.

If a public key cannot be resolved, or if the signature is invalid, the business **MUST** return an error.

## Cryptographic Requirements

### Signature Algorithm

All signatures **MUST** use one of the following algorithms:

| Algorithm | Description                                           |
| --------- | ----------------------------------------------------- |
| `ES256`   | ECDSA using P-256 curve and SHA-256 (**RECOMMENDED**) |
| `ES384`   | ECDSA using P-384 curve and SHA-384                   |
| `ES512`   | ECDSA using P-521 curve and SHA-512                   |

### Business Authorization

Businesses **MUST** embed their signature in the checkout response body under `ap2.merchant_authorization` using **JWS Detached Content** format ([RFC 7515 Appendix F](https://datatracker.ietf.org/doc/html/rfc7515#appendix-F)).

**Checkout Response with Embedded Signature:**

```json
{
  "id": "chk_abc123",
  "status": "ready_for_complete",
  "currency": "USD",
  "line_items": [...],
  "totals": [...],
  "ap2": {
    "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6Im1lcmNoYW50XzIwMjUifQ..<signature>"
  }
}
```

The `merchant_authorization` value is a JWS with detached payload in the format `<header>..<signature>`. The double dot (`..`) indicates the payload is transmitted separately (as the checkout body itself).

**JWS Header Claims:**

| Claim | Type   | Required | Description                                      |
| ----- | ------ | -------- | ------------------------------------------------ |
| `alg` | string | Yes      | Signature algorithm (`ES256`, `ES384`, `ES512`)  |
| `kid` | string | Yes      | Key ID referencing the business's `signing_keys` |

**Signature Computation:**

The signature **MUST** cover both the JWS header and the checkout payload. This prevents algorithm substitution attacks where an attacker modifies the `alg` claim without invalidating the signature.

```text
sign_checkout(checkout, private_key, kid, alg="ES256"):
    // Extract payload (checkout minus ap2)
    payload = checkout without "ap2" field

    // Canonicalize using JCS (RFC 8785)
    canonical_bytes = jcs_canonicalize(payload)

    // Create protected header
    header = {"alg": alg, "kid": kid}
    encoded_header = base64url_encode(json_encode(header))

    // Sign header + payload per JWS
    signing_input = encoded_header + "." + base64url_encode(canonical_bytes)
    signature = sign(signing_input, private_key, alg)

    // Return detached JWS (header..signature, no payload)
    checkout.ap2.merchant_authorization = encoded_header + ".." + base64url_encode(signature)
    return checkout
```

### Mandate Structure

Mandates are **SD-JWT** credentials with Key Binding (`+kb`). The platform **MUST** produce two distinct mandate artifacts:

| Mandate              | UCP Placement                             | Purpose                                              |
| -------------------- | ----------------------------------------- | ---------------------------------------------------- |
| **checkout_mandate** | `ap2.checkout_mandate`                    | Proof bound to checkout terms, protects business     |
| **payment_mandate**  | `payment.instruments[*].credential.token` | Proof bound to payment authorization, protects funds |

The checkout mandate **MUST** contain the full checkout response including the `ap2.merchant_authorization` field. This creates a nested cryptographic binding where the platform's signature covers the business's signature.

**Specification Boundary:** This extension defines *where* mandates are placed in UCP requests and responses. The mandate credential structure (claims, selective disclosure, key binding) is defined by the [AP2 Protocol Specification](https://ap2-protocol.org/specification).

### Canonicalization

For signature computation over JSON payloads, implementations **MUST** use **JSON Canonicalization Scheme (JCS)** as defined in [RFC 8785](https://datatracker.ietf.org/doc/html/rfc8785).

JCS produces a deterministic, byte-for-byte identical representation of JSON data, ensuring signatures can be verified regardless of whitespace, key ordering, or Unicode normalization differences.

**Canonicalization Rule:** When computing the business's signature, exclude the `ap2` field entirely. This ensures future AP2 fields are automatically handled.

## The Mandate Flow

Once the `dev.ucp.shopping.ap2_mandate` capability is negotiated, the session is locked into the following flow. Both parties **MUST** follow these steps to ensure cryptographic integrity; any attempt to bypass these steps or submit a completion request without mandates **MUST** result in a session failure.

### Step 1: Checkout Creation & Signing

The platform initiates the session. The business returns the `Checkout` object with `ap2.merchant_authorization` embedded in the response body.

**Error:** Definition '#/$defs/checkout' not found in 'source/schemas/shopping/ap2_mandate.json'

**Example Response:**

```json
{
  "id": "chk_abc123",
  "status": "ready_for_complete",
  "currency": "USD",
  "line_items": [
    {
      "id": "li_1",
      "item": {"id": "item_123", "title": "Widget", "price": 2500},
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "totals": [
    {"type": "subtotal", "amount": 5000},
    {"type": "tax", "amount": 400},
    {"type": "total", "amount": 5400}
  ],
  "ap2": {
    "merchant_authorization": "eyJhbGciOiJFUzI1NiIsImtpZCI6Im1lcmNoYW50XzIwMjUifQ..<signature>"
  }
}
```

The platform **MUST** verify the signature:

```text
verify_merchant_authorization(checkout, merchant_profile):
    // Parse detached JWS (header..signature)
    jws = checkout.ap2.merchant_authorization
    [encoded_header, empty, encoded_signature] = jws.split(".")

    // Decode and validate header
    header = json_decode(base64url_decode(encoded_header))
    assert header.alg in ["ES256", "ES384", "ES512"]

    // Reconstruct signed payload (checkout minus ap2)
    payload = checkout without "ap2" field
    canonical_bytes = jcs_canonicalize(payload)

    // Reconstruct signing input (header + payload)
    signing_input = encoded_header + "." + base64url_encode(canonical_bytes)

    // Get business's public key and verify
    public_key = get_key_by_kid(merchant_profile.signing_keys, header.kid)
    return verify(encoded_signature, signing_input, public_key, header.alg)
```

### Step 2: User Consent & Mandate Generation

When the user confirms the purchase, the platform **MUST** facilitate the generation of cryptographically verifiable mandates.

#### Option 1: Trusted Platform Provider

A trusted platform provider acts on the user's behalf to generate the mandate credentials. The platform provider **MUST** ensure that mandates are not created without explicit user consent from trusted, deterministic channels.

Upon user consent, the platform signs the mandates using their server-side key. The business trusts the platform's signature implies user consent.

#### Option 2: Digital Payment Credential

In this model the user has a VDC issued from a source trusted by the business (for example: a digital payment credential issued by a bank or network).

The platform requests a presentation via a protocol like OpenID4VP. The User's Wallet (or equivalent) processes the request and signs the mandates using the private key associated with their payment credential.

The business trusts the Credential Issuer (Bank) and verifies the user's Key Binding (+kb) signature.

### Step 3: Submission (`complete_checkout`)

Once the mandates are generated, the platform submits them in the completion request:

| Name             | Type                                                                    | Required | Description                                      |
| ---------------- | ----------------------------------------------------------------------- | -------- | ------------------------------------------------ |
| checkout_mandate | [Checkout Mandate](/draft/specification/ap2-mandates/#checkout-mandate) | No       | SD-JWT+kb proving user authorized this checkout. |

```json
{
  "payment": {
    "instruments": [
      {
        "id": "instr_1",
        "handler_id": "gpay_1234",
        "type": "card",
        "selected": true,
        "display": {
          "description": "Visa •••• 1234",
        },
        "billing_address": {
          "street_address": "123 Main St",
          "address_locality": "Anytown",
          "address_region": "CA",
          "address_country": "US",
          "postal_code": "12345"
        },
        "credential": {
          "type": "PAYMENT_GATEWAY",
          "token": "examplePaymentMethodToken"
        }
      }
    ]
  },
  "ap2": {
    "checkout_mandate": "eyJhbGciOiJFUzI1NiIsInR5cCI6InZjK3NkLWp3dCJ9..." // The User-Signed SD-JWT+kb / platform provider signed SD-JWT / delegated SD-JWT-KB
  }
}
```

- `ap2.checkout_mandate`: The SD-JWT+kb checkout mandate containing the full checkout (with `ap2.merchant_authorization`)
- `payment.instruments[*].credential.token`: Contains the payment mandate (composite token)

## Verification & Processing

### Business Verification

Upon receiving the `complete` request, the business **MUST**:

1. **Enforce Negotiation:** If AP2 was negotiated, reject the request with `mandate_required` error code if `ap2.checkout_mandate` is missing.

**Mandate Verification (per AP2 spec):**

1. **Verify Mandate:** Decode and verify the SD-JWT signature, key binding, and expiration per the [AP2 Protocol Specification](https://ap2-protocol.org/specification).
1. **Extract Embedded Checkout:** Extract the checkout object from the verified mandate claims.

**UCP Verification:**

1. **Verify Business Authorization:** Confirm `ap2.merchant_authorization` in the embedded checkout is the business's own valid signature:

   ```text
   jws = embedded_checkout.ap2.merchant_authorization
   [encoded_header, _, encoded_signature] = jws.split(".")
   header = json_decode(base64url_decode(encoded_header))

   payload = embedded_checkout without "ap2" field
   signing_input = encoded_header + "." + base64url_encode(jcs_canonicalize(payload))

   my_key = get_key_by_kid(my_signing_keys, header.kid)
   verify(encoded_signature, signing_input, my_key, header.alg)
   ```

1. **Verify Terms Match:** Confirm the embedded checkout terms match the current session state (id, totals, line items).

### PSP Verification

The business passes the `token` (composite object) to their Payment Handler / PSP. The PSP verifies the `payment_mandate` per the [AP2 Protocol Specification](https://ap2-protocol.org/specification), including signature validation, expiration, and correlation with the checkout.

## Schema

### Business Authorization

JWS Detached Content signature (RFC 7515 Appendix F) over the checkout response body (excluding ap2 field). Format: `<base64url-header>..<base64url-signature>`. The header MUST contain 'alg' (ES256/ES384/ES512) and 'kid' claims. The signature covers both the header and JCS-canonicalized checkout payload.

**Pattern:** `^[A-Za-z0-9_-]+\.\.[A-Za-z0-9_-]+$`

### AP2 Checkout Response

The `ap2` object included in checkout responses.

| Name                   | Type                                                                                | Required | Description                                                |
| ---------------------- | ----------------------------------------------------------------------------------- | -------- | ---------------------------------------------------------- |
| merchant_authorization | [Merchant Authorization](/draft/specification/ap2-mandates/#merchant-authorization) | No       | Merchant's signature proving checkout terms are authentic. |

### Checkout Mandate

SD-JWT+kb credential in `ap2.checkout_mandate`. Proving user authorization for the checkout. Contains the full checkout including `ap2.merchant_authorization`.

**Pattern:** `^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]*\.[A-Za-z0-9_-]+(~[A-Za-z0-9_-]+)*$`

### AP2 Complete Request

The `ap2` object included in COMPLETE checkout requests.

| Name             | Type                                                                    | Required | Description                                      |
| ---------------- | ----------------------------------------------------------------------- | -------- | ------------------------------------------------ |
| checkout_mandate | [Checkout Mandate](/draft/specification/ap2-mandates/#checkout-mandate) | No       | SD-JWT+kb proving user authorized this checkout. |

### Error Codes

Error codes specific to AP2 mandate verification.

**Enum:** `mandate_required`, `agent_missing_key`, `mandate_invalid_signature`, `mandate_expired`, `mandate_scope_mismatch`, `merchant_authorization_invalid`, `merchant_authorization_missing`

| Error Code                       | Description                                                       |
| -------------------------------- | ----------------------------------------------------------------- |
| `mandate_required`               | AP2 was negotiated, but the request lacks `ap2.checkout_mandate`. |
| `agent_missing_key`              | Platform profile lacks a valid `signing_keys` entry.              |
| `mandate_invalid_signature`      | The mandate signature cannot be verified.                         |
| `mandate_expired`                | The mandate `exp` timestamp has passed.                           |
| `mandate_scope_mismatch`         | The mandate is bound to a different checkout.                     |
| `merchant_authorization_invalid` | The business authorization signature could not be verified.       |

# Buyer Consent Extension

## Overview

The Buyer Consent extension enables platforms to transmit buyer consent choices to businesses regarding data usage and communication preferences. It allows buyers to communicate their consent status for various categories, such as analytics, marketing, and data sales, helping businesses comply with privacy regulations like CCPA and GDPR.

When this extension is supported, the `buyer` object in checkout is extended with a `consent` field containing boolean consent states.

This extension can be included in `create_checkout` and `update_checkout` operations.

## Discovery

Businesses advertise consent support in their profile:

```json
{
  "capabilities": {
    "dev.ucp.shopping.buyer_consent": [
      {
        "version": "2026-01-11",
        "extends": "dev.ucp.shopping.checkout"
      }
    ]
  }
}
```

## Schema Composition

The consent extension extends the **buyer object** within checkout:

- **Base schema extended**: `checkout` via `buyer` object
- **Path**: `checkout.buyer.consent`
- **Schema reference**: `buyer_consent.json`

## Schema Definition

### Consent Object

**Error:** Schema file 'buyer_consent_resp.json' not found in any schema directory.

## Usage

The platform includes consent within the `buyer` object in checkout operations:

### Example: Create Checkout with Consent

```json
POST /checkouts

{
  "line_items": [
    {
      "item": {
        "id": "prod_123",
        "title": "Blue T-Shirt",
        "price": 1999
      },
      "id": "li_1",
      "quantity": 1
    }
  ],
  "buyer": {
    "email": "jane.doe@example.com",
    "first_name": "Jane",
    "last_name": "Doe",
    "consent": {
      "analytics": true,
      "preferences": true,
      "marketing": false,
      "sale_of_data": false
    }
  }
}
```

### Example: Checkout Response with Consent

```json
{
  "id": "checkout_456",
  "status": "ready_for_payment",
  "currency": "USD",
  "buyer": {
    "email": "jane.doe@example.com",
    "first_name": "Jane",
    "last_name": "Doe",
    "consent": {
      "analytics": true,
      "preferences": true,
      "marketing": false,
      "sale_of_data": false
    }
  },
  "line_items": [...],
  "totals": [...],
  "links": [
    {
      "type": "privacy_policy",
      "url": "https://example.com/privacy"
    }
  ]
}
```

## Security & Privacy Considerations

1. **Consent is declarative** - The protocol communicates consent, it does not enforce it
1. **Legal compliance** remains the business's responsibility
1. **Platforms should not** assume consent without explicit user action
1. **Default behavior** when consent is not provided is business-specific

# Discount Extension

## Overview

Discount extension allows businesses to indicate that they support discount codes on checkout sessions, and specifies how the discount codes are to be shared between the platform and the business.

**Key features:**

- Submit one or more discount codes
- Receive applied discounts with human-readable titles and amounts
- Rejected codes communicated via `messages[]` with detailed error codes
- Automatic discounts surfaced alongside code-based discounts

**Dependencies:**

- Checkout Capability

## Discovery

Businesses advertise discount support in their profile:

```json
{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.discount": [
        {
          "version": "2026-01-11",
          "extends": "dev.ucp.shopping.checkout",
          "spec": "https://ucp.dev/specification/discount",
          "schema": "https://ucp.dev/schemas/shopping/discount.json"
        }
      ]
    }
  }
}
```

## Schema

When this capability is active, checkout is extended with a `discounts` object.

### Discounts Object

**Error:** Schema file 'discount_resp.json' not found in any schema directory.

### Applied Discount

**Error:** Schema file 'discount_resp.json' not found in any schema directory.

### Allocation

**Error:** Schema file 'discount_resp.json' not found in any schema directory.

## Allocation Details

The `applied` array explains how discounts were calculated and distributed.

### Allocation Method

The `method` field indicates how the discount was calculated:

| Method   | Meaning                                 | Example                                          |
| -------- | --------------------------------------- | ------------------------------------------------ |
| `each`   | Applied independently per eligible item | "10% off each item" → 10% × item price           |
| `across` | Split proportionally by value           | "$10 off order" → $6 to $60 item, $4 to $40 item |

### Stacking Order

When multiple discounts are applied, `priority` indicates the calculation order. Lower numbers are applied first:

```text
Cart: $100
Discount A (priority: 1): 20% off → $100 × 0.8 = $80
Discount B (priority: 2): $10 off → $80 - $10 = $70
```

The order matters because percentage discounts compound differently depending on when they're applied.

### Allocations Array

The `allocations` array breaks down where each discount dollar landed, using JSONPath to identify targets:

| Path Pattern        | Target           |
| ------------------- | ---------------- |
| `$.line_items[0]`   | First line item  |
| `$.line_items[1]`   | Second line item |
| `$.totals.shipping` | Shipping cost    |

This enables platforms to explain exactly how much each discount contributed to each line item, even when multiple discounts stack.

**Invariant:** Sum of `allocations[].amount` equals `applied_discount.amount`.

## Operations

Discount codes are submitted via standard checkout create/update operations.

**Request behavior:**

- **Replacement semantics**: Submitting `discounts.codes` replaces any previously submitted codes
- **Clear codes**: Send empty array `"codes": []` to remove all discount codes
- **Case-insensitive**: Codes are matched case-insensitively by business

**Response behavior:**

- `discounts.applied` contains all active discounts (code-based + automatic)
- Rejected codes communicated via `messages[]` (see below)
- Discount amounts reflected in `totals[]` and `line_items[].discount`

## Rejected Codes

When a submitted discount code cannot be applied, businesses communicate this via the `messages[]` array:

```json
{
  "messages": [
    {
      "type": "warning",
      "code": "discount_code_expired",
      "path": "$.discounts.codes[0]",
      "content": "Code 'SUMMER20' expired on December 1st"
    }
  ]
}
```

> **Implementation guidance:** Operations that affect order totals, or the user's expectation of the total, **SHOULD** use `type: "warning"` to ensure they are surfaced to the user rather than silently handled by platforms. Rejected discounts are a prime example—the user expects a discount but won't receive it, so they should be informed.

**Error codes for rejected discounts:**

| Code                                   | Description                                 |
| -------------------------------------- | ------------------------------------------- |
| `discount_code_expired`                | Code has expired                            |
| `discount_code_invalid`                | Code not found or malformed                 |
| `discount_code_already_applied`        | Code is already applied                     |
| `discount_code_combination_disallowed` | Cannot combine with another active discount |
| `discount_code_user_not_logged_in`     | Code requires authenticated user            |
| `discount_code_user_ineligible`        | User does not meet eligibility criteria     |

## Automatic Discounts

Businesses may apply discounts automatically based on cart contents, customer segment, or promotional rules:

- Appear in `discounts.applied` with `automatic: true` and no `code` field
- Applied without platform action
- Cannot be removed by the platform
- Surfaced for transparency (platform can explain to user why discount was applied)

## Impact on Line Items and Totals

Applied discounts are reflected in the core checkout fields using two distinct total types:

| Total Type       | When to Use                                               |
| ---------------- | --------------------------------------------------------- |
| `items_discount` | Discounts allocated to line items (`$.line_items[*]`)     |
| `discount`       | Order-level discounts (shipping, fees, flat order amount) |

**Determining the type:** If a discount has `allocations` pointing to line items, it contributes to `items_discount`. Discounts without allocations, or with allocations to shipping/fees, contribute to `discount`.

| Discount Type        | Where Reflected                            |
| -------------------- | ------------------------------------------ |
| Line-item discount   | `line_items[].discount` + `items_discount` |
| Order-level discount | `totals[]` with `type: "discount"`         |

**Invariant:** `totals[type=items_discount].amount` equals `sum(line_items[].discount)`.

The `discounts.applied` array shows **what** was applied. The `totals[]` and `line_items[].discount` show **where** and **how much**.

**Amount convention:** All discount amounts are positive integers in minor currency units. When presenting totals to users, display discount types as subtractive (e.g., "-$13.99").

## Examples

### Order-level discount

A flat discount applied to the order total. No allocations—the discount applies to the order as a whole and uses `type: "discount"` in totals.

**Request:**

```json
{
  "discounts": {
    "codes": ["SAVE10"]
  }
}
```

**Response:**

```json
{
  "discounts": {
    "codes": ["SAVE10"],
    "applied": [
      {
        "code": "SAVE10",
        "title": "$10 Off Your Order",
        "amount": 1000
      }
    ]
  },
  "totals": [
    {"type": "subtotal", "display_text": "Subtotal", "amount": 5000},
    {"type": "discount", "display_text": "Order Discount", "amount": 1000},
    {"type": "total", "display_text": "Total", "amount": 4000}
  ]
}
```

### Mixed discounts (item + order level)

This example shows both discount types: a per-item discount (20% off) allocated to line items, and an automatic shipping discount at the order level.

**Request:**

```json
{
  "discounts": {
    "codes": ["SUMMER20"]
  }
}
```

**Response:**

```json
{
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "prod_1",
        "quantity": 2,
        "title": "T-Shirt",
        "price": 2000
      },
      "totals": [
        {"type": "subtotal", "amount": 4000},
        {"type": "items_discount", "amount": 800},
        {"type": "total", "amount": 3200}
      ]
    }
  ],
  "discounts": {
    "codes": ["SUMMER20"],
    "applied": [
      {
        "code": "SUMMER20",
        "title": "Summer Sale 20% Off",
        "amount": 800,
        "allocations": [
          {"path": "$.line_items[0]", "amount": 800}
        ]
      },
      {
        "title": "Free shipping on orders over $30",
        "amount": 599,
        "automatic": true
      }
    ]
  },
  "totals": [
    {"type": "subtotal", "display_text": "Subtotal", "amount": 4000},
    {"type": "items_discount", "display_text": "Item Discounts", "amount": 800},
    {"type": "discount", "display_text": "Order Discounts", "amount": 599},
    {"type": "fulfillment", "display_text": "Shipping", "amount": 0},
    {"type": "total", "display_text": "Total", "amount": 2601}
  ]
}
```

### Rejected discount code

When a discount code cannot be applied, the rejection is communicated via the `messages[]` array. The code still appears in `discounts.codes` (echoed back) but not in `discounts.applied`.

**Request:**

```json
{
  "discounts": {
    "codes": ["SAVE10", "EXPIRED50"]
  }
}
```

**Response:**

```json
{
  "discounts": {
    "codes": ["SAVE10", "EXPIRED50"],
    "applied": [
      {
        "code": "SAVE10",
        "title": "$10 Off Your Order",
        "amount": 1000
      }
    ]
  },
  "totals": [
    {"type": "subtotal", "display_text": "Subtotal", "amount": 5000},
    {"type": "discount", "display_text": "Order Discount", "amount": 1000},
    {"type": "total", "display_text": "Total", "amount": 4000}
  ],
  "messages": [
    {
      "type": "warning",
      "code": "discount_code_expired",
      "path": "$.discounts.codes[1]",
      "content": "Code 'EXPIRED50' expired on December 1st"
    }
  ]
}
```

### Stacked discounts with allocations

Multiple discounts applied with full allocation breakdown:

**Response:**

```json
{
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "title": "T-Shirt",
        "price": 6000
      },
      "totals": [
        {"type": "subtotal", "amount": 6000},
        {"type": "items_discount", "amount": 1500},
        {"type": "total", "amount": 4500}
      ]
    },
    {
      "id": "li_2",
      "item": {
        "title": "Socks",
        "price": 4000
      },
      "totals": [
        {"type": "subtotal", "amount": 4000},
        {"type": "items_discount", "amount": 1000},
        {"type": "total", "amount": 3000}
      ]
    }
  ],
  "discounts": {
    "codes": ["SUMMER20", "LOYALTY5"],
    "applied": [
      {
        "code": "SUMMER20",
        "title": "Summer Sale 20% Off",
        "amount": 2000,
        "method": "each",
        "priority": 1,
        "allocations": [
          {"path": "$.line_items[0]", "amount": 1200},
          {"path": "$.line_items[1]", "amount": 800}
        ]
      },
      {
        "code": "LOYALTY5",
        "title": "$5 Loyalty Reward",
        "amount": 500,
        "method": "across",
        "priority": 2,
        "allocations": [
          {"path": "$.line_items[0]", "amount": 300},
          {"path": "$.line_items[1]", "amount": 200}
        ]
      }
    ]
  },
  "totals": [
    {"type": "subtotal", "display_text": "Subtotal", "amount": 10000},
    {"type": "items_discount", "display_text": "Item Discounts", "amount": 2500},
    {"type": "total", "display_text": "Total", "amount": 7500}
  ]
}
```

With this data, an agent can explain:

> "Your T-Shirt ($60) got $12 off from the 20% summer sale, plus $3 from your

# Checkout Capability - EP Binding

## Introduction

Embedded Checkout Protocol (ECP) is a checkout-specific implementation of UCP's Embedded Protocol (EP) transport binding that enables a **host** to embed a **business's** checkout interface, receive events as the buyer interacts with the checkout, and delegate key user actions such as address and payment selection. ECP is a transport binding (like REST)—it defines **how** to communicate, not **what** data exists.

### W3C Payment Request Conceptual Alignment

ECP draws inspiration from the **[W3C Payment Request API](https://www.w3.org/TR/payment-request/)**, adapting its mental model for embedded checkout scenarios. Developers familiar with Payment Request will recognize similar patterns, though the execution model differs:

**W3C Payment Request:** Browser-controlled. The business calls `show()` and the browser renders a native payment sheet. Events flow from the payment handler to the business.

**Embedded Checkout:** Business-controlled. The host embeds the business's checkout UI in an iframe/webview. Events flow bidirectionally, with optional delegation allowing the host to handle specific interactions natively.

| Concept                   | W3C Payment Request              | Embedded Checkout                                                   |
| ------------------------- | -------------------------------- | ------------------------------------------------------------------- |
| **Initialization**        | `new PaymentRequest()`           | Load embedded context with `continue_url`                           |
| **UI Ready**              | `show()` returns Promise         | `ec.start` notification                                             |
| **Payment Method Change** | `paymentmethodchange` event      | `ec.payment.change` notification                                    |
| **Address Change**        | `shippingaddresschange` event    | `ec.fulfillment.change` and `ec.fulfillment.address_change_request` |
| **Submit Payment**        | User accepts → `PaymentResponse` | Delegated `ec.payment.credential_request`                           |
| **Completion**            | `response.complete()`            | `ec.complete` notification                                          |
| **Errors/Messages**       | Promise rejection                | `ec.messages.change` notification                                   |

**Key difference:** In W3C Payment Request, the browser orchestrates the payment flow. In Embedded Checkout, the business orchestrates within the embedded context, optionally delegating specific UI (payment method selection, address picker) to the host for native experiences.

## Terminology & Actors

### Commerce Roles

- **Business:** The seller providing goods/services and the checkout experience.
- **Buyer:** The end user making a purchase.

### Technical Components

- **Host:** The application embedding the checkout (e.g., AI Agent app, Super App, Browser). Responsible for the **Payment Handler** and user authentication.
- **Embedded Checkout:** The business's checkout interface rendered in an iframe or webview. Responsible for the checkout flow and order creation.
- **Payment Handler:** The secure component that performs user authentication (biometric/PIN) and credential issuance.

## Requirements

### Discovery

ECP availability is signaled at two levels: service-level discovery declares capability, checkout responses confirm availability and allowed per-session configuration.

#### Service-Level Discovery

When a business advertises the `embedded` transport in their `/.well-known/ucp` profile, they declare support for the Embedded Checkout Protocol.

**Service Discovery Example:**

```json
{
    "services": {
        "dev.ucp.shopping": [
            {
                "version": "2026-01-11",
                "transport": "rest",
                "schema": "https://ucp.dev/services/shopping/rest.openapi.json",
                "endpoint": "https://merchant.example.com/ucp/v1"
            },
            {
                "version": "2026-01-11",
                "transport": "mcp",
                "schema": "https://ucp.dev/services/shopping/mcp.openrpc.json",
                "endpoint": "https://merchant.example.com/ucp/mcp"
            },
            {
                "version": "2026-01-11",
                "transport": "embedded",
                "schema": "https://ucp.dev/services/shopping/embedded.openrpc.json"
            }
        ]
    }
}
```

When `embedded` is absent from the service definition, the business only supports redirect-based checkout continuation via `continue_url`.

#### Per-Checkout Configuration

Service-level discovery declares that a business supports ECP, but does not guarantee that every checkout session will enable it. Businesses **MUST** include an embedded service binding with `config.delegate` in checkout responses to indicate ECP availability and allowed delegations for a specific session.

**Checkout Response Example:**

```json
{
    "id": "checkout_abc123",
    "status": "open",
    "continue_url": "https://merchant.example.com/checkout/abc123",
    "ucp": {
        "version": "2026-01-11",
        "services": {
            "dev.ucp.shopping": [
                {
                    "version": "2026-01-11",
                    "transport": "embedded",
                    "config": {
                        "delegate": ["payment.credential", "fulfillment.address_change"]
                    }
                }
            ]
        },
        "capabilities": {...},
        "payment_handlers": {...}
    }
}
```

The `config.delegate` array confirms the delegations the business accepted for this checkout session—the intersection of what the host requested via `ec_delegate` and what the business allows. This may vary based on:

- **Cart contents**: Some products may require business-handled payment flows
- **Agent authorization**: Authenticated agents may receive more delegations
- **Business policy**: Risk rules, regional restrictions, etc.

When an embedded service binding with `config.delegate` is present:

- ECP is available for this checkout via `continue_url`
- `config.delegate` confirms which delegations the business accepted
- This mirrors the `delegate` field in the `ec.ready` handshake

When the embedded service binding is absent from a checkout response (even if service-level discovery advertises embedded support), the checkout only supports redirect-based continuation via `continue_url`.

### Loading an Embedded Checkout URL

When a host receives a checkout response with an embedded service binding, it **MAY** initiate an ECP session by loading the `continue_url` in an embedded context.

Before loading the embedded context, the host **SHOULD**:

1. Check `config.delegate` for available delegations
1. Prepare handlers for delegations the host wants to support
1. Optionally prepare authentication credentials if required by the business

To initiate the session, the host **MUST** augment the `continue_url` with ECP query parameters using the `ec_` prefix.

All ECP parameters are passed via URL query string, not HTTP headers, to ensure maximum compatibility across different embedding environments. Parameters use the `ec_` prefix to avoid namespace pollution and clearly distinguish ECP parameters from business-specific query parameters:

- `ec_version` (string, **REQUIRED**): The UCP version for this session (format: `YYYY-MM-DD`). Must match the version from the checkout response.
- `ec_auth` (string, **OPTIONAL**): Authentication token in business-defined format
- `ec_delegate` (string, **OPTIONAL**): Comma-delimited list of delegations the host wants to handle. **SHOULD** be a subset of `config.delegate` from the embedded service binding.

#### Authentication

**Token Format:**

- The `auth` parameter format is entirely business-defined
- Common formats include JWT, OAuth tokens, API keys, or session identifiers
- Businesses **MUST** document their expected token format and validation process

**Example (Informative - JWT-based):**

```json
// One possible implementation using JWT
{
  "alg": "HS256",
  "typ": "JWT"
}
{
  "iat": 1234567890,
  "exp": 1234568190,
  "jti": "unique-id",
  // ... business-specific claims ...
}
```

Businesses **MUST** validate authentication according to their security requirements.

**Example initialization with authentication:**

```text
https://example.com/checkout/abc123?ec_version=2026-01-11&ec_auth=eyJ...
```

Note: All query parameter values must be properly URL-encoded per RFC 3986.

#### Delegation

The optional `ec_delegate` parameter declares which operations the host wants to handle natively, instead of having a buyer handle them in the Embedded Checkout UI. Each delegation identifier maps to a corresponding `_request` message following a consistent pattern: `ec.{delegation}_request`

**Example delegation identifiers:**

| `ec_delegate` value          | Corresponding message                   |
| ---------------------------- | --------------------------------------- |
| `payment.instruments_change` | `ec.payment.instruments_change_request` |
| `payment.credential`         | `ec.payment.credential_request`         |
| `fulfillment.address_change` | `ec.fulfillment.address_change_request` |

Extensions define their own delegation identifiers; see each extension's specification for available options.

```text
?ec_version=2026-01-11&ec_delegate=payment.instruments_change,payment.credential,fulfillment.address_change
```

#### Delegation Negotiation

Delegation follows a narrowing chain from business policy to final acceptance:

```text
config.delegate ⊇ ec_delegate ⊇ ec.ready delegate
```

1. **Business allows** (`config.delegate` in checkout response): The set of delegations the business permits for this checkout session
1. **Host requests** (`ec_delegate` URL parameter): The subset the host wants to handle natively
1. **ECP accepts** (`delegate` in `ec.ready`): The final subset the Embedded Checkout will actually delegate

Each stage is a subset of the previous:

- The host **SHOULD** only request delegations present in `config.delegate`
- The business **SHOULD NOT** accept delegations not present in `config.delegate` and **MUST** confirm accepted delegations in `ec.ready`

### Delegation Contract

Delegation creates a binding contract between the host and Embedded Checkout. However, the Embedded Checkout **MAY** restrict delegation to authenticated or approved hosts based on business policy.

#### Delegation Acceptance

The Embedded Checkout determines which delegations to honor based on:

- Authentication status (via `ec_auth` parameter)
- host authorization level
- Business policy

The Embedded Checkout **MUST** indicate accepted delegations in the `ec.ready` request via the `delegate` field (see [`ec.ready`](#ecready)). If a requested delegation is not accepted, the Embedded Checkout **MUST** handle that capability using its own UI.

#### Binding Requirements

**Once delegation is accepted**, both parties enter a binding contract:

**Embedded Checkout responsibilities:**

1. **MUST** fire the appropriate `{action}_request` message when that action is triggered
1. **MUST** wait for the host's response before proceeding
1. **MUST NOT** show its own UI for that delegated action

**Host responsibilities:**

1. **MUST** respond to every `{action}_request` message it receives
1. **MUST** respond with an appropriate error if the user cancels
1. **SHOULD** show loading/processing states while handling delegation

#### 3.3.3 Delegation Flow

1. **Request**: Embedded Checkout sends an `ec.{capability}.{action}_request` message with current state (includes `id`)
1. **Native UI**: Host presents native UI for the delegated action
1. **Response**: host sends back a JSON-RPC response with matching `id` and `result` or `error`
1. **Update**: Embedded Checkout updates its state and may send subsequent change notifications

See [Payment Extension](#payment-extension) and [Fulfillment Extension](#fulfillment-extension) for capability-specific delegation details.

### Navigation Constraints

When checkout is rendered in embedded mode, the implementation **SHOULD** prevent off-checkout navigation to maintain a focused checkout experience. The embedded view is intended to provide a checkout flow, not a general-purpose browser.

**Navigation Requirements:**

- The embedded checkout **SHOULD** block or intercept navigation attempts to URLs outside the checkout flow
- The embedded checkout **SHOULD** remove or disable UI elements that would navigate away from checkout (e.g., external links, navigation bars)
- The embedder **MAY** implement additional navigation restrictions at the container level

**Permitted Exceptions:** The following navigation scenarios **MAY** be allowed when required for checkout completion:

- Payment provider redirects: off-site payment flows
- 3D Secure verification: card authentication frames and redirects
- Bank authorization: open banking or similar authorization flows
- Identity verification: KYC/AML compliance checks when required

These exceptions **SHOULD** return the user to the checkout flow upon completion.

## Transport & Messaging

### Message Format

All ECP messages **MUST** use JSON-RPC 2.0 format ([RFC 7159](https://datatracker.ietf.org/doc/html/rfc7159)). Each message **MUST** contain:

- `jsonrpc`: **MUST** be `"2.0"`
- `method`: The message name (e.g., `"ec.start"`)
- `params`: Message-specific payload (may be empty object)
- `id`: (Optional) Present only for requests that expect responses

### Message Types

**Requests** (with `id` field):

- Require a response from the receiver
- **MUST** include a unique `id` field
- Receiver **MUST** respond with matching `id`
- Response **MUST** be either a `result` or `error` object
- Used for operations requiring acknowledgment or data

**Notifications** (without `id` field):

- Informational only, no response expected
- **MUST NOT** include an `id` field
- Receiver **MUST NOT** send a response
- Used for state updates and informational events

### Response Handling

For requests (messages with `id`), receivers **MUST** respond with either:

**Success Response:**

```json
{ "jsonrpc": "2.0", "id": "...", "result": {...} }
```

**Error Response:**

```json
{ "jsonrpc": "2.0", "id": "...", "error": {...} }
```

### Communication Channels

#### Communication Channel for Web-Based Hosts

When the host is a web application, communication starts using `postMessage` between the host and Checkout windows. The host **MUST** listen for `postMessage` calls from the embedded window, and when a message is received, they **MUST** validate the origin matches the `checkout_url` used to start the checkout.

Upon validation, the host **MAY** create a `MessageChannel`, and transfer one of its ports in the result of the [`ec.ready` response](#ecready). When a host responds with a `MessagePort`, all subsequent messages **MUST** be sent over that channel. Otherwise, the host and business **MUST** continue using `postMessage()` between their `window` objects, including origin validation.

#### Communication Channel for Native Hosts

When the host is a native application, they MUST inject globals into the Embedded Checkout that allows `postMessage` communication between the web and native environments. The host **MUST** create at least one of the following globals:

- `window.EmbeddedCheckoutProtocolConsumer` (preferred)
- `window.webkit.messageHandlers.EmbeddedCheckoutProtocolConsumer`

This object **MUST** implement the following interface:

```javascript
{
  postMessage(message: string): void
}
```

Where `message` is a JSON-stringified JSON-RPC 2.0 message. The host **MUST** parse the JSON string before processing.

For messages traveling from the host to the Embedded Checkout, the host **MUST** inject JavaScript in the webview that will call `window.EmbeddedCheckoutProtocol.postMessage()` with the JSON RPC message. The Embedded Checkout **MUST** initialize this global object — and start listening for `postMessage()` calls — before the `ec.ready` message is sent.

## Message API Reference

### Message Categories

#### Core Messages

Core messages are defined by the ECP specification and **MUST** be supported by all implementations. All messages are sent from Embedded Checkout to host.

| Category         | Purpose                                                 | Pattern      | Core Messages                                                                        |
| ---------------- | ------------------------------------------------------- | ------------ | ------------------------------------------------------------------------------------ |
| **Handshake**    | Establish connection between host and Embedded Checkout | Request      | `ec.ready`                                                                           |
| **Lifecycle**    | Inform of checkout state transitions                    | Notification | `ec.start`, `ec.complete`                                                            |
| **State Change** | Inform of checkout field changes                        | Notification | `ec.line_items.change`, `ec.buyer.change`, `ec.payment.change`, `ec.messages.change` |

#### Extension Messages

Extensions **MAY** extend the Embedded protocol by defining additional messages. Extension messages **MUST** follow the naming convention:

- **Notifications**: `ec.{capability}.change` — state change notifications (no `id`)
- **Delegation requests**: `ec.{capability}.{action}_request` — requires response (has `id`)

Where:

- `{capability}` matches the capability identifier from discovery
- `{action}` describes the specific action being delegated (e.g., `instruments_change`, `address_change`)
- `_request` suffix signals this is a delegation point requiring a response

### Handshake Messages

#### `ec.ready`

Upon rendering, the Embedded Checkout **MUST** broadcast readiness to the parent context using the `ec.ready` message. This message initializes a secure communication channel between the host and Embedded Checkout, communicates which delegations were accepted, and allows the host to provide additional, display-only state for the checkout that was not communicated over UCP checkout actions.

- **Direction:** Embedded Checkout → host
- **Type:** Request
- **Payload:**
  - `delegate` (array of strings, **REQUIRED**): List of delegation identifiers accepted by the Embedded Checkout. **MUST** be a subset of both `ec_delegate` (what host requested) and `config.delegate` from the checkout response (what business allows). An empty array means no delegations were accepted.

**Example Message (no delegations accepted):**

```json
{
    "jsonrpc": "2.0",
    "id": "ready_1",
    "method": "ec.ready",
    "params": {
        "delegate": []
    }
}
```

**Example Message (delegations accepted):**

```json
{
    "jsonrpc": "2.0",
    "id": "ready_1",
    "method": "ec.ready",
    "params": {
        "delegate": ["payment.credential", "fulfillment.address_change"]
    }
}
```

The `ec.ready` message is a request, which means that the host **MUST** respond to complete the handshake.

- **Direction:** host → Embedded Checkout
- **Type:** Response
- **Result Payload:**
  - `upgrade` (object, **OPTIONAL**): An object describing how the Embedded Checkout should update the communication channel it uses to communicate with the host.
  - `checkout` (object, **OPTIONAL**): Additional, display-only state for the checkout that was not communicated over UCP checkout actions. This is used to populate the checkout UI, and may only be used to populate the following fields, under specific conditions:
    - `payment.instruments`: can be overwritten when the host and Embedded Checkout both accept the `payment.instruments_change` delegation.

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "id": "ready_1",
    "result": {}
}
```

Hosts **MAY** respond with an `upgrade` field to update the communication channel between host and Embedded Checkout. Currently, this object only supports a `port` field, which **MUST** be a `MessagePort` object, and **MUST** be transferred to the embedded checkout context (e.g., with `{transfer: [port2]}` on the host's `iframe.contentWindow.postMessage()` call):

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "id": "ready_1",
    "result": {
        "upgrade": {
            "port": "[Transferable MessagePort]"
        }
    }
}
```

When the host responds with an `upgrade` object, the Embedded Checkout **MUST** discard any other information in the message, send a new `ec.ready` message over the upgraded communication channel, and wait for a new response. All subsequent messages **MUST** be sent only over the upgraded communication channel.

The host **MAY** also respond with a `checkout` object, which will be used to populate the checkout UI according to the delegation contract between host and business.

**Example Message: Providing payment instruments, including display information:**

```json
{
    "jsonrpc": "2.0",
    "id": "ready_1",
    "result": {
        "checkout": {
            "payment": {
                // The instrument structure is defined by the handler's instrument schema
                "instruments": [
                    {
                        "id": "payment_instrument_123",
                        "handler_id": "merchant_psp_handler_123",
                        "type": "card",
                        "selected": true,
                        "display": {
                            "brand": "visa",
                            "expiry_month": 12,
                            "expiry_year": 2026,
                            "last_digits": "1111",
                            "description": "Visa •••• 1111",
                            "card_art": "https://host.com/cards/visa-gold.png"
                        }
                    }
                ]
            }
        }
    }
}
```

### Lifecycle Messages

#### `ec.start`

Signals that checkout is visible and ready for interaction.

- **Direction:** Embedded Checkout → host
- **Type:** Notification
- **Payload:**
  - `checkout`: The latest state of the checkout, using the same structure as the `checkout` object in UCP responses.

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "method": "ec.start",
    "params": {
        "checkout": {
            "id": "checkout_123",
            "status": "incomplete",
            "messages": [
                {
                    "type": "error",
                    "code": "missing",
                    "path": "$.buyer.shipping_address",
                    "content": "Shipping address is required",
                    "severity": "recoverable"
                }
            ],
            "totals": [/* ... */],
            "line_items": [/* ... */],
            "buyer": {/* ... */},
            "payment": {/* ... */}
        }
    }
}
```

#### `ec.complete`

Indicates successful checkout completion.

- **Direction:** Embedded Checkout → host
- **Type:** Notification
- **Payload:**
  - `checkout`: The latest state of the checkout, using the same structure as the `checkout` object in UCP responses.

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "method": "ec.complete",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // ... other checkout fields
            "order": {
                "id": "ord_99887766",
                "permalink_url": "https://merchant.com/orders/ord_99887766"
            }
        }
    }
}
```

### State Change Messages

State change messages inform the embedder of changes that have already occurred in the checkout interface. These are informational only. The checkout has already applied the changes and rendered the updated UI.

#### `ec.line_items.change`

Line items have been modified (quantity changed, items added/removed) in the checkout UI.

- **Direction:** Embedded Checkout → host
- **Type:** Notification
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "method": "ec.line_items.change",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // The entire checkout object is provided, including the updated line items and totals
            "totals": [
                /* ... */
            ],
            "line_items": [
                /* ... */
            ]
            // ...
        }
    }
}
```

#### `ec.buyer.change`

Buyer information has been updated in the checkout UI.

- **Direction:** Embedded Checkout → host
- **Type:** Notification
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "method": "ec.buyer.change",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // The entire checkout object is provided, including the updated buyer information
            "buyer": {
                /* ... */
            }
            // ...
        }
    }
}
```

#### `ec.messages.change`

Checkout messages have been updated. Messages include errors, warnings, and informational notices about the checkout state.

- **Direction:** Embedded Checkout → host
- **Type:** Notification
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "method": "ec.messages.change",
    "params": {
        "checkout": {
            "id": "checkout_123",
            "messages": [
                {
                    "type": "error",
                    "code": "invalid_address",
                    "path": "$.buyer.shipping_address",
                    "content": "We cannot ship to this address",
                    "severity": "recoverable"
                },
                {
                    "type": "info",
                    "code": "free_shipping",
                    "content": "Free shipping applied!"
                }
            ]
            // ...
        }
    }
}
```

#### `ec.payment.change`

Payment state has been updated. See [`ec.payment.change`](#ecpaymentchange) for full documentation.

## Payment Extension

The payment extension defines how a host can use state change notifications and delegation requests to orchestrate user escalation flows. When a checkout URL includes `ec_delegate=payment.instruments_change,payment.credential`, the host gains control over payment method selection and token acquisition, providing state updates to the Embedded Checkout in response.

### Payment Overview & Host Choice

Payment delegation allows for two different patterns of orchestrating the host and Embedded Checkout:

**Option A: Host Delegates to Embedded Checkout** The host does NOT include payment delegation in the URL. The Embedded Checkout handles payment selection and processing using its own UI and payment flows. This is the standard, non-delegated flow.

**Option B: Host Takes Control** The host includes `ec_delegate=payment.instruments_change,payment.credential` in the Checkout URL, informing the Embedded Checkout to delegate payment UI and token acquisition to the host. When delegated:

- **Embedded Checkout responsibilities**:
  - Display current payment method with a change intent (e.g., "Change Payment Method" button)
  - Wait for a response to the `ec.payment.credential_request` message before submitting the payment
- **Host responsibilities**:
  - Respond to the `ec.payment.instruments_change_request` by rendering native UI for the buyer to select alternative payment methods, then respond with the selected method
  - Respond to the `ec.payment.credential_request` by obtaining a payment token for the selected payment method, and sending that token to the Embedded Checkout

### Payment Message API Reference

#### `ec.payment.change`

Informs the host that something has changed in the payment section of the checkout UI, such as a new payment method being selected.

- **Direction:** Embedded Checkout → host
- **Type:** Notification
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "method": "ec.payment.change",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // The entire checkout object is provided, including the updated payment details
            "payment": {
                "instruments": [
                    {
                        "id": "payment_instrument_123",
                        "selected": true
                        /* ... */
                    }
                ]
            }
            // ...
        }
    }
}
```

#### `ec.payment.instruments_change_request`

Requests the host to present payment instrument selection UI.

- **Direction:** Embedded Checkout → host
- **Type:** Request
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "id": "payment_instruments_change_request_1",
    "method": "ec.payment.instruments_change_request",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // The entire checkout object is provided, including the current payment details
            "payment": {
                /* ... */
            }
            // ...
        }
    }
}
```

The host **MUST** respond with either an error, or the newly-selected payment instruments. In successful responses, the host **MUST** respond with a partial update to the `checkout` object, with only the `payment.instruments` field updated. The Embedded Checkout **MUST** treat this update as a PUT-style change by entirely replacing the existing state for the provided fields, rather than attempting to merge the new data with existing state.

- **Direction:** host → Embedded Checkout
- **Type:** Response
- **Payload:**
  - `checkout`: The update to apply to the checkout object

**Example Success Response:**

```json
{
    "jsonrpc": "2.0",
    "id": "payment_instruments_change_request_1",
    "result": {
        "checkout": {
            "payment": {
                // The instrument structure is defined by the handler's instrument schema
                "instruments": [
                    {
                        "id": "payment_instrument_123",
                        "handler_id": "merchant_psp_handler_123",
                        "type": "card",
                        "selected": true,
                        "display": {
                            "brand": "visa",
                            "expiry_month": 12,
                            "expiry_year": 2026,
                            "last_digits": "1111",
                            "description": "Visa •••• 1111",
                            "card_art": "https://host.com/cards/visa-gold.png"
                        }
                        // No `credential` yet; it will be attached in the `ec.payment.credential_request` response
                    }
                ]
            }
        }
    }
}
```

**Example Error Response:**

```json
{
    "jsonrpc": "2.0",
    "id": "payment_instruments_change_request_1",
    "error": {
        "code": "abort_error",
        "message": "User closed the payment sheet without authorizing."
    }
}
```

#### `ec.payment.credential_request`

Requests a credential for the selected payment instrument during checkout submission.

- **Direction:** Embedded Checkout → Host
- **Type:** Request
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "id": "payment_credential_request_1",
    "method": "ec.payment.credential_request",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // The entire checkout object is provided, including the current payment details
            "payment": {
                "instruments": [
                    {
                        "id": "payment_instrument_123",
                        "selected": true
                        /* ... */
                    }
                ]
            }
            // ...
        }
    }
}
```

The host **MUST** respond with either an error, or the credential for the selected payment instrument. In successful responses, the host **MUST** supply a partial update to the `checkout` object, updating the instrument with `selected: true` with the new `credentials` field. The Embedded Checkout **MUST** treat this update as a PUT-style change by entirely replacing the existing state for `payment.instruments`, rather than attempting to merge the new data with existing state.

- **Direction:** host → Embedded Checkout
- **Type:** Response
- **Payload:**
  - `checkout`: The update to apply to the checkout object

**Example Success Response:**

```json
{
    "jsonrpc": "2.0",
    "id": "payment_credential_request_1",
    "result": {
        "checkout": {
            "payment": {
                "instruments": [
                    {
                        "id": "payment_instrument_123",
                        "handler_id": "merchant_psp_handler_123",
                        "type": "card",
                        "selected": true,
                        "display": {
                            "brand": "visa",
                            "expiry_month": 12,
                            "expiry_year": 2026,
                            "last_digits": "1111",
                            "description": "Visa •••• 1111",
                            "card_art": "https://host.com/cards/visa-gold.png"
                        },
                        // The credential structure is defined by the handler's instrument schema
                        "credential": {
                            "type": "token",
                            "token": "tok_123"
                        }
                    }
                ]
            }
        }
    }
}
```

**Example Error Response:**

```json
{
    "jsonrpc": "2.0",
    "id": "payment_credential_request_1",
    "error": {
        "code": "abort_error",
        "message": "User closed the payment sheet without authorizing."
    }
}
```

**Host responsibilities during payment token delegation:**

1. **Confirmation:** Host displays the Trusted Payment UI (Payment Sheet / Biometric Prompt). The host **MUST NOT** silently release a token based solely on the message.
1. **Auth:** host performs User Authorization via the Payment Handler.
1. **AP2 Integration (Optional):** If `ucp.ap2_mandate` is active (see **[AP2 extension](https://ap2-extension.org/)**), the host generates the `payment_mandate` here using trusted user interface.

## Fulfillment Extension

The fulfillment extension defines how a host can delegate address selection to provide a native address picker experience. When a checkout URL includes `ec_delegate=fulfillment.address_change`, the host gains control over shipping address selection, providing address updates to the Embedded Checkout in response.

### Fulfillment Overview & Host Choice

Fulfillment delegation allows for two different patterns:

**Option A: Host Delegates to Embedded Checkout** The host does NOT include fulfillment delegation in the URL. The Embedded Checkout handles address input using its own UI and address forms. This is the standard, non-delegated flow.

**Option B: host Takes Control** The host includes `ec_delegate=fulfillment.address_change` in the Checkout URL, informing the Embedded Checkout to delegate address selection UI to the host. When delegated:

**Embedded Checkout responsibilities**:

- Display current shipping address with a change intent (e.g., "Change Address" button)
- Send `ec.fulfillment.address_change_request` when the buyer triggers address change
- Update shipping options based on the address returned by the host

**Host responsibilities**:

- Respond to the `ec.fulfillment.address_change_request` by rendering native UI for the buyer to select or enter a shipping address
- Respond with the selected address in UCP PostalAddress format

### Fulfillment Message API Reference

#### `ec.fulfillment.change`

Informs the host that the fulfillment details have been changed in the checkout UI.

- **Direction:** Embedded Checkout → Host
- **Type:** Notification
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "method": "ec.fulfillment.change",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // The entire checkout object is provided, including the updated fulfillment details
            "fulfillment": {
                /* ... */
            }
            // ...
        }
    }
}
```

#### `ec.fulfillment.address_change_request`

Requests the host to present address selection UI for a shipping fulfillment method.

- **Direction:** Embedded Checkout → Host
- **Type:** Request
- **Payload:**
  - `checkout`: The latest state of the checkout

**Example Message:**

```json
{
    "jsonrpc": "2.0",
    "id": "fulfillment_address_change_request_1",
    "method": "ec.fulfillment.address_change_request",
    "params": {
        "checkout": {
            "id": "checkout_123",
            // The entire checkout object is provided, including the current fulfillment details
            "fulfillment": {
                "methods": [
                    {
                        "id": "method_1",
                        "type": "shipping",
                        "selected_destination_id": "address_123",
                        "destinations": [
                            {
                                "id": "address_123",
                                "address_street": "456 Old Street"
                                // ...
                            }
                        ]
                        // ...
                    }
                ]
            }
            // ...
        }
    }
}
```

The host **MUST** respond with either an error, or the newly-selected address. In successful responses, the host **MUST** respond with an updated `fulfillment.methods` object, updating the `selected_destination_id` and `destinations` fields for fulfillment methods, and otherwise preserving the existing state. The Embedded Checkout **MUST** treat this update as a PUT-style change by entirely replacing the existing state for `fulfillment.methods`, rather than attempting to merge the new data with existing state.

- **Direction:** host → Embedded Checkout
- **Type:** Response
- **Payload:**
  - `checkout`: The update to apply to the checkout object

**Example Success Response:**

```json
{
    "jsonrpc": "2.0",
    "id": "fulfillment_address_change_request_1",
    "result": {
        "checkout": {
            "fulfillment": {
                "methods": [
                    {
                        "id": "method_1",
                        "type": "shipping",
                        "selected_destination_id": "address_789",
                        "destinations": [
                            {
                                "id": "address_789",
                                "first_name": "John",
                                "last_name": "Doe",
                                "street_address": "123 New Street"
                            }
                        ]
                    }
                ]
            }
        }
    }
}
```

**Example Error Response:**

```json
{
    "jsonrpc": "2.0",
    "id": "fulfillment_address_change_request_1",
    "error": {
        "code": "abort_error",
        "message": "User cancelled address selection."
    }
}
```

### Address Format

The address object uses the UCP [PostalAddress](/draft/specification/checkout/#postal-address) format:

| Name             | Type   | Required | Description                                                                                                                                                                                                                               |
| ---------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extended_address | string | No       | An address extension such as an apartment number, C/O or alternative name.                                                                                                                                                                |
| street_address   | string | No       | The street address.                                                                                                                                                                                                                       |
| address_locality | string | No       | The locality in which the street address is, and which is in the region. For example, Mountain View.                                                                                                                                      |
| address_region   | string | No       | The region in which the locality is, and which is in the country. Required for applicable countries (i.e. state in US, province in CA). For example, California or another appropriate first-level Administrative division.               |
| address_country  | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. |
| postal_code      | string | No       | The postal code. For example, 94043.                                                                                                                                                                                                      |
| first_name       | string | No       | Optional. First name of the contact associated with the address.                                                                                                                                                                          |
| last_name        | string | No       | Optional. Last name of the contact associated with the address.                                                                                                                                                                           |
| phone_number     | string | No       | Optional. Phone number of the contact associated with the address.                                                                                                                                                                        |

## Security & Error Handling

### Error Codes

Responses to delegation request messages from the embedded checkout may resolve to errors. The message responder **SHOULD** use error codes mapped to **[W3C DOMException](https://webidl.spec.whatwg.org/#idl-DOMException)** names where possible.

| Code                  | Description                                                                                                                                    |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| `abort_error`         | The user cancelled the interaction (e.g., closed the sheet).                                                                                   |
| `security_error`      | The host origin validation failed.                                                                                                             |
| `not_supported_error` | The requested payment method is not supported by the host.                                                                                     |
| `invalid_state_error` | Handshake was attempted out of order.                                                                                                          |
| `not_allowed_error`   | The request was missing valid User Activation (see [Prevention of Unsolicited Payment Requests](#prevention-of-unsolicited-payment-requests)). |

### Security for Web-Based Hosts

#### Content Security Policy (CSP)

To ensure security, both parties **MUST** implement appropriate **[Content Security Policy (CSP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)** directives:

- **Business:** **MUST** set `frame-ancestors <host_origin>;` to ensure it's only embedded by trusted hosts.

- **Host:**

  - **Direct Embedding:** If the host directly embeds the business's page, specifying a `frame-src` directive listing every potential business origin can be impractical, especially if there are many businesses. In this scenario, while a strict `frame-src` is ideal, other security measures like those in [Iframe Sandbox Attributes](#iframe-sandbox-attributes) and [Credentialless Iframes](#credentialless-iframes) are critical.
  - **Intermediate Iframe:** The host **MAY** use an intermediate iframe (e.g., on a host-controlled subdomain) to embed the business's page. This offers better control:
    - The host's main page only needs to allow the origin of the intermediate iframe in its `frame-src` (e.g., `frame-src <intermediate_iframe_origin>;`).
    - The intermediate iframe **MUST** implement a strict `frame-src` policy, dynamically set to allow *only* the specific `<merchant_origin>` for the current embedded session (e.g., `frame-src <merchant_origin>;`). This can be set via HTTP headers when serving the intermediate iframe content.

#### Iframe Sandbox Attributes

All business iframes **MUST** be sandboxed to restrict their capabilities. The following sandbox attributes **SHOULD** be applied, but a host and business **MAY** negotiate additional capabilities:

```html
<iframe sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
```

#### Credentialless Iframes

Hosts **SHOULD** use the `credentialless` attribute on the iframe to load it in a new, ephemeral context. This prevents the business from correlating user activity across contexts or accessing existing sessions, protecting user privacy.

```html
<iframe credentialless src="https://business.example.com/checkout"></iframe>
```

#### Strict Origin Validation

Enforce strict validation of the `origin` for all `postMessage` communications between frames.

### Prevention of Unsolicited Payment Requests

**Vulnerability:** A malicious or compromised business could programmatically trigger `ec.payment.credential_request` without user interaction.

**Mitigation (Host-Controlled Execution):** To eliminate this risk, the host is designated as the sole trusted initiator of the payment execution. The host SHOULD display a User Confirmation UI before releasing the token. Silent tokenization is strictly PROHIBITED when the trigger originates from the Embedded Checkout.

## Schema Definitions

The following schemas define the data structures used within the Embedded Checkout protocol and its extensions.

### Checkout

The core object representing the current state of the transaction, including line items, totals, and buyer information.

| Name         | Type                                                                                        | Required | Description                                                                                                                                                                                                                                                     |
| ------------ | ------------------------------------------------------------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Checkout Schema](/draft/specification/checkout/#ucp-response-checkout-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                                                                                                                                         |
| id           | string                                                                                      | **Yes**  | Unique identifier of the checkout session.                                                                                                                                                                                                                      |
| line_items   | Array\[[Line Item Response](/draft/specification/checkout/#line-item-response)\]            | **Yes**  | List of line items being checked out.                                                                                                                                                                                                                           |
| buyer        | [Buyer](/draft/specification/checkout/#buyer)                                               | No       | Representation of the buyer.                                                                                                                                                                                                                                    |
| status       | string                                                                                      | **Yes**  | Checkout state indicating the current phase and required action. See Checkout Status lifecycle documentation for state transition details. **Enum:** `incomplete`, `requires_escalation`, `ready_for_complete`, `complete_in_progress`, `completed`, `canceled` |
| currency     | string                                                                                      | **Yes**  | ISO 4217 currency code reflecting the merchant's market determination. Derived from address, context, and geo IP—buyers provide signals, merchants determine currency.                                                                                          |
| totals       | Array\[[Total Response](/draft/specification/checkout/#total-response)\]                    | **Yes**  | Different cart totals.                                                                                                                                                                                                                                          |
| messages     | Array\[[Message](/draft/specification/checkout/#message)\]                                  | No       | List of messages with error and info about the checkout session state.                                                                                                                                                                                          |
| links        | Array\[[Link](/draft/specification/checkout/#link)\]                                        | **Yes**  | Links to be displayed by the platform (Privacy Policy, TOS). Mandatory for legal compliance.                                                                                                                                                                    |
| expires_at   | string                                                                                      | No       | RFC 3339 expiry timestamp. Default TTL is 6 hours from creation if not sent.                                                                                                                                                                                    |
| continue_url | string                                                                                      | No       | URL for checkout handoff and session recovery. MUST be provided when status is requires_escalation. See specification for format and availability requirements.                                                                                                 |
| payment      | [Payment](/draft/specification/checkout/#payment)                                           | No       | Payment configuration containing handlers.                                                                                                                                                                                                                      |
| order        | [Order Confirmation](/draft/specification/checkout/#order-confirmation)                     | No       | Details about an order created for this checkout session.                                                                                                                                                                                                       |

### Order

The object returned upon successful completion of a checkout, containing confirmation details.

| Name          | Type                                                                               | Required | Description                                                                                                                                  |
| ------------- | ---------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp           | [UCP Response Order Schema](/draft/specification/order/#ucp-response-order-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                      |
| id            | string                                                                             | **Yes**  | Unique order identifier.                                                                                                                     |
| checkout_id   | string                                                                             | **Yes**  | Associated checkout ID for reconciliation.                                                                                                   |
| permalink_url | string                                                                             | **Yes**  | Permalink to access the order on merchant site.                                                                                              |
| line_items    | Array\[[Order Line Item](/draft/specification/order/#order-line-item)\]            | **Yes**  | Immutable line items — source of truth for what was ordered.                                                                                 |
| fulfillment   | object                                                                             | **Yes**  | Fulfillment data: buyer expectations and what actually happened.                                                                             |
| adjustments   | Array\[[Adjustment](/draft/specification/order/#adjustment)\]                      | No       | Append-only event log of money movements (refunds, returns, credits, disputes, cancellations, etc.) that exist independently of fulfillment. |
| totals        | Array\[[Total Response](/draft/specification/order/#total-response)\]              | **Yes**  | Different totals for the order.                                                                                                              |

### Payment

| Name        | Type                                                                                                        | Required | Description                                                                                                                                                                                                                |
| ----------- | ----------------------------------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| instruments | Array\[[Selected Payment Instrument](/draft/specification/embedded-checkout/#selected-payment-instrument)\] | No       | The payment instruments available for this payment. Each instrument is associated with a specific handler via the handler_id field. Handlers can extend the base payment_instrument schema to add handler-specific fields. |

### Payment Instrument

Represents a specific method of payment (e.g., a specific credit card, bank account, or wallet credential) available to the buyer.

| Name            | Type                                                                             | Required | Description                                                                                                                                                  |
| --------------- | -------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| id              | string                                                                           | **Yes**  | A unique identifier for this instrument instance, assigned by the platform.                                                                                  |
| handler_id      | string                                                                           | **Yes**  | The unique identifier for the handler instance that produced this instrument. This corresponds to the 'id' field in the Payment Handler definition.          |
| type            | string                                                                           | **Yes**  | The broad category of the instrument (e.g., 'card', 'tokenized_card'). Specific schemas will constrain this to a constant value.                             |
| billing_address | [Postal Address](/draft/specification/embedded-checkout/#postal-address)         | No       | The billing address associated with this payment method.                                                                                                     |
| credential      | [Payment Credential](/draft/specification/embedded-checkout/#payment-credential) | No       | The base definition for any payment credential. Handlers define specific credential types.                                                                   |
| display         | object                                                                           | No       | Display information for this payment instrument. Each payment instrument schema defines its specific display properties, as outlined by the payment handler. |

### Payment Handler Response

Represents the processor or wallet provider responsible for authenticating and processing a specific payment instrument (e.g., Google Pay, Stripe, or a Bank App).

*No properties defined.*

# Fulfillment Extension

## Overview

The fulfillment extension enables businesses to advertise support for physical goods fulfillment (shipping, pickup, etc).

This extension adds a `fulfillment` field to Checkout containing:

- `methods[]` — fulfillment methods applicable to cart items (shipping, pickup, etc.)
  - `line_item_ids` — which items this method fulfills
  - `destinations[]` — where to fulfill (address, store location)
  - `groups[]` — business-generated packages, each with selectable `options[]`
- `available_methods[]` — inventory availability per item (optional)

**Mental model:**

- `methods[0]` Shipping
  - `line_item_ids` 👕👖
  - `selected_destination_id` = `destinations[0].id` 🔘✅ 123 Fake St
  - `groups[0]` 📦👕👖
    - `selected_option_id` = `options[0].id` 🔘✅ Standard $5
    - `options[1]` 🔘 Express $10
- `methods[1]` Pick Up in Store
  - `line_item_ids` 👞
  - `selected_destination_id` = `destinations[0].id` 🔘✅ Uptown Store
  - `groups[0]` 📦👞
    - `selected_option_id` = `options[0].id` 🔘✅ In-Store Pickup
    - `options[1]` 🔘 Curbside Pickup

## Schema

Fulfillment applies only to items requiring physical delivery. Items not requiring fulfillment (e.g., digital goods) do not need to be assigned to a method.

### Properties

**Error loading extension 'fulfillment_resp':** [Errno 2] No such file or directory: 'source/schemas/shopping/fulfillment_resp.json'

### Entities

#### Fulfillment

| Name              | Type                                                                                                    | Required | Description                         |
| ----------------- | ------------------------------------------------------------------------------------------------------- | -------- | ----------------------------------- |
| methods           | Array\[[Fulfillment Method](/draft/specification/fulfillment/#fulfillment-method)\]                     | No       | Fulfillment methods for cart items. |
| available_methods | Array\[[Fulfillment Available Method](/draft/specification/fulfillment/#fulfillment-available-method)\] | No       | Inventory availability hints.       |

#### Fulfillment Method Response

| Name                    | Type                                                                                          | Required | Description                                                                                                  |
| ----------------------- | --------------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------ |
| id                      | string                                                                                        | **Yes**  | Unique fulfillment method identifier.                                                                        |
| type                    | string                                                                                        | **Yes**  | Fulfillment method type. **Enum:** `shipping`, `pickup`                                                      |
| line_item_ids           | Array[string]                                                                                 | **Yes**  | Line item IDs fulfilled via this method.                                                                     |
| destinations            | Array\[[Fulfillment Destination](/draft/specification/fulfillment/#fulfillment-destination)\] | No       | Available destinations. For shipping: addresses. For pickup: retail locations.                               |
| selected_destination_id | ['string', 'null']                                                                            | No       | ID of the selected destination.                                                                              |
| groups                  | Array\[[Fulfillment Group](/draft/specification/fulfillment/#fulfillment-group)\]             | No       | Fulfillment groups for selecting options. Agent sets selected_option_id on groups to choose shipping method. |

#### Fulfillment Destination Response

This object MUST be one of the following types: [Shipping Destination](/draft/specification/fulfillment/#shipping-destination), [Retail Location](/draft/specification/fulfillment/#retail-location).

#### Shipping Destination Response

| Name             | Type   | Required | Description                                                                                                                                                                                                                               |
| ---------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extended_address | string | No       | An address extension such as an apartment number, C/O or alternative name.                                                                                                                                                                |
| street_address   | string | No       | The street address.                                                                                                                                                                                                                       |
| address_locality | string | No       | The locality in which the street address is, and which is in the region. For example, Mountain View.                                                                                                                                      |
| address_region   | string | No       | The region in which the locality is, and which is in the country. Required for applicable countries (i.e. state in US, province in CA). For example, California or another appropriate first-level Administrative division.               |
| address_country  | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. |
| postal_code      | string | No       | The postal code. For example, 94043.                                                                                                                                                                                                      |
| first_name       | string | No       | Optional. First name of the contact associated with the address.                                                                                                                                                                          |
| last_name        | string | No       | Optional. Last name of the contact associated with the address.                                                                                                                                                                           |
| phone_number     | string | No       | Optional. Phone number of the contact associated with the address.                                                                                                                                                                        |
| id               | string | **Yes**  | ID specific to this shipping destination.                                                                                                                                                                                                 |

#### Retail Location Response

| Name    | Type                                                               | Required | Description                       |
| ------- | ------------------------------------------------------------------ | -------- | --------------------------------- |
| id      | string                                                             | **Yes**  | Unique location identifier.       |
| name    | string                                                             | **Yes**  | Location name (e.g., store name). |
| address | [Postal Address](/draft/specification/fulfillment/#postal-address) | No       | Physical address of the location. |

#### Fulfillment Group Response

| Name               | Type                                                                                | Required | Description                                                            |
| ------------------ | ----------------------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------- |
| id                 | string                                                                              | **Yes**  | Group identifier for referencing merchant-generated groups in updates. |
| line_item_ids      | Array[string]                                                                       | **Yes**  | Line item IDs included in this group/package.                          |
| options            | Array\[[Fulfillment Option](/draft/specification/fulfillment/#fulfillment-option)\] | No       | Available fulfillment options for this group.                          |
| selected_option_id | ['string', 'null']                                                                  | No       | ID of the selected fulfillment option for this group.                  |

#### Fulfillment Option Response

| Name                      | Type                                                      | Required | Description                                                                |
| ------------------------- | --------------------------------------------------------- | -------- | -------------------------------------------------------------------------- |
| id                        | string                                                    | **Yes**  | Unique fulfillment option identifier.                                      |
| title                     | string                                                    | **Yes**  | Short label (e.g., 'Express Shipping', 'Curbside Pickup').                 |
| description               | string                                                    | No       | Complete context for buyer decision (e.g., 'Arrives Dec 12-15 via FedEx'). |
| carrier                   | string                                                    | No       | Carrier name (for shipping).                                               |
| earliest_fulfillment_time | string                                                    | No       | Earliest fulfillment date.                                                 |
| latest_fulfillment_time   | string                                                    | No       | Latest fulfillment date.                                                   |
| totals                    | Array\[[Total](/draft/specification/fulfillment/#total)\] | **Yes**  | Fulfillment option totals breakdown.                                       |

#### Fulfillment Available Method Response

| Name           | Type               | Required | Description                                                                              |
| -------------- | ------------------ | -------- | ---------------------------------------------------------------------------------------- |
| type           | string             | **Yes**  | Fulfillment method type this availability applies to. **Enum:** `shipping`, `pickup`     |
| line_item_ids  | Array[string]      | **Yes**  | Line items available for this fulfillment method.                                        |
| fulfillable_on | ['string', 'null'] | No       | 'now' for immediate availability, or ISO 8601 date for future (preorders, transfers).    |
| description    | string             | No       | Human-readable availability info (e.g., 'Available for pickup at Downtown Store today'). |

#### Total Response

| Name         | Type    | Required | Description                                                                                                                   |
| ------------ | ------- | -------- | ----------------------------------------------------------------------------------------------------------------------------- |
| type         | string  | **Yes**  | Type of total categorization. **Enum:** `items_discount`, `subtotal`, `discount`, `fulfillment`, `tax`, `fee`, `total`        |
| display_text | string  | No       | Text to display against the amount. Should reflect appropriate method (e.g., 'Shipping', 'Delivery').                         |
| amount       | integer | **Yes**  | If type == total, sums subtotal - discount + fulfillment + tax + fee. Should be >= 0. Amount in minor (cents) currency units. |

#### Postal Address

| Name             | Type   | Required | Description                                                                                                                                                                                                                               |
| ---------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extended_address | string | No       | An address extension such as an apartment number, C/O or alternative name.                                                                                                                                                                |
| street_address   | string | No       | The street address.                                                                                                                                                                                                                       |
| address_locality | string | No       | The locality in which the street address is, and which is in the region. For example, Mountain View.                                                                                                                                      |
| address_region   | string | No       | The region in which the locality is, and which is in the country. Required for applicable countries (i.e. state in US, province in CA). For example, California or another appropriate first-level Administrative division.               |
| address_country  | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. |
| postal_code      | string | No       | The postal code. For example, 94043.                                                                                                                                                                                                      |
| first_name       | string | No       | Optional. First name of the contact associated with the address.                                                                                                                                                                          |
| last_name        | string | No       | Optional. Last name of the contact associated with the address.                                                                                                                                                                           |
| phone_number     | string | No       | Optional. Phone number of the contact associated with the address.                                                                                                                                                                        |

### Example

```json
{
  "fulfillment": {
    "methods": [
      {
        "id": "method_1",
        "type": "shipping",
        "line_item_ids": ["shirt", "pants"],
        "selected_destination_id": "dest_1",
        "destinations": [
          {
            "id": "dest_1",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["shirt", "pants"],
            "selected_option_id": "standard",
            "options": [
              {
                "id": "standard",
                "title": "Standard Shipping",
                "description": "Arrives Dec 12-15 via USPS",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express Shipping",
                "description": "Arrives Dec 10-11 via FedEx",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}
```

## Rendering

Fulfillment options are designed for **method-agnostic rendering**. Platforms do not need to understand specific method types (shipping, pickup, etc.) to present options meaningfully. The business provides precomputed, human-readable fields that platforms render directly.

### Human-Readable Fields

| Location              | Field         | Required | Purpose                                                 |
| --------------------- | ------------- | -------- | ------------------------------------------------------- |
| `groups[].options[]`  | `title`       | Yes      | Primary label that distinguishes from siblings          |
| `groups[].options[]`  | `description` | No       | Supplementary context for the title                     |
| `groups[].options[]`  | `total`       | Yes      | Price in minor units (may be null if not yet available) |
| `available_methods[]` | `description` | No       | Standalone explanation of alternative availability      |

### Business Responsibilities

**For `options[].title`:**

- **MUST** distinguish this option from its siblings
- **SHOULD** include method and speed (e.g., "Express Shipping", "Curbside Pickup")
- **MUST** be sufficient for buyer decision if `description` is absent

**For `options[].description`:**

- **MUST NOT** repeat `title` or `total`—provides supplementary context only
- **SHOULD** include timing, carrier, or other decision-relevant details
- **SHOULD** be a complete phrase (e.g., "Arrives Dec 12-15 via FedEx")
- **MAY** be omitted if title is self-explanatory

**For `available_methods[].description`:**

- **MUST** be a standalone sentence explaining what, when, and where
- **SHOULD** be usable verbatim in platform dialogue (e.g., "Pants available for pickup at Downtown Store today at 2pm")

**For ordering:**

- Businesses **SHOULD** return `options[]` in a meaningful order (e.g., cheapest first, fastest first)
- Platforms **SHOULD** render options in the provided order

### Platform Responsibilities

Platforms **SHOULD** treat fulfillment as a generic, renderable structure:

- Render each option as a card using `title`, `description`, and `total`
- Present options in the order provided by the business
- Present all methods returned—method selection is a buyer decision
- Use `available_methods[].description` to surface alternatives to the buyer

Platforms **MAY** provide enhanced UX for recognized method types (store selectors for pickup, carrier logos for shipping), but this is optional. The baseline contract is: **`title` + `description` + `total` is sufficient to render any option.**

When a buyer selects an option the platform cannot fully process, the platform **SHOULD** use `continue_url` to hand off to the business's checkout.

## Available Methods

Available methods indicate whether an item can be fulfilled with a given method, and when. Use cases:

- **Alternative methods**: "These pants are also available for pickup at Downtown Store"
- **Fulfill later**: Preorders, items shipping from a distant warehouse, pickup when store gets inventory

```json
{
  "fulfillment": {
    "methods": [
      {
        "id": "shipping",
        "type": "shipping",
        "line_item_ids": ["shirt", "pants"]
      },
      {
        "id": "pickup",
        "type": "pickup",
        "line_item_ids": []
      }
    ],
    "available_methods": [
      {
        "type": "shipping",
        "line_item_ids": ["shirt", "pants"],
        "fulfillable_on": "now"
      },
      {
        "type": "pickup",
        "line_item_ids": ["pants"],
        "fulfillable_on": "2026-12-01T10:00:00Z",
        "description": "Available for pickup at Downtown Store today at 2pm"
      }
    ]
  }
}
```

The `description` field enables platforms to surface alternatives to buyers:

> 🤖 The shirt and pants ship for $5, arriving in 5-8 days. Or the pants can be picked up at Downtown Store in 4 hours.

If the buyer chooses pickup but the platform doesn't support split fulfillment, the platform **SHOULD** use `continue_url` to hand off to the business's checkout.

## Configuration

Businesses and platforms declare fulfillment constraints in their profiles. Businesses fetch platform profiles to adapt responses accordingly.

### Platform Profile

Platforms declare their rendering capabilities using `platform_schema`:

| Name                 | Type    | Required | Description                         |
| -------------------- | ------- | -------- | ----------------------------------- |
| supports_multi_group | boolean | No       | Enables multiple groups per method. |

Platforms that omit config or set `supports_multi_group: false` receive single-group responses. The response shape is always `methods[].groups[]`—the difference is whether `groups.length` can exceed 1 within each method.

```json
// Default: single group per method
{ "dev.ucp.shopping.fulfillment": [{"version": "2026-01-11"}] }

// Opt-in: business MAY return multiple groups per method
{ "dev.ucp.shopping.fulfillment": [{"version": "2026-01-11", "config": { "supports_multi_group": true }}] }
```

### Business Profile

Businesses declare what fulfillment configurations they support using `merchant_config`:

| Name                       | Type         | Required | Description                                    |
| -------------------------- | ------------ | -------- | ---------------------------------------------- |
| allows_multi_destination   | object       | No       | Permits multiple destinations per method type. |
| allows_method_combinations | Array[array] | No       | Allowed method type combinations.              |

```json
{
  "capabilities": {
    "dev.ucp.shopping.fulfillment": [
      {
        "version": "2026-01-11",
        "config": {
          "allows_multi_destination": {
            "shipping": true
          },
          "allows_method_combinations": [["shipping", "pickup"]]
        }
      }
    ]
  }
}
```

This example says: shipping can go to multiple addresses, and carts can mix shipping+pickup.

### Business Response Behavior

**When `supports_multi_group: false` (default):**

- Business **MUST** consolidate all items into a **single group per method**
- Response still uses array structure: `methods[].groups[]` with `groups.length === 1`
- Business **MAY** still return multiple methods (e.g., shipping + pickup) if cart items require it

**When `supports_multi_group: true`:**

- Business **MAY** return multiple groups per method based on inventory, packaging, or warehouse logic
- Platform is responsible for rendering group selection UI (e.g., choose shipping speed per package)

### Adding New Methods

Extensions that extend fulfillment with new method types (e.g., `local_delivery`) **MUST** add an extension schema that:

1. Adds the method to the `type` enum in `fulfillment_method`
1. Adds corresponding business config options:
   - `allows_multi_destination.local_delivery: boolean`
   - `allows_method_combinations` items enum (includes `"local_delivery"`)

Note: Platform's `supports_multi_group` is method-agnostic (single boolean), so no extension needed.

## Examples

### Basic

**Config:** None required (default behavior)

```json
{
  "fulfillment": {
    "methods": [
      {
        "id": "method_1",
        "type": "shipping",
        "line_item_ids": ["shirt", "pants"],
        "selected_destination_id": "dest_1",
        "destinations": [
          {
            "id": "dest_1",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["shirt", "pants"],
            "selected_option_id": "standard",
            "options": [
              {
                "id": "standard",
                "title": "Standard Shipping",
                "description": "Arrives Dec 12-15 via USPS",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express Shipping",
                "description": "Arrives Dec 10-11 via FedEx",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}
```

### Split Groups

**Config:** Platform profile requires `config.supports_multi_group: true`

Business splits items into multiple packages; buyer selects shipping rate per package.

```json
{
  "fulfillment": {
    "methods": [
      {
        "id": "method_1",
        "type": "shipping",
        "line_item_ids": ["shirt", "pants"],
        "selected_destination_id": "dest_1",
        "destinations": [
          {
            "id": "dest_1",
            "street_address": "123 Main St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["shirt"],
            "selected_option_id": "standard",
            "options": [
              {
                "id": "standard",
                "title": "Standard",
                "totals": [ {"type": "total", "amount": 500} ]
              },
              {
                "id": "express",
                "title": "Express",
                "totals": [ {"type": "total", "amount": 1000} ]
              }
            ]
          },
          {
            "id": "package_2",
            "line_item_ids": ["pants"],
            "selected_option_id": "express",
            "options": [
              {
                "id": "standard",
                "title": "Standard",
                "totals": [ {"type": "total", "amount": 500} ]
              },
              {
                "id": "express",
                "title": "Express",
                "totals": [ {"type": "total", "amount": 1000} ]
              }
            ]
          }
        ]
      }
    ]
  }
}
```

### Split Destinations

**Config:** Business profile requires `config.allows_multi_destination.shipping: true`

Shirt ships to mom (US), pants ship to grandma (Hong Kong). Two methods of the same type, each with its own destination.

```json
{
  "fulfillment": {
    "methods": [
      {
        "id": "method_1",
        "type": "shipping",
        "line_item_ids": ["shirt"],
        "selected_destination_id": "dest_mom",
        "destinations": [
          {
            "id": "dest_mom",
            "street_address": "123 Mom St",
            "address_locality": "Springfield",
            "address_region": "IL",
            "postal_code": "62701",
            "address_country": "US"
          }
        ],
        "groups": [
          {
            "id": "package_1",
            "line_item_ids": ["shirt"],
            "selected_option_id": "standard",
            "options": [
              {
                "id": "standard",
                "title": "Standard",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "id": "method_2",
        "type": "shipping",
        "line_item_ids": ["pants"],
        "selected_destination_id": "dest_grandma",
        "destinations": [
          {
            "id": "dest_grandma",
            "street_address": "88 Queensway",
            "address_locality": "Hong Kong",
            "address_country": "HK"
          }
        ],
        "groups": [
          {
            "id": "package_2",
            "line_item_ids": ["pants"],
            "selected_option_id": "standard",
            "options": [
              {
                "id": "standard",
                "title": "Standard",
                "totals": [
                  {
                    "type": "total",
                    "amount": 500
                  }
                ]
              },
              {
                "id": "express",
                "title": "Express",
                "totals": [
                  {
                    "type": "total",
                    "amount": 1000
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}
```
# Cart Capability

# Cart Capability

- **Capability Name:** `dev.ucp.shopping.cart`
- **Version:** `DRAFT`

## Overview

The Cart capability enables basket building without the complexity of checkout. While [Checkout](https://ucp.dev/draft/specification/checkout/index.md) manages payment handlers, status lifecycle, and order finalization, cart provides a lightweight CRUD interface for item collection before purchase intent is established.

**When to use Cart vs Checkout:**

- **Cart**: User is exploring, comparing, saving items for later. No payment configuration needed. Platform/agent can freely add, remove, update items.
- **Checkout**: User has expressed purchase intent. Payment handlers are configured, status lifecycle begins, session moves toward completion.

The typical flow: `cart session` → `checkout session` → `order`

Carts support:

- **Incremental building**: Add/remove items across sessions
- **Localized estimates**: Context-aware pricing without full checkout overhead
- **Sharing**: `continue_url` enables cart sharing and recovery

## Cart vs Checkout

| Aspect                 | Cart                       | Checkout                               |
| ---------------------- | -------------------------- | -------------------------------------- |
| **Purpose**            | Pre-purchase exploration   | Purchase finalization                  |
| **Payment**            | None                       | Required (handlers, instruments)       |
| **Status**             | Binary (exists/not found)  | Lifecycle (`incomplete` → `completed`) |
| **Complete Operation** | No                         | Yes                                    |
| **Totals**             | Estimates (may be partial) | Final pricing                          |

## Cart-to-Checkout Conversion

When the cart capability is negotiated, platforms can convert a cart to checkout by providing `cart_id` in the Create Checkout request. The cart contents (`line_items`, `context`, `buyer`) initialize the checkout session.

```json
{
  "cart_id": "cart_abc123",
  "line_items": []
}
```

Business MUST use cart contents and MUST ignore overlapping fields in checkout payload. The `cart_id` parameter is only available when the cart capability is advertised in the business profile.

**Idempotent conversion:**

If an incomplete checkout already exists for the given `cart_id`, the business MUST return the existing checkout session rather than creating a new one. This ensures a single active checkout per cart and prevents conflicting sessions.

**Cart lifecycle after conversion:**

When checkout is initialized via `cart_id`, the cart and checkout sessions SHOULD be linked for the duration of the checkout.

- **During active checkout** — Business SHOULD maintain the cart and reflect relevant checkout modifications (quantity changes, item removals) back to the cart. This supports back-to-storefront flows when buyers transition between checkout and storefront.
- **After checkout completion** — Business MAY clear the cart based on TTL, completion of the checkout, or other business logic. Subsequent operations on a cleared cart ID return `NOT_FOUND`; the platform can start a new session with `create_cart`.

## Guidelines

### Platform

- **MAY** use carts for pre-purchase exploration and session persistence.
- **SHOULD** convert cart to checkout when user expresses purchase intent.
- **MAY** display `continue_url` for handoff to business UI.
- **SHOULD** handle `NOT_FOUND` gracefully when cart expires or is canceled.

### Business

- **SHOULD** provide `continue_url` for cart handoff and session recovery.
- TODO: discuss `continue_url` destination - cart vs checkout.
- **SHOULD** provide estimated totals when calculable.
- **MAY** omit fulfillment totals until checkout when address is unknown.
- **SHOULD** return informational messages for validation warnings.
- **MAY** set cart expiry via `expires_at`.
- **SHOULD** follow [cart lifecycle requirements](#cart-to-checkout-conversion) when checkout is initialized via `cart_id`.

## Cart Schema Definition

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

## Operations

The Cart capability defines the following logical operations.

| Operation       | Description                                    |
| --------------- | ---------------------------------------------- |
| **Create Cart** | Creates a new cart session.                    |
| **Get Cart**    | Retrieves the current state of a cart session. |
| **Update Cart** | Updates a cart session.                        |
| **Cancel Cart** | Cancels a cart session.                        |

### Create Cart

Creates a new cart session with line items and optional buyer/context information for localized pricing estimates.

- [REST Binding](https://ucp.dev/draft/specification/cart-rest/#create-cart)
- [MCP Binding](https://ucp.dev/draft/specification/cart-mcp/#create_cart)

### Get Cart

Retrieves the latest state of a cart session. Returns `NOT_FOUND` if the cart does not exist, has expired, or was canceled.

- [REST Binding](https://ucp.dev/draft/specification/cart-rest/#get-cart)
- [MCP Binding](https://ucp.dev/draft/specification/cart-mcp/#get_cart)

### Update Cart

Performs a full replacement of the cart session. The platform **MUST** send the entire cart resource. The provided resource replaces the existing cart state on the business side.

- [REST Binding](https://ucp.dev/draft/specification/cart-rest/#update-cart)
- [MCP Binding](https://ucp.dev/draft/specification/cart-mcp/#update_cart)

### Cancel Cart

Cancels a cart session. Business MUST return the cart state before deletion. Subsequent operations for this cart ID SHOULD return `NOT_FOUND`.

- [REST Binding](https://ucp.dev/draft/specification/cart-rest/#cancel-cart)
- [MCP Binding](https://ucp.dev/draft/specification/cart-mcp/#cancel_cart)

## Entities

Cart reuses the same entity schemas as [Checkout](https://ucp.dev/draft/specification/checkout/index.md). This ensures consistent data structures when converting a cart to a checkout session.

### Line Item

#### Line Item Create Request

**Error:** Schema 'types/line_item.create' not found in any schema directory.

#### Line Item Update Request

**Error:** Schema 'types/line_item.update' not found in any schema directory.

#### Line Item Response

| Name      | Type                                                   | Required | Description                                            |
| --------- | ------------------------------------------------------ | -------- | ------------------------------------------------------ |
| id        | string                                                 | **Yes**  |                                                        |
| item      | [Item](/draft/specification/checkout/#item)            | **Yes**  |                                                        |
| quantity  | integer                                                | **Yes**  | Quantity of the item being purchased.                  |
| totals    | Array\[[Total](/draft/specification/checkout/#total)\] | **Yes**  | Line item totals breakdown.                            |
| parent_id | string                                                 | No       | Parent line item identifier for any nested structures. |

### Buyer

| Name         | Type   | Required | Description              |
| ------------ | ------ | -------- | ------------------------ |
| first_name   | string | No       | First name of the buyer. |
| last_name    | string | No       | Last name of the buyer.  |
| email        | string | No       | Email of the buyer.      |
| phone_number | string | No       | E.164 standard.          |

### Context

| Name            | Type   | Required | Description                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| address_country | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. Optional hint for market context (currency, availability, pricing)—higher-resolution data (e.g., shipping address) supersedes this value. |
| address_region  | string | No       | The region in which the locality is, and which is in the country. For example, California or another appropriate first-level Administrative division. Optional hint for progressive localization—higher-resolution data (e.g., shipping address) supersedes this value.                                                                                                             |
| postal_code     | string | No       | The postal code. For example, 94043. Optional hint for regional refinement—higher-resolution data (e.g., shipping address) supersedes this value.                                                                                                                                                                                                                                   |
| intent          | string | No       | Background context describing buyer's intent (e.g., 'looking for a gift under $50', 'need something durable for outdoor use'). Informs relevance, recommendations, and personalization.                                                                                                                                                                                             |

### Total

| Name         | Type    | Required | Description                                                                                                                   |
| ------------ | ------- | -------- | ----------------------------------------------------------------------------------------------------------------------------- |
| type         | string  | **Yes**  | Type of total categorization. **Enum:** `items_discount`, `subtotal`, `discount`, `fulfillment`, `tax`, `fee`, `total`        |
| display_text | string  | No       | Text to display against the amount. Should reflect appropriate method (e.g., 'Shipping', 'Delivery').                         |
| amount       | integer | **Yes**  | If type == total, sums subtotal - discount + fulfillment + tax + fee. Should be >= 0. Amount in minor (cents) currency units. |

Taxes MAY be included where calculable. Platforms SHOULD assume cart totals are estimates; accurate taxes are computed at checkout.

### Message

This object MUST be one of the following types: [Message Error](/draft/specification/checkout/#message-error), [Message Warning](/draft/specification/checkout/#message-warning), [Message Info](/draft/specification/checkout/#message-info).

#### Message Error

| Name         | Type   | Required | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------------ | ------ | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = error**. Message type discriminator.                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| code         | string | **Yes**  | Error code. Possible values include: missing, invalid, out_of_stock, payment_declined, requires_sign_in, requires_3ds, requires_identity_linking. Freeform codes also allowed.                                                                                                                                                                                                                                                                                                                                 |
| path         | string | No       | RFC 9535 JSONPath to the component the message refers to (e.g., $.items[1]).                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown`                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| content      | string | **Yes**  | Human-readable message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| severity     | string | **Yes**  | Declares who resolves this error. 'recoverable': agent can fix via API. 'requires_buyer_input': merchant requires information their API doesn't support collecting programmatically (checkout incomplete). 'requires_buyer_review': buyer must authorize before order placement due to policy, regulatory, or entitlement rules (checkout complete). Errors with 'requires\_*' severity contribute to 'status: requires_escalation'.* *Enum:*\* `recoverable`, `requires_buyer_input`, `requires_buyer_review` |

#### Message Info

| Name         | Type   | Required | Description                                                    |
| ------------ | ------ | -------- | -------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = info**. Message type discriminator.               |
| path         | string | No       | RFC 9535 JSONPath to the component the message refers to.      |
| code         | string | No       | Info code for programmatic handling.                           |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown` |
| content      | string | **Yes**  | Human-readable message.                                        |

#### Message Warning

| Name         | Type   | Required | Description                                                                                                                           |
| ------------ | ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = warning**. Message type discriminator.                                                                                   |
| path         | string | No       | JSONPath (RFC 9535) to related field (e.g., $.line_items[0]).                                                                         |
| code         | string | **Yes**  | Warning code. Machine-readable identifier for the warning type (e.g., final_sale, prop65, fulfillment_changed, age_restricted, etc.). |
| content      | string | **Yes**  | Human-readable warning message that MUST be displayed.                                                                                |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown`                                                                        |

### Link

| Name  | Type   | Required | Description                                                                                                                                                                                                                          |
| ----- | ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| type  | string | **Yes**  | Type of link. Well-known values: `privacy_policy`, `terms_of_service`, `refund_policy`, `shipping_policy`, `faq`. Consumers SHOULD handle unknown values gracefully by displaying them using the `title` field or omitting the link. |
| url   | string | **Yes**  | The actual URL pointing to the content to be displayed.                                                                                                                                                                              |
| title | string | No       | Optional display text for the link. When provided, use this instead of generating from type.                                                                                                                                         |

# Cart Capability - REST Binding

This document specifies the REST binding for the [Cart Capability](https://ucp.dev/draft/specification/cart/index.md).

## Protocol Fundamentals

### Discovery

Businesses advertise REST transport availability through their UCP profile at `/.well-known/ucp`.

```json
{
  "ucp": {
    "version": "2026-01-15",
    "services": {
      "dev.ucp.shopping": {
        "version": "2026-01-15",
        "spec": "https://ucp.dev/specification/overview",
        "rest": {
          "schema": "https://ucp.dev/services/shopping/rest.openapi.json",
          "endpoint": "https://business.example.com/ucp/v1"
        }
      }
    },
    "capabilities": [
      {
        "name": "dev.ucp.shopping.checkout",
        "version": "2026-01-11",
        "spec": "https://ucp.dev/specification/checkout",
        "schema": "https://ucp.dev/schemas/shopping/checkout.json"
      },
      {
        "name": "dev.ucp.shopping.cart",
        "version": "2026-01-15",
        "spec": "https://ucp.dev/specification/cart",
        "schema": "https://ucp.dev/schemas/shopping/cart.json"
      }
    ]
  }
}
```

### Base URL

All UCP REST endpoints are relative to the business's base URL, which is discovered through the UCP profile at `/.well-known/ucp`. The endpoint for the cart capability is defined in the `rest.endpoint` field of the business profile.

### Content Types

- **Request**: `application/json`
- **Response**: `application/json`

All request and response bodies **MUST** be valid JSON as specified in [RFC 8259](https://tools.ietf.org/html/rfc8259).

### Transport Security

All REST endpoints **MUST** be served over HTTPS with minimum TLS version 1.3.

## Operations

| Operation                   | Method | Endpoint             | Description            |
| --------------------------- | ------ | -------------------- | ---------------------- |
| [Create Cart](#create-cart) | `POST` | `/carts`             | Create a cart session. |
| [Get Cart](#get-cart)       | `GET`  | `/carts/{id}`        | Get a cart session.    |
| [Update Cart](#update-cart) | `PUT`  | `/carts/{id}`        | Update a cart session. |
| [Cancel Cart](#cancel-cart) | `POST` | `/carts/{id}/cancel` | Cancel a cart session. |

### Create Cart

#### Input Schema

**Error:** Schema 'cart.create' not found in any schema directory.

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
POST /carts HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "line_items": [
    {
      "item": {
        "id": "item_123"
      },
      "quantity": 2
    }
  ],
  "context": {
    "address_country": "US",
    "address_region": "CA",
    "postal_code": "94105"
  }
}
```

```json
HTTP/1.1 201 Created
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-15",
    "capabilities": [
      {
        "name": "dev.ucp.shopping.checkout",
        "version": "2026-01-11"
      },
      {
        "name": "dev.ucp.shopping.cart",
        "version": "2026-01-15"
      }
    ]
  },
  "id": "cart_abc123",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "currency": "USD",
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "total",
      "amount": 5000,
      "display_text": "Estimated total (taxes calculated at checkout)"
    }
  ],
  "continue_url": "https://business.example.com/checkout?cart=cart_abc123",
  "expires_at": "2026-01-16T12:00:00Z"
}
```

### Get Cart

#### Input Schema

- `id` (String, required): The cart session ID (path parameter).

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
GET /carts/{id} HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-15",
    "capabilities": [
      {
        "name": "dev.ucp.shopping.checkout",
        "version": "2026-01-11"
      },
      {
        "name": "dev.ucp.shopping.cart",
        "version": "2026-01-15"
      }
    ]
  },
  "id": "cart_abc123",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "currency": "USD",
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "total",
      "amount": 5000
    }
  ],
  "continue_url": "https://business.example.com/checkout?cart=cart_abc123",
  "expires_at": "2026-01-16T12:00:00Z"
}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-15",
    "capabilities": [
      {
        "name": "dev.ucp.shopping.cart",
        "version": "2026-01-15"
      }
    ]
  },
  "messages": [
    {
      "type": "error",
      "code": "NOT_FOUND",
      "content": "Cart not found or has expired"
    }
  ],
  "continue_url": "https://merchant.com/"
}
```

### Update Cart

#### Input Schema

- `id` (String, required): The cart session ID (path parameter).

**Error:** Schema 'cart.update' not found in any schema directory.

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
PUT /carts/{id} HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "id": "cart_abc123",
  "line_items": [
    {
      "item": {
        "id": "item_123"
      },
      "id": "li_1",
      "quantity": 3
    },
    {
      "item": {
        "id": "item_456"
      },
      "id": "li_2",
      "quantity": 1
    }
  ],
  "context": {
    "address_country": "US",
    "address_region": "CA",
    "postal_code": "94105"
  }
}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-15",
    "capabilities": [
      {
        "name": "dev.ucp.shopping.checkout",
        "version": "2026-01-11"
      },
      {
        "name": "dev.ucp.shopping.cart",
        "version": "2026-01-15"
      }
    ]
  },
  "id": "cart_abc123",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 3,
      "totals": [
        {"type": "subtotal", "amount": 7500},
        {"type": "total", "amount": 7500}
      ]
    },
    {
      "id": "li_2",
      "item": {
        "id": "item_456",
        "title": "Blue Jeans",
        "price": 7500
      },
      "quantity": 1,
      "totals": [
        {"type": "subtotal", "amount": 7500},
        {"type": "total", "amount": 7500}
      ]
    }
  ],
  "currency": "USD",
  "totals": [
    {
      "type": "subtotal",
      "amount": 15000
    },
    {
      "type": "total",
      "amount": 15000
    }
  ],
  "continue_url": "https://business.example.com/checkout?cart=cart_abc123",
  "expires_at": "2026-01-16T12:00:00Z"
}
```

### Cancel Cart

#### Input Schema

- `id` (String, required): The cart session ID (path parameter).

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
POST /carts/{id}/cancel HTTP/1.1
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{}
```

```json
HTTP/1.1 200 OK
Content-Type: application/json

{
  "ucp": {
    "version": "2026-01-15",
    "capabilities": [
      {
        "name": "dev.ucp.shopping.checkout",
        "version": "2026-01-11"
      },
      {
        "name": "dev.ucp.shopping.cart",
        "version": "2026-01-15"
      }
    ]
  },
  "id": "cart_abc123",
  "line_items": [
    {
      "id": "li_1",
      "item": {
        "id": "item_123",
        "title": "Red T-Shirt",
        "price": 2500
      },
      "quantity": 2,
      "totals": [
        {"type": "subtotal", "amount": 5000},
        {"type": "total", "amount": 5000}
      ]
    }
  ],
  "currency": "USD",
  "totals": [
    {
      "type": "subtotal",
      "amount": 5000
    },
    {
      "type": "total",
      "amount": 5000
    }
  ],
  "continue_url": "https://business.example.com/checkout?cart=cart_abc123"
}
```

## HTTP Headers

The following headers are defined for the HTTP binding and apply to all operations unless otherwise noted.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

### Specific Header Requirements

- **UCP-Agent**: All requests **MUST** include the `UCP-Agent` header containing the platform profile URI using Dictionary Structured Field syntax ([RFC 8941](https://datatracker.ietf.org/doc/html/rfc8941)). Format: `profile="https://platform.example/profile"`.
- **Idempotency-Key**: Operations that modify state **SHOULD** support idempotency. When provided, the server **MUST**:
  1. Store the key with the operation result for at least 24 hours.
  1. Return the cached result for duplicate keys.
  1. Return `409 Conflict` if the key is reused with different parameters.

## Protocol Mechanics

### Status Codes

| Status Code                 | Description                                                                        |
| --------------------------- | ---------------------------------------------------------------------------------- |
| `200 OK`                    | The request was successful.                                                        |
| `201 Created`               | The cart was successfully created.                                                 |
| `400 Bad Request`           | The request was invalid or cannot be served.                                       |
| `401 Unauthorized`          | Authentication is required and has failed or has not been provided.                |
| `403 Forbidden`             | The request is authenticated but the user does not have the necessary permissions. |
| `409 Conflict`              | The request could not be completed due to a conflict (e.g., idempotent key reuse). |
| `422 Unprocessable Entity`  | The profile content is malformed (discovery failure).                              |
| `424 Failed Dependency`     | The profile URL is valid but fetch failed (discovery failure).                     |
| `429 Too Many Requests`     | Rate limit exceeded.                                                               |
| `500 Internal Server Error` | An unexpected condition was encountered on the server.                             |
| `503 Service Unavailable`   | Temporary unavailability.                                                          |

### Error Responses

See the [Core Specification](https://ucp.dev/draft/specification/overview/#error-handling) for negotiation error handling (discovery failures, negotiation failures).

#### Business Outcomes

Business outcomes (including not found and validation errors) are returned with HTTP 200 and the UCP envelope containing `messages`:

```json
{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.cart": [{"version": "2026-01-11"}]
    }
  },
  "messages": [
    {
      "type": "error",
      "code": "NOT_FOUND",
      "content": "Cart not found or has expired"
    }
  ],
  "continue_url": "https://merchant.com/"
}
```

## Security Considerations

### Authentication

Authentication is optional and depends on business requirements. When authentication is required, the REST transport **MAY** use:

1. **Open API**: No authentication required for public operations.
1. **API Keys**: Via `X-API-Key` header.
1. **OAuth 2.0**: Via `Authorization: Bearer {token}` header, following [RFC 6749](https://tools.ietf.org/html/rfc6749).
1. **Mutual TLS**: For high-security environments.

Businesses **MAY** require authentication for some operations while leaving others open (e.g., public cart without authentication).

# Cart Capability - MCP Binding

This document specifies the Model Context Protocol (MCP) binding for the [Cart Capability](https://ucp.dev/draft/specification/cart/index.md).

## Protocol Fundamentals

### Discovery

Businesses advertise MCP transport availability through their UCP profile at `/.well-known/ucp`.

```json
{
  "ucp": {
    "version": "2026-01-15",
    "services": {
      "dev.ucp.shopping": {
        "version": "2026-01-15",
        "spec": "https://ucp.dev/specification/overview",
        "mcp": {
          "schema": "https://ucp.dev/services/shopping/mcp.openrpc.json",
          "endpoint": "https://business.example.com/ucp/mcp"
        }
      }
    },
    "capabilities": [
      {
        "name": "dev.ucp.shopping.checkout",
        "version": "2026-01-11",
        "spec": "https://ucp.dev/specification/checkout",
        "schema": "https://ucp.dev/schemas/shopping/checkout.json"
      },
      {
        "name": "dev.ucp.shopping.cart",
        "version": "2026-01-15",
        "spec": "https://ucp.dev/specification/cart",
        "schema": "https://ucp.dev/schemas/shopping/cart.json"
      }
    ]
  }
}
```

### Platform Profile Advertisement

MCP clients **MUST** include the UCP platform profile URI with every request. The platform profile is included in the `_meta.ucp` structure within the request parameters:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "create_cart",
  "params": {
    "_meta": {
      "ucp": {
        "profile": "https://platform.example/profiles/v2026-01/shopping-agent.json"
      }
    },
    "idempotency_key": "..."
  }
}
```

The `_meta.ucp.profile` field **MUST** be present in every MCP tool invocation to enable version compatibility checking and capability negotiation.

## Tools

UCP Capabilities map 1:1 to MCP Tools.

### Identifier Pattern

MCP tools separate resource identification from payload data:

- **Requests:** For operations on existing carts (`get`, `update`, `cancel`), a top-level `id` parameter identifies the target resource. The `cart` object in the request payload **MUST NOT** contain an `id` field.
- **Responses:** All responses include `cart.id` as part of the full resource state.
- **Create:** The `create_cart` operation does not require an `id` in the request, and the response includes the newly assigned `cart.id`.

| Tool          | Operation                                                            | Description            |
| ------------- | -------------------------------------------------------------------- | ---------------------- |
| `create_cart` | [Create Cart](https://ucp.dev/draft/specification/cart/#create-cart) | Create a cart session. |
| `get_cart`    | [Get Cart](https://ucp.dev/draft/specification/cart/#get-cart)       | Get a cart session.    |
| `update_cart` | [Update Cart](https://ucp.dev/draft/specification/cart/#update-cart) | Update a cart session. |
| `cancel_cart` | [Cancel Cart](https://ucp.dev/draft/specification/cart/#cancel-cart) | Cancel a cart session. |

### `create_cart`

Maps to the [Create Cart](https://ucp.dev/draft/specification/cart/#create-cart) operation.

#### Input Schema

**Error:** Schema 'cart.create' not found in any schema directory.

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
{
  "jsonrpc": "2.0",
  "method": "create_cart",
  "params": {
    "_meta": {
      "ucp": {
        "profile": "https://platform.example/profiles/v2026-01/shopping-agent.json"
      }
    },
    "idempotency_key": "550e8400-e29b-41d4-a716-446655440000",
    "cart": {
      "line_items": [
        {
          "item": {
            "id": "item_123"
          },
          "quantity": 2
        }
      ],
      "context": {
        "address_country": "US",
        "address_region": "CA",
        "postal_code": "94105"
      }
    }
  },
  "id": 1
}
```

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-15",
      "capabilities": [
        {
          "name": "dev.ucp.shopping.checkout",
          "version": "2026-01-11"
        },
        {
          "name": "dev.ucp.shopping.cart",
          "version": "2026-01-15"
        }
      ]
    },
    "id": "cart_abc123",
    "line_items": [
      {
        "id": "li_1",
        "item": {
          "id": "item_123",
          "title": "Red T-Shirt",
          "price": 2500
        },
        "quantity": 2,
        "totals": [
          {"type": "subtotal", "amount": 5000},
          {"type": "total", "amount": 5000}
        ]
      }
    ],
    "currency": "USD",
    "totals": [
      {
        "type": "subtotal",
        "amount": 5000
      },
      {
        "type": "total",
        "amount": 5000
      }
    ],
    "continue_url": "https://business.example.com/checkout?cart=cart_abc123",
    "expires_at": "2026-01-16T12:00:00Z"
  }
}
```

### `get_cart`

Maps to the [Get Cart](https://ucp.dev/draft/specification/cart/#get-cart) operation.

#### Input Schema

- `id` (String, required): The ID of the cart session.

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
{
  "jsonrpc": "2.0",
  "method": "get_cart",
  "params": {
    "_meta": {
      "ucp": {
        "profile": "https://platform.example/profiles/v2026-01/shopping-agent.json"
      }
    },
    "id": "cart_abc123"
  },
  "id": 1
}
```

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-15",
      "capabilities": [
        {
          "name": "dev.ucp.shopping.checkout",
          "version": "2026-01-11"
        },
        {
          "name": "dev.ucp.shopping.cart",
          "version": "2026-01-15"
        }
      ]
    },
    "id": "cart_abc123",
    "line_items": [
      {
        "id": "li_1",
        "item": {
          "id": "item_123",
          "title": "Red T-Shirt",
          "price": 2500
        },
        "quantity": 2,
        "totals": [
          {"type": "subtotal", "amount": 5000},
          {"type": "total", "amount": 5000}
        ]
      }
    ],
    "currency": "USD",
    "totals": [
      {
        "type": "subtotal",
        "amount": 5000
      },
      {
        "type": "total",
        "amount": 5000
      }
    ],
    "continue_url": "https://business.example.com/checkout?cart=cart_abc123",
    "expires_at": "2026-01-16T12:00:00Z"
  }
}
```

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-15",
      "capabilities": [
        {
          "name": "dev.ucp.shopping.cart",
          "version": "2026-01-15"
        }
      ]
    },
    "messages": [
      {
        "type": "error",
        "code": "NOT_FOUND",
        "content": "Cart not found or has expired"
      }
    ],
    "continue_url": "https://merchant.com/"
  }
}
```

### `update_cart`

Maps to the [Update Cart](https://ucp.dev/draft/specification/cart/#update-cart) operation.

#### Input Schema

- `id` (String, required): The ID of the cart session to update.

**Error:** Schema 'cart.update' not found in any schema directory.

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
{
  "jsonrpc": "2.0",
  "method": "update_cart",
  "params": {
    "_meta": {
      "ucp": {
        "profile": "https://platform.example/profiles/v2026-01/shopping-agent.json"
      }
    },
    "id": "cart_abc123",
    "cart": {
      "line_items": [
        {
          "item": {
            "id": "item_123"
          },
          "quantity": 3
        },
        {
          "item": {
            "id": "item_456"
          },
          "quantity": 1
        }
      ],
      "context": {
        "address_country": "US",
        "address_region": "CA",
        "postal_code": "94105"
      }
    }
  },
  "id": 2
}
```

```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": {
    "ucp": {
      "version": "2026-01-15",
      "capabilities": [
        {
          "name": "dev.ucp.shopping.checkout",
          "version": "2026-01-11"
        },
        {
          "name": "dev.ucp.shopping.cart",
          "version": "2026-01-15"
        }
      ]
    },
    "id": "cart_abc123",
    "line_items": [
      {
        "id": "li_1",
        "item": {
          "id": "item_123",
          "title": "Red T-Shirt",
          "price": 2500
        },
        "quantity": 3,
        "totals": [
          {"type": "subtotal", "amount": 7500},
          {"type": "total", "amount": 7500}
        ]
      },
      {
        "id": "li_2",
        "item": {
          "id": "item_456",
          "title": "Blue Jeans",
          "price": 7500
        },
        "quantity": 1,
        "totals": [
          {"type": "subtotal", "amount": 7500},
          {"type": "total", "amount": 7500}
        ]
      }
    ],
    "currency": "USD",
    "totals": [
      {
        "type": "subtotal",
        "amount": 15000
      },
      {
        "type": "total",
        "amount": 15000
      }
    ],
    "continue_url": "https://business.example.com/checkout?cart=cart_abc123",
    "expires_at": "2026-01-16T12:00:00Z"
  }
}
```

### `cancel_cart`

Maps to the [Cancel Cart](https://ucp.dev/draft/specification/cart/#cancel-cart) operation.

#### Input Schema

- `id` (String, required): The ID of the cart session.
- `idempotency_key` (String, UUID, required): Unique key for retry safety.

#### Output Schema

| Name         | Type                                                                            | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/cart/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                          | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item Response](/draft/specification/cart/#line-item-response)\]    | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/cart/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/cart/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                          | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total Response](/draft/specification/cart/#total-response)\]            | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/cart/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/cart/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                          | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                          | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

#### Example

```json
{
  "jsonrpc": "2.0",
  "method": "cancel_cart",
  "params": {
    "_meta": {
      "ucp": {
        "profile": "https://platform.example/profiles/v2026-01/shopping-agent.json"
      }
    },
    "id": "cart_abc123",
    "idempotency_key": "660e8400-e29b-41d4-a716-446655440001"
  },
  "id": 1
}
```

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-15",
      "capabilities": [
        {
          "name": "dev.ucp.shopping.checkout",
          "version": "2026-01-11"
        },
        {
          "name": "dev.ucp.shopping.cart",
          "version": "2026-01-15"
        }
      ]
    },
    "id": "cart_abc123",
    "line_items": [
      {
        "id": "li_1",
        "item": {
          "id": "item_123",
          "title": "Red T-Shirt",
          "price": 2500
        },
        "quantity": 2,
        "totals": [
          {"type": "subtotal", "amount": 5000},
          {"type": "total", "amount": 5000}
        ]
      }
    ],
    "currency": "USD",
    "totals": [
      {
        "type": "subtotal",
        "amount": 5000
      },
      {
        "type": "total",
        "amount": 5000
      }
    ],
    "continue_url": "https://business.example.com/checkout?cart=cart_abc123"
  }
}
```

## Error Handling

See the [Core Specification](https://ucp.dev/draft/specification/overview/#error-handling) for negotiation error handling (discovery failures, negotiation failures).

### Business Outcomes

Business outcomes (including not found and validation errors) are returned as JSON-RPC `result` with the UCP envelope and `messages`:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "ucp": {
      "version": "2026-01-11",
      "capabilities": {
        "dev.ucp.shopping.cart": [{"version": "2026-01-11"}]
      }
    },
    "messages": [
      {
        "type": "error",
        "code": "NOT_FOUND",
        "content": "Cart not found or has expired"
      }
    ],
    "continue_url": "https://merchant.com/"
  }
}
```

## Conformance

A conforming MCP transport implementation **MUST**:

1. Implement JSON-RPC 2.0 protocol correctly.
1. Provide all core cart tools defined in this specification.
1. Return negotiation failures per the [Core Specification](https://ucp.dev/draft/specification/overview/#error-handling).
1. Return business outcomes as JSON-RPC `result` with UCP envelope and `messages` array.
1. Validate tool inputs against UCP schemas.
1. Support HTTP transport with streaming.
# Order Capability

# Order Capability

- **Capability Name:** `dev.ucp.shopping.order`

## Overview

Orders represent confirmed transactions resulting from a successful checkout submission. It provides a complete record of what was purchased, how it will be delivered, and what has happened since order placement.

### Key Concepts

Orders have three main components:

**Line Items** — what was purchased at checkout:

- Includes current quantity counts (total, fulfilled)

**Fulfillment** — how items get delivered:

- **Expectations** — buyer-facing *promises* about when/how items will arrive
- **Events** (append-only log) — what actually happened (e.g. 👕 was shipped)

**Adjustments** (append-only log) — post-order events independent of fulfillment:

- Typically money movements (refunds, returns, credits, disputes, cancellations)
- Can be any post-order change
- Can happen before, during, or after fulfillment

## Data Model

### Line Items

Line items reflect what was purchased at checkout and their current state:

- Item details (product, price, quantity ordered)
- Quantity counts and status are derived

### Fulfillment

Fulfillment tracks how items are delivered to the buyer.

#### Expectations

**Expectations** are buyer-facing groupings of items (e.g., "package 📦"). They represent:

- What items are grouped together
- Where they're going (`destination`)
- How they're being delivered (`method_type`)
- When they'll arrive (`description`, `fulfillable_on`)

Expectations can be split, merged, or adjusted post-order. For example:

- Group everything by delivery date: "what is coming when"
- Use a single expectation with a wide date range for flexibility
- The goal is **setting buyer expectations** - for the best buyer experience

#### Fulfillment Events

**Fulfillment Events** are an append-only log tracking physical shipments:

- Reference line items by ID and quantity
- Include tracking information
- Type is an open string field - businesses can use any values that make sense (common examples: `processing`, `shipped`, `in_transit`, `delivered`, `failed_attempt`, `canceled`, `undeliverable`, `returned_to_sender`)

### Adjustments

**Adjustments** are an append-only log of events that exist independently of fulfillment:

- Type is an open string field - businesses can use any values that make sense (typically money movements like `refund`, `return`, `credit`, `price_adjustment`, `dispute`, `cancellation`)
- Can be any post-order change
- Optionally link to line items (or order-level for things like shipping refunds)
- Include amount when relevant
- Can happen at any time regardless of fulfillment status

## Schema

### Order

| Name          | Type                                                                               | Required | Description                                                                                                                                  |
| ------------- | ---------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp           | [UCP Response Order Schema](/draft/specification/order/#ucp-response-order-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                      |
| id            | string                                                                             | **Yes**  | Unique order identifier.                                                                                                                     |
| checkout_id   | string                                                                             | **Yes**  | Associated checkout ID for reconciliation.                                                                                                   |
| permalink_url | string                                                                             | **Yes**  | Permalink to access the order on merchant site.                                                                                              |
| line_items    | Array\[[Order Line Item](/draft/specification/order/#order-line-item)\]            | **Yes**  | Immutable line items — source of truth for what was ordered.                                                                                 |
| fulfillment   | object                                                                             | **Yes**  | Fulfillment data: buyer expectations and what actually happened.                                                                             |
| adjustments   | Array\[[Adjustment](/draft/specification/order/#adjustment)\]                      | No       | Append-only event log of money movements (refunds, returns, credits, disputes, cancellations, etc.) that exist independently of fulfillment. |
| totals        | Array\[[Total Response](/draft/specification/order/#total-response)\]              | **Yes**  | Different totals for the order.                                                                                                              |

### Order Line Item

Line items reflect what was purchased at checkout and their current state. Status and quantity counts should reflect the event logs.

| Name      | Type                                                | Required | Description                                                                                                                                                                |
| --------- | --------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id        | string                                              | **Yes**  | Line item identifier.                                                                                                                                                      |
| item      | [Item](/draft/specification/order/#item)            | **Yes**  | Product data (id, title, price, image_url).                                                                                                                                |
| quantity  | object                                              | **Yes**  | Quantity tracking. Both total and fulfilled are derived from events.                                                                                                       |
| totals    | Array\[[Total](/draft/specification/order/#total)\] | **Yes**  | Line item totals breakdown.                                                                                                                                                |
| status    | string                                              | **Yes**  | Derived status: fulfilled if quantity.fulfilled == quantity.total, partial if quantity.fulfilled > 0, otherwise processing. **Enum:** `processing`, `partial`, `fulfilled` |
| parent_id | string                                              | No       | Parent line item identifier for any nested structures.                                                                                                                     |

**Quantity Structure:**

```json
{
  "total": 3,      // Current total quantity
  "fulfilled": 2   // What has been fulfilled
}
```

**Status Derivation:**

```text
if (fulfilled == total) → "fulfilled"
else if (fulfilled > 0) → "partial"
else → "processing"
```

### Expectation

Expectations are buyer-facing groupings representing when/how items will be delivered. They represent the current promise to the buyer and can be split, merged, or adjusted post-order.

| Name           | Type                                                         | Required | Description                                                                                                 |
| -------------- | ------------------------------------------------------------ | -------- | ----------------------------------------------------------------------------------------------------------- |
| id             | string                                                       | **Yes**  | Expectation identifier.                                                                                     |
| line_items     | Array[object]                                                | **Yes**  | Which line items and quantities are in this expectation.                                                    |
| method_type    | string                                                       | **Yes**  | Delivery method type (shipping, pickup, digital). **Enum:** `shipping`, `pickup`, `digital`                 |
| destination    | [Postal Address](/draft/specification/order/#postal-address) | **Yes**  | Delivery destination address.                                                                               |
| description    | string                                                       | No       | Human-readable delivery description (e.g., 'Arrives in 5-8 business days').                                 |
| fulfillable_on | string                                                       | No       | When this expectation can be fulfilled: 'now' or ISO 8601 timestamp for future date (backorder, pre-order). |

### Fulfillment Event

Events are append-only records tracking actual shipments. The `type` field is an open string - businesses can use any values that make sense for their fulfillment process.

| Name            | Type          | Required | Description                                                                                                                                                                                                                                                                                                                             |
| --------------- | ------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id              | string        | **Yes**  | Fulfillment event identifier.                                                                                                                                                                                                                                                                                                           |
| occurred_at     | string        | **Yes**  | RFC 3339 timestamp when this fulfillment event occurred.                                                                                                                                                                                                                                                                                |
| type            | string        | **Yes**  | Fulfillment event type. Common values include: processing (preparing to ship), shipped (handed to carrier), in_transit (in delivery network), delivered (received by buyer), failed_attempt (delivery attempt failed), canceled (fulfillment canceled), undeliverable (cannot be delivered), returned_to_sender (returned to merchant). |
| line_items      | Array[object] | **Yes**  | Which line items and quantities are fulfilled in this event.                                                                                                                                                                                                                                                                            |
| tracking_number | string        | No       | Carrier tracking number (required if type != processing).                                                                                                                                                                                                                                                                               |
| tracking_url    | string        | No       | URL to track this shipment (required if type != processing).                                                                                                                                                                                                                                                                            |
| carrier         | string        | No       | Carrier name (e.g., 'FedEx', 'USPS').                                                                                                                                                                                                                                                                                                   |
| description     | string        | No       | Human-readable description of the shipment status or delivery information (e.g., 'Delivered to front door', 'Out for delivery').                                                                                                                                                                                                        |

Examples: `processing`, `shipped`, `in_transit`, `delivered`, `failed_attempt`, `canceled`, `undeliverable`, `returned_to_sender`, etc.

### Adjustment

Adjustments are polymorphic events that exist independently of fulfillment. The `type` field is an open string - businesses can use any values that make sense to them.

| Name        | Type          | Required | Description                                                                                                                                                                                     |
| ----------- | ------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id          | string        | **Yes**  | Adjustment event identifier.                                                                                                                                                                    |
| type        | string        | **Yes**  | Type of adjustment (open string). Typically money-related like: refund, return, credit, price_adjustment, dispute, cancellation. Can be any value that makes sense for the merchant's business. |
| occurred_at | string        | **Yes**  | RFC 3339 timestamp when this adjustment occurred.                                                                                                                                               |
| status      | string        | **Yes**  | Adjustment status. **Enum:** `pending`, `completed`, `failed`                                                                                                                                   |
| line_items  | Array[object] | No       | Which line items and quantities are affected (optional).                                                                                                                                        |
| amount      | integer       | No       | Amount in minor units (cents) for refunds, credits, price adjustments (optional).                                                                                                               |
| description | string        | No       | Human-readable reason or description (e.g., 'Defective item', 'Customer requested').                                                                                                            |

Examples: `refund`, `return`, `credit`, `price_adjustment`, `dispute`, `cancellation`, etc.

## Example

```json
{
  "ucp": {
    "version": "2026-01-11",
    "capabilities": {
      "dev.ucp.shopping.order": [{"version": "2026-01-11"}]
    }
  },
  "id": "order_abc123",
  "checkout_id": "checkout_xyz789",
  "permalink_url": "https://business.com/orders/abc123",
  "line_items": [
    {
      "id": "li_shoes",
      "item": { "id": "prod_shoes", "title": "Running Shoes", "price": 3000 },
      "quantity": { "total": 3, "fulfilled": 3 },
      "totals": [
        {"type": "subtotal", "amount": 9000},
        {"type": "total", "amount": 9000}
      ],
      "status": "fulfilled"
    },
    {
      "id": "li_shirts",
      "item": { "id": "prod_shirts", "title": "Cotton T-Shirt", "price": 2000 },
      "quantity": { "total": 2, "fulfilled": 0 },
      "totals": [
        {"type": "subtotal", "amount": 4000},
        {"type": "total", "amount": 4000}
      ],
      "status": "processing"
    }
  ],
  "fulfillment": {
    "expectations": [
      {
        "id": "exp_1",
        "line_items": [{ "id": "li_shoes", "quantity": 3 }],
        "method_type": "shipping",
        "destination": {
          "street_address": "123 Main St",
          "address_locality": "Austin",
          "address_region": "TX",
          "address_country": "US",
          "postal_code": "78701"
        },
        "description": "Arrives in 2-3 business days",
        "fulfillable_on": "now"
      },
      {
        "id": "exp_2",
        "line_items": [{ "id": "li_shirts", "quantity": 2 }],
        "method_type": "shipping",
        "destination": {
          "street_address": "123 Main St",
          "address_locality": "Austin",
          "address_region": "TX",
          "address_country": "US",
          "postal_code": "78701"
        },
        "description": "Backordered - ships Jan 15, arrives in 7-10 days",
        "fulfillable_on": "2025-01-15T00:00:00Z"
      }
    ],
    "events": [
      {
        "id": "evt_1",
        "occurred_at": "2025-01-08T10:30:00Z",
        "type": "delivered",
        "line_items": [{ "id": "li_shoes", "quantity": 3 }],
        "tracking_number": "123456789",
        "tracking_url": "https://fedex.com/track/123456789",
        "description": "Delivered to front door"
      }
    ]
  },
  "adjustments": [
    {
      "id": "adj_1",
      "type": "refund",
      "occurred_at": "2025-01-10T14:30:00Z",
      "status": "completed",
      "line_items": [{ "id": "li_shoes", "quantity": 1 }],
      "amount": 3000,
      "description": "Defective item"
    }
  ],
  "totals": [
    { "type": "subtotal", "amount": 13000 },
    { "type": "shipping", "amount": 1200 },
    { "type": "tax", "amount": 1142 },
    { "type": "total", "amount": 15342 }
  ]
}
```

## Events

Businesses send order status changes as events after order placement.

| Event Mechanism                             | Method | Endpoint              | Description                                            |
| ------------------------------------------- | ------ | --------------------- | ------------------------------------------------------ |
| [Order Event Webhook](#order-event-webhook) | `POST` | Platform-provided URL | Business sends order lifecycle events to the platform. |

### Order Event Webhook

Businesses POST order events to a webhook URL provided by the platform during partner onboarding. The URL format is platform-specific.

**Error processing OpenAPI:** [Errno 2] No such file or directory: 'source/services/shopping/rest.openapi.json'

### Webhook URL Configuration

The platform provides its webhook URL in the order capability's `config` field during capability negotiation. The business discovers this URL from the platform's profile and uses it to send order lifecycle events.

| Name        | Type   | Required | Description                                                 |
| ----------- | ------ | -------- | ----------------------------------------------------------- |
| webhook_url | string | **Yes**  | URL where merchant sends order lifecycle events (webhooks). |

**Example:**

```json
{
  "dev.ucp.shopping.order": [
    {
      "version": "2026-01-11",
      "config": {
        "webhook_url": "https://platform.example.com/webhooks/ucp/orders"
      }
    }
  ]
}
```

### Webhook Signature Verification

Webhook payloads **MUST** be signed by the business and verified by the platform to ensure authenticity and integrity.

#### Signing (Business)

1. Select a key from the `signing_keys` array in UCP profile.
1. Create a detached JWT (RFC 7797) over the request body using the selected key.
1. Include the JWT in the `Request-Signature` header.
1. Include the key ID in the JWT header's `kid` claim to allow the receiver to identify which key to use for verification.

#### Verification (Platform)

1. Extract the `Request-Signature` header from the incoming webhook request.
1. Parse the JWT header to retrieve the `kid` (key ID).
1. Fetch the business's UCP profile from `/.well-known/ucp` (cache as appropriate).
1. Locate the key in `signing_keys` with the matching `kid`.
1. Verify the JWT signature against the request body using the public key.
1. If verification fails, reject the webhook with an appropriate error response.

#### Key Rotation

The `signing_keys` array supports multiple keys to enable zero-downtime rotation:

- **Adding a new key:** Add the new key to `signing_keys`, then start signing with it. Verifiers will find it by `kid`.
- **Removing an old key:** After sufficient time for all in-flight webhooks to be delivered, remove the old key from `signing_keys`.

## Guidelines

**Platform:**

- **MUST** respond quickly with a 2xx HTTP status code to acknowledge receipt
- Process events asynchronously after responding

**Business:**

- **MUST** sign all webhook payloads using a key from their `signing_keys` array (published in `/.well-known/ucp`). The signature **MUST** be included in the `Request-Signature` header as a detached JWT (RFC 7797).
- **MUST** send "Order created" event with fully populated order entity
- **MUST** send full order entity on updates (not incremental deltas)
- **MUST** retry failed webhook deliveries
- **MUST** include business identifier in webhook path or headers

## Entities

### Item Response

| Name      | Type    | Required | Description                                                                                                                                                                 |
| --------- | ------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id        | string  | **Yes**  | The product identifier, often the SKU, required to resolve the product details associated with this line item. Should be recognized by both the Platform, and the Business. |
| title     | string  | **Yes**  | Product title.                                                                                                                                                              |
| price     | integer | **Yes**  | Unit price in minor (cents) currency units.                                                                                                                                 |
| image_url | string  | No       | Product image URI.                                                                                                                                                          |

### Postal Address

| Name             | Type   | Required | Description                                                                                                                                                                                                                               |
| ---------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extended_address | string | No       | An address extension such as an apartment number, C/O or alternative name.                                                                                                                                                                |
| street_address   | string | No       | The street address.                                                                                                                                                                                                                       |
| address_locality | string | No       | The locality in which the street address is, and which is in the region. For example, Mountain View.                                                                                                                                      |
| address_region   | string | No       | The region in which the locality is, and which is in the country. Required for applicable countries (i.e. state in US, province in CA). For example, California or another appropriate first-level Administrative division.               |
| address_country  | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. |
| postal_code      | string | No       | The postal code. For example, 94043.                                                                                                                                                                                                      |
| first_name       | string | No       | Optional. First name of the contact associated with the address.                                                                                                                                                                          |
| last_name        | string | No       | Optional. Last name of the contact associated with the address.                                                                                                                                                                           |
| phone_number     | string | No       | Optional. Phone number of the contact associated with the address.                                                                                                                                                                        |

### Response

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |

### Total Response

| Name         | Type    | Required | Description                                                                                                                   |
| ------------ | ------- | -------- | ----------------------------------------------------------------------------------------------------------------------------- |
| type         | string  | **Yes**  | Type of total categorization. **Enum:** `items_discount`, `subtotal`, `discount`, `fulfillment`, `tax`, `fee`, `total`        |
| display_text | string  | No       | Text to display against the amount. Should reflect appropriate method (e.g., 'Shipping', 'Delivery').                         |
| amount       | integer | **Yes**  | If type == total, sums subtotal - discount + fulfillment + tax + fee. Should be >= 0. Amount in minor (cents) currency units. |

### UCP Response Order

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |
| capabilities                                                                                | any  | No       |             |
# Identity Linking Capability

# Identity Linking Capability

- **Capability Name:** `dev.ucp.common.identity_linking`

## Overview

The Identity Linking capability enables a **platform** (e.g., Google, an agentic service) to obtain authorization to perform actions on behalf of a user on a **business**'s site.

This linkage is foundational for commerce experiences, such as accessing loyalty benefits, utilizing personalized offers, managing wishlists, and executing authenticated checkouts.

**This specification leverages [OAuth 2.0](https://datatracker.ietf.org/doc/html/rfc6749)** as the mechanism for securely linking a user's platform account with their business account.

## General guidelines

(In addition to the overarching guidelines)

### For platforms

- **MUST** authenticate using their `client_id` and `client_secret` ([RFC 6749 2.3.1](https://datatracker.ietf.org/doc/html/rfc6749#section-2.3.1)) through HTTP Basic Authentication ([RFC 7617](https://datatracker.ietf.org/doc/html/rfc7617)) when exchanging codes for tokens.
  - **MAY** support Client Metadata
  - **MAY** support Dynamic Client Registration mechanisms to supersede static credential exchange.
- The platform must include the token in the HTTP Authorization header using the Bearer schema (`Authorization: Bearer <access_token>`)
- **MUST** implement the OAuth 2.0 Authorization Code flow ([RFC 6749 4.1](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1)) as the primary linking mechanism.
- **SHOULD** include a unique, unguessable state parameter in the authorization request to prevent Cross-Site Request Forgery (CSRF) ([RFC 6749 10.12](https://datatracker.ietf.org/doc/html/rfc6749#section-10.12)) (part of [OAuth 2.1 draft](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-14#name-preventing-csrf-attacks)) .
- Revocation and security events
  - **SHOULD** call the business's revocation endpoint ([RFC 7009](https://datatracker.ietf.org/doc/html/rfc7009)) when a user initiates an unlink action on the platform side.
  - **SHOULD** support [OpenID RISC Profile 1.0](https://openid.net/specs/openid-risc-1_0-final.html) to handle asynchronous account updates, unlinking events, and cross-account protection.

### For businesses

- **MUST** implement OAuth 2.0 ([RFC 6749](https://datatracker.ietf.org/doc/html/rfc6749))
- **MUST** adhere to [RFC 8414](https://datatracker.ietf.org/doc/html/rfc8414) to declare the location of their OAuth 2.0 endpoints (`/.well-known/oauth-authorization-server`)
  - **SHOULD** implement [RFC 9728](https://datatracker.ietf.org/doc/html/rfc9728/) (HTTP Resource Metadata) to allow platforms to discover the Authorization Server associated with specific resources.
  - **SHOULD** fill in `scopes_supported` as part of [RFC 8414](https://datatracker.ietf.org/doc/html/rfc8414).
- **MUST** enforce Client Authentication at the Token Endpoint.
- **MUST** provide an account creation flow if the user does not already have an account.
- **MUST** support standard UCP scopes, as defined in the Scopes section, granting the tokens permission to all associated Operations for a given resource.
- Additional permissions **MAY** be granted beyond those explicitly requested, provided that the requested scopes are, at minimum, included.
- The platform and business **MAY** define additional custom scopes beyond the minimum scope requirements.
- Revocation and security events
  - **MUST** implement standard Token Revocation as defined in [RFC 7009](https://datatracker.ietf.org/doc/html/rfc7009).
  - **MUST** revoke the specified token and **SHOULD** recursively revoke all associated tokens (e.g., revoking a `refresh_token` **MUST** also immediately revoke all active `access_token`s issued from it).
  - **MUST** support revocation requests authenticated with the same client credentials used for the token endpoint.
  - **SHOULD** support [OpenID RISC Profile 1.0](https://openid.net/specs/openid-risc-1_0-final.html) to enable Cross-Account Protection and securely signal revocation or account state changes initiated by the business side. ([See Cross-Account protection](https://developers.google.com/identity/account-linking/unlinking#cross-account_protection_risc))

## Scopes

We'd ask users to authorize the platform to have access to all the scopes that could be required for UCP, regardless of whether the business supports them.

### Structure

The scope complexity should be hidden in the consent screen shown to the user: they shouldn't see one row for each action, but rather a general one, for example "Allow [platform] to manage checkout sessions".

### Mapping between resources, actions and capabilities

| Resources       | Operation | Scope Action                  |
| --------------- | --------- | ----------------------------- |
| CheckoutSession | Get       | `ucp:scopes:checkout_session` |
| CheckoutSession | Create    | `ucp:scopes:checkout_session` |
| CheckoutSession | Update    | `ucp:scopes:checkout_session` |
| CheckoutSession | Delete    | `ucp:scopes:checkout_session` |
| CheckoutSession | Cancel    | `ucp:scopes:checkout_session` |
| CheckoutSession | Complete  | `ucp:scopes:checkout_session` |

A scope covering a capability must grant access to all operations associated to the capability. For example, ucp:scopes:checkout_session must grant all of: Get, Create, Update, Delete, Cancel, Complete.

## Examples

### Authorization server metadata

Example of [metadata](https://datatracker.ietf.org/doc/html/rfc8414#section-2) supposed to be hosted in /.well-known/oauth-authorization-server as per [RFC 8414](https://datatracker.ietf.org/doc/html/rfc8414):

```json
{
  "issuer": "https://merchant.example.com",
  "authorization_endpoint": "https://merchant.example.com/oauth2/authorize",
  "token_endpoint": "https://merchant.example.com/oauth2/token",
  "revocation_endpoint": "https://merchant.example.com/oauth2/revoke",
  "scopes_supported": [
    "ucp:scopes:checkout_session",
  ],
  "response_types_supported": [
    "code"
  ],
  "grant_types_supported": [
    "authorization_code",
    "refresh_token"
  ],
  "token_endpoint_auth_methods_supported": [
    "client_secret_basic"
  ],
  "service_documentation": "https://merchant.example.com/docs/oauth2"
}
```
# Payment Handlers

# Payment Handler Specification Guide

## Introduction

This guide defines the standard structure and vocabulary for specifying UCP payment handlers. All payment handler specifications **SHOULD** follow this structure to ensure consistency, completeness, and clarity for implementers.

### Purpose

Payment handlers enable "N-to-N" interoperability between platforms, businesses, and payment providers. A well-specified handler must answer these questions for each participant:

- **Who participates?** What participants are involved and what are their roles?
- **What are the prerequisites?** What onboarding or setup is required?
- **How is it configured?** What configuration is advertised or consumed?
- **How is it executed?** What protocol is followed to acquire or process instruments?

This guide provides a framework that ensures every handler specification answers these questions systematically.

### Scope

This guide applies to:

- **Handlers** (e.g., `com.google.pay`, `dev.shopify.shop_pay`) — Specific payment method implementations

______________________________________________________________________

## Core Concepts

Every payment handler specification **MUST** define the core elements below.

**Note on Protocol Signatures:**: The function signatures provided in this section (e.g., `PROCESSING(...)`) represent **logical data flows**, not literal function calls. Spec authors must map these logical flows to the actual transport protocol used by their implementation.

```text
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Payment Handler Framework                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────┐                                                           │
│   │ PARTICIPANTS │  Who participates in this handler?                        │
│   └──────┬───────┘                                                           │
│          │                                                                   │
│          ▼                                                                   │
│   ┌──────────────┐                                                           │
│   │PREREQUISITES │  How does each participant obtain identity & configs?     │
│   └──────┬───────┘                                                           │
│          │                                                                   │
│          ├────────────────────┬──────────────────────┐                       │
│          ▼                    ▼                      ▼                       │
│   ┌──────────────┐    ┌──────────────┐      ┌──────────────┐                 │
│   │   HANDLER    │    │  INSTRUMENT  │      │  PROCESSING  │                 │
│   │ DECLARATION  │    │  ACQUISITION │      │              │                 │
│   └──────────────┘    └──────────────┘      └──────────────┘                 │
│   Business advertises  platform acquires     Participant                     │
│   handler config       checkout instrument   processes instrument            │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Participants

**Definition:** The distinct actors that participate in the payment handler's lifecycle. Every handler has at minimum two participants (business and platform), but **MAY** define additional participants with specific roles.

**Note on Terminology:**: While this guide refers to the participant as the **"Business"**, technical schema fields may retain the standard industry nomenclature **`merchant_*`** (e.g., `merchant_id`, `merchant_name`). Specifications **MUST** explicitly document these field mappings.

**Standard Participants:**

| Participant  | Role                                                               |
| ------------ | ------------------------------------------------------------------ |
| **Business** | Advertises handler configuration, processes payment instruments    |
| **Platform** | Discovers handlers, acquires payment instruments, submits checkout |

**Extended Participants** (example handler-specific participants):

| Participant   | Example Role                                                           |
| ------------- | ---------------------------------------------------------------------- |
| **Tokenizer** | Stores raw credentials and issues token credentials                    |
| **PSP**       | Processes payments on behalf of business using the checkout instrument |

### Prerequisites

**Definition:** The onboarding, setup, or configuration a participant must complete before participating in the handler's flows.

**Signature:**

```text
PREREQUISITES(participant, onboarding_input) → prerequisites_output
```

| Field                  | Description                                                |
| ---------------------- | ---------------------------------------------------------- |
| `participant`          | The participant being onboarded (business, platform, etc.) |
| `onboarding_input`     | What the participant provides during setup                 |
| `prerequisites_output` | The identity and any additional configuration received     |

**Prerequisites Output:**

The `prerequisites_output` contains what a participant receives from onboarding. At minimum, this includes an **identity** (see [Payment Identity](https://ucp.dev/schemas/shopping/types/payment_identity.json)). It **MAY** also include additional configuration, credentials, or settings specific to the handler.

Payment handler specifications **are not required** to define a formal schema for `prerequisites_output`. Instead, the specification **SHOULD** clearly document:

- What identity is assigned (and how it maps to `PaymentIdentity`)
- What additional configuration is provided
- How the prerequisites output is used in Handler Declaration, Instrument Acquisition, or Processing

**Notes:**

- Prerequisites typically occur out-of-band (portals, contracts, API calls)
- Multiple participants **MAY** have independent prerequisites
- The identity from prerequisites typically appears within the handler's `config` object (e.g., as `merchant_id` or similar handler-specific field)
- Participants receiving raw credentials (e.g., businesses, PSPs) typically must complete security acknowledgements during onboarding, accepting responsibility for credential handling and compliance

### Handler Declaration

**Definition:** The configuration a business advertises to indicate support for this handler and enable platforms to invoke it.

**Signature:**

```text
HANDLER_DECLARATION(prerequisites_output) → handler_declaration
```

| Field                  | Description                                                |
| ---------------------- | ---------------------------------------------------------- |
| `prerequisites_output` | The identity and configuration from business prerequisites |
| `handler_declaration`  | The handler object advertised in `ucp.payment_handlers`    |

**Output Structure:**

The handler declaration conforms to the [`PaymentHandler`](https://ucp.dev/schemas/payment_handler.json) schema. The specification **SHOULD** define the available config and instrument schemas, and how to construct each based on the business's prerequisites output and desired configuration.

```json
{
  "ucp": {
    "payment_handlers": {
      "com.example.handler": [
        {
          "id": "processor_tokenizer_1234",
          "version": "2026-01-11",
          "spec": "https://example.com/ucp/handler",
          "schema": "https://example.com/ucp/handler/schema.json",
          "config": {
            // Handler-specific configuration (see 2.3.1)
          }
        }
      ]
    }
  }
}
```

______________________________________________________________________

#### Handler Declaration Variants

The `PaymentHandler` schema defines three variants for different contexts. While only `id` and `version` are technically required, each variant serves a distinct purpose and typically includes different configuration:

| Variant             | Context                                 | Purpose                                                                                                                                                                                             |
| ------------------- | --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **business_schema** | Business discovery (`/.well-known/ucp`) | Declares the business identity and how they're configured for this handler. Contains merchant-specific settings.                                                                                    |
| **platform_schema** | Platform profile (advertised URI)       | Declares the platform identity and how it supports this handler. Includes `spec` and `schema` URLs for implementers.                                                                                |
| **response_schema** | Checkout/Order API responses            | **Runtime configuration** with merged context: merchant identity, available payment methods, tokenization specs, and other state needed to process the transaction. Often the richest of the three. |

**Business Schema Example** (business declares handler configuration):

```json
{
  "id": "processor_tokenizer_1234",
  "version": "2026-01-11",
  "spec": "https://example.com/ucp/handler",
  "schema": "https://example.com/ucp/handler/schema.json",
  "config": {
    "environment": "production",
    "business_id": "business_xyz_789"
  }
}
```

**Platform Schema Example** (platform declares handler support):

```json
{
  "id": "platform_tokenizer_2345", // note: ids are for disambiguation, they may differ between business and platform
  "version": "2026-01-11",
  "spec": "https://example.com/ucp/handler",
  "schema": "https://example.com/ucp/handler/schema.json",
  "config": {
    "environment": "production",
    "platform_id": "platform_abc_123"
  }
}
```

**Response Schema Example** (runtime context for checkout):

```json
{
  "id": "processor_tokenizer_1234",
  "version": "2026-01-11",
  "config": {
    "api_version": 2,
    "environment": "production",
    "business_id": "business_xyz_789",
    "available_instruments": [
      {
        "type": "token_alt",
        "tokenization_specification": {
          "type": "merchant_gateway"
        }
      }
    ]
  }
}
```

______________________________________________________________________

#### Defining the Schema

The `schema` field points to a JSON schema that defines handler-specific shapes. Authors typically define each shape in its own file and reference them:

- **Config** — Configuration for platform/business declarations and runtime responses
- **Instrument** — The payment instrument structure returned to platforms
- **Credential** — The credential structure within instruments

**Example Handler Schema:**

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/schema.json",
  "title": "Tokenizer Handler Schema",
  "description": "Schema for the com.example.tokenizer payment handler.",
  "name": "com.example.tokenizer",
  "version": "2026-01-11",

  "$defs": {
    "tokenizer_token": { "$ref": "types/tokenizer_token.json" },
    "tokenizer_alt_token": { "$ref": "types/tokenizer_alt_token.json" },

    "tokenizer_instrument": { "$ref": "types/tokenizer_instrument.json" },
    "tokenizer_alt_instrument": { "$ref": "types/tokenizer_alt_instrument.json" },

    "com.example.tokenizer": {
      "payment_instrument": {
        "title": "Tokenizer Payment Instrument",
        "description": "Any instrument type supported by this handler.",
        "oneOf": [
          { "$ref": "#/$defs/tokenizer_instrument" },
          { "$ref": "#/$defs/tokenizer_alt_instrument" }
        ]
      },
      "platform_schema": {
        "title": "Tokenizer (Platform)",
        "description": "Platform-level handler configuration for discovery.",
        "allOf": [
          { "$ref": "https://ucp.dev/schemas/payment_handler.json#/$defs/platform_schema" },
          {
            "properties": {
              "config": {
                "$ref": "types/platform_config.json",
                "description": "Platform configuration for this handler."
              }
            }
          }
        ]
      },
      "business_schema": {
        "title": "Tokenizer (Business)",
        "description": "Business-level handler configuration for discovery.",
        "allOf": [
          { "$ref": "https://ucp.dev/schemas/payment_handler.json#/$defs/business_schema" },
          {
            "properties": {
              "config": {
                "$ref": "types/business_config.json",
                "description": "Business configuration for this handler."
              }
            }
          }
        ]
      },
      "response_schema": {
        "title": "Tokenizer (Response)",
        "description": "Runtime handler configuration in checkout responses.",
        "allOf": [
          { "$ref": "https://ucp.dev/schemas/payment_handler.json#/$defs/response_schema" },
          {
            "properties": {
              "config": {
                "$ref": "types/response_config.json",
                "description": "Runtime configuration for this handler."
              }
            }
          }
        ]
      }
    }
  }
}
```

______________________________________________________________________

#### Config Shapes

Each variant has its own config schema tailored to its context:

| Variant             | Config File                  | Purpose                                                               |
| ------------------- | ---------------------------- | --------------------------------------------------------------------- |
| **business_schema** | `types/business_config.json` | Business identity and merchant-specific settings                      |
| **platform_schema** | `types/platform_config.json` | Platform identity and platform-level settings                         |
| **response_schema** | `types/response_config.json` | Full runtime state: identities, available methods, tokenization specs |

**Example `types/business_config.json`:**

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/types/business_config.json",
  "title": "Tokenizer Business Config",
  "type": "object",
  "properties": {
    "environment": {
      "type": "string",
      "enum": ["sandbox", "production"],
      "default": "production"
    },
    "business_id": {
      "type": "string",
      "description": "Business identifier for this handler."
    }
  }
}
```

**Example `types/platform_config.json`:**

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/types/platform_config.json",
  "title": "Tokenizer Platform Config",
  "type": "object",
  "properties": {
    "environment": {
      "type": "string",
      "enum": ["sandbox", "production"],
      "default": "production"
    },
    "platform_id": {
      "type": "string",
      "description": "Platform identifier for this handler."
    }
  }
}
```

**Example `types/response_config.json`:**

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/types/response_config.json",
  "title": "Tokenizer Response Config",
  "type": "object",
  "properties": {
    "api_version": { "type": "integer" },
    "environment": {
      "type": "string",
      "enum": ["sandbox", "production"]
    },
    "business_id": {
      "type": "string",
      "description": "Business identifier for this handler."
    },
    "available_instruments": {
      "type": "array",
      "description": "Available instrument types for this checkout.",
      "items": {
        "type": "object",
        "properties": {
          "type": { "type": "string" },
          "tokenization_specification": { "type": "object" }
        }
      }
    }
  }
}
```

______________________________________________________________________

#### Instrument Shapes

**Base Instrument Schemas:**

| Schema                                                                                                | Description                                                      |
| ----------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| [`payment_instrument.json`](https://ucp.dev/schemas/shopping/types/payment_instrument.json)           | Base: id, handler_id, type, billing_address, credential, display |
| [`card_payment_instrument.json`](https://ucp.dev/schemas/shopping/types/card_payment_instrument.json) | Extends base with display: brand, last_digits, expiry, card art  |

UCP provides base schemas for universal payment instruments like `card`. Spec authors **MAY** extend any of the base instruments to add handler-specific display data or customize the credential reference. Handlers **MAY** define multiple instrument types for different payment flows.

**Example `types/tokenizer_instrument.json`** (card-based):

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/types/tokenizer_instrument.json",
  "title": "Tokenizer Card Instrument",
  "description": "Card-based payment instrument for com.example.tokenizer.",
  "allOf": [
    { "$ref": "https://ucp.dev/schemas/shopping/types/card_payment_instrument.json" }
  ],
  "type": "object",
  "required": ["type"],
  "properties": {
    "type": { "const": "tokenizer_card" },
    "credential": {
      "oneOf": [
        { "$ref": "tokenizer_token.json" },
        { "$ref": "tokenizer_alt_token.json" }
      ]
    },
    "special_tokenizer_context": {
      "type": "object",
      "description": "Handler-specific context for tokenizer instruments."
    }
  }
}
```

**Example `types/tokenizer_alt_instrument.json`:**

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/types/tokenizer_alt_instrument.json",
  "title": "Tokenizer Alt Instrument",
  "description": "Alternative payment instrument for com.example.tokenizer.",
  "allOf": [
    { "$ref": "https://ucp.dev/schemas/shopping/types/payment_instrument.json" }
  ],
  "type": "object",
  "required": ["type"],
  "properties": {
    "type": { "const": "tokenizer_alt" },
    "credential": {
      "oneOf": [
        { "$ref": "tokenizer_token.json" },
        { "$ref": "tokenizer_alt_token.json" }
      ]
    },
    "special_tokenizer_context": {
      "type": "object",
      "description": "Handler-specific context for tokenizer instruments."
    }
  }
}
```

______________________________________________________________________

#### Credential Shapes

**Base Credential Schemas:**

| Schema                                                                                      | Description                   |
| ------------------------------------------------------------------------------------------- | ----------------------------- |
| [`payment_credential.json`](https://ucp.dev/schemas/shopping/types/payment_credential.json) | Base: type discriminator only |
| [`token_credential.json`](https://ucp.dev/schemas/shopping/types/token_credential.json)     | Token: type + token string    |

UCP provides base schemas for universal payment credentials. Authors **MAY** extend these schemas to include handler-specific credential context. Handlers **MAY** define multiple credential types for different instrument flows.

The specification **MUST** define which credential types are accepted by the handler.

**Important:** If using token credentials, the schema **MUST** include an expiration field (`expiry`, `ttl`, or similar) to ensure platforms know when to refresh credentials.

**Example `types/tokenizer_token.json`** (expiring token):

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/types/tokenizer_token.json",
  "title": "Tokenizer Card Token",
  "description": "Card token credential for com.example.tokenizer.",
  "allOf": [
    { "$ref": "https://ucp.dev/schemas/shopping/types/token_credential.json" }
  ],
  "type": "object",
  "required": ["type", "token", "expiry"],
  "properties": {
    "type": {
      "const": "tokenizer_card_token",
      "description": "Credential type discriminator."
    },
    "expiry": {
      "type": "string",
      "format": "date-time",
      "description": "Token expiration. Platforms must refresh before this time."
    }
  }
}
```

**Example `types/tokenizer_alt_token.json`** (alt token):

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/ucp/handlers/tokenizer/types/tokenizer_alt_token.json",
  "title": "Tokenizer Alt Token",
  "description": "Alt token credential for com.example.tokenizer, adding routing hints",
  "allOf": [
    { "$ref": "https://ucp.dev/schemas/shopping/types/token_credential.json" }
  ],
  "type": "object",
  "required": ["type", "token", "expiry"],
  "properties": {
    "type": {
      "const": "tokenizer_alt_token",
      "description": "Credential type discriminator."
    },
    "expiry": {
      "type": "string",
      "format": "date-time",
      "description": "Token expiration. Platforms must refresh before this time."
    },
    "routing_hint": {
      "type": "string",
      "description": "Optional routing number hint."
    }
  }
}
```

### Instrument Acquisition

**Definition:** The protocol a platform follows to acquire a payment instrument that can be submitted to the business's checkout.

**Signature:**

```text
INSTRUMENT_ACQUISITION(
  platform_prerequisites_output,
  handler_declaration,
  binding,
  buyer_input
) → checkout_instrument
```

| Field                           | Description                                                              |
| ------------------------------- | ------------------------------------------------------------------------ |
| `platform_prerequisites_output` | platform's prerequisites output (config), if prerequisites were required |
| `handler_declaration.config`    | Handler-specific configuration from the business                         |
| `binding`                       | **(See 2.6)** Context for binding the credential to a specific checkout  |
| `buyer_input`                   | Buyer's payment selection or credentials                                 |
| `checkout_instrument`           | The payment instrument to submit at checkout                             |

Payment handler specifications do NOT need to define a formal process for instrument acquisition. Instead, the specification **SHOULD** clearly document:

- How to apply the handler's `config` to construct a valid `checkout_instrument`.
- How to create an effective credential binding to the specific checkout and business for usage, which is critical for security, based on the available `config` and `checkout`.

### Processing

**Definition:** The steps a participant (typically business or PSP) takes to process a received payment instrument and complete the transaction.

**Signature:**

```text
PROCESSING(
  identity,
  checkout_instrument,
  binding,
  transaction_context
) → processing_result
```

| Field                 | Description                                    |
| --------------------- | ---------------------------------------------- |
| `identity`            | The processing participant's `PaymentIdentity` |
| `checkout_instrument` | The instrument received from the platform      |
| `binding`             | The binding context for verification           |
| `transaction_context` | Checkout totals, line items, etc.              |
| `processing_result`   | Success/failure with payment details           |

#### Error Handling

The specification **MUST** define a mapping for common failures (e.g., 'Declined', 'Insufficient Funds', 'Network Error') to standard UCP Error definitions. This ensures the platform can render localized, consistent error messages to the buyer regardless of the underlying processor.

### Key Definitions

| Term        | Definition                                                                                                                                                                                                                                    |
| ----------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Binding** | A cryptographic or logical association of a payment instrument to a specific checkout transaction and business identity. This prevents replay attacks where a valid credential intended for Business A is intercepted and used at Business B. |

______________________________________________________________________

## Specification Template

Handler specifications **SHOULD** use the standard template structure. Sections marked **[REQUIRED]** **MUST** be present; sections marked **[CONDITIONAL]** are required only when applicable.

**→ [Payment Handler Template](https://ucp.dev/draft/specification/payment-handler-template/index.md)**

## Conformance Checklist for Spec Authors

Before publishing a payment handler specification, verify:

### Structure

- Uses the standard template structure
- All [REQUIRED] sections are present
- [CONDITIONAL] sections are present when applicable

### Participants

- All participants are listed
- Each participant's role is clearly described
- Note on "Business" vs "Merchant" terminology added if applicable

### Prerequisites

- Prerequisites process is documented for each participant that requires it
- Onboarding inputs are specified
- Prerequisites output is described (identity + any additional config)
- Identity maps to `PaymentIdentity` structure (`access_token`)

### Handler Declaration

- Identity schema is documented (base or extended)
- Configuration schema is documented (if applicable) and includes environment
- Instrument schema is documented (base or extended)

### Instrument Acquisition

- Protocol steps are enumerated and clear
- Logical flow is mapped to actual protocol
- API calls or SDK usage is shown with examples
- Binding requirements are specified
- Checkout Payment Instrument creation and shape is well-defined

### Processing

- Processing steps are enumerated and clear
- Verification requirements are specified
- Error handling and mapping is addressed

### Security

- Security requirements are listed
- Binding verification is required
- Credential handling guidance is provided
- Token expiry is defined (if applicable)

### General

- Handler name follows reverse-DNS convention
- Version follows YYYY-MM-DD format
- All schema URLs match namespace authority
- References section includes all schemas

______________________________________________________________________

## Best Practices

Follow these guidelines to create high-quality, maintainable handler specifications:

### Schema Design

| Practice                         | Description                                                                             |
| -------------------------------- | --------------------------------------------------------------------------------------- |
| **Extend, don't reinvent**       | Use `allOf` to compose base schemas. Don't redefine `brand`, `last_digits`, etc.        |
| **Use const for discriminators** | Define `credential.type` as a `const` to identify credential types unambiguously.       |
| **Validate early**               | Publish schemas at stable URLs before finalizing the spec so implementers can validate. |
| **Include Expiry**               | When designing token credentials, always include `expiry` or `ttl`.                     |

### Documentation

| Practice                  | Description                                                            |
| ------------------------- | ---------------------------------------------------------------------- |
| **Show, don't just tell** | Include complete JSON examples for every schema and protocol step.     |
| **Document error cases**  | Specify what errors can occur and how participants should handle them. |
| **Version independently** | The handler version evolves independently of UCP core versions.        |

### Security

| Practice                         | Description                                                                    |
| -------------------------------- | ------------------------------------------------------------------------------ |
| **Require binding**              | Always tie credentials to a specific checkout via `binding`.                   |
| **Minimize credential exposure** | Design flows so raw credentials (PANs, etc.) touch as few systems as possible. |
| **Specify token lifetimes**      | Document whether tokens are single-use, time-limited, or session-scoped.       |

### Maintainability

| Practice                        | Description                                                                                                                                      |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Host schemas at stable URLs** | Schema URLs should not change; use versioned paths if needed.                                                                                    |
| **Fail gracefully**             | Define clear error responses for common failure scenarios.                                                                                       |
| **Link to examples**            | Reference existing handler specs and the [Tokenization Guide](https://ucp.dev/draft/specification/tokenization-guide/index.md) for common flows. |

______________________________________________________________________

## See Also

- **[Tokenization Guide](https://ucp.dev/draft/specification/tokenization-guide/index.md)** — Guide for building tokenization payment handlers
- **[Google Pay Handler](https://developers.google.com/merchant/ucp/guides/google-pay-payment-handler)** — Handler for Google Pay integration
- **[Shop Pay Handler](https://shopify.dev/docs/agents/checkout/shop-pay-handler)** — Handler for Shop Pay integration

# {Handler Name} Payment Handler

- **Handler Name:** `{reverse-dns.name}`
- **Version:** `{YYYY-MM-DD}`

## Introduction

{Brief description of what this handler enables and the payment flow it supports.}

### Key Benefits

- {Benefit 1}
- {Benefit 2}
- {Benefit 3}

### Integration Guide

| Participant  | Integration Section                           |
| ------------ | --------------------------------------------- |
| **Business** | [Business Integration](#business-integration) |
| **Platform** | [Platform Integration](#platform-integration) |

______________________________________________________________________

## Participants

{Describe all participants in this handler and their roles.}

> **Note on Terminology:** While this specification refers to the participant as the **"business,"** technical schema fields may retain the standard industry nomenclature **`merchant_*`** (e.g., `merchant_id`). Mappings are documented below.

| Participant             | Role               | Prerequisites                |
| ----------------------- | ------------------ | ---------------------------- |
| **Business**            | {role description} | {Yes/No — brief description} |
| **Platform**            | {role description} | {Yes/No — brief description} |
| **{Other Participant}** | {role description} | {Yes/No — brief description} |

{Optional: ASCII diagram showing participant relationships}

```text
┌─────────┐     ┌───────────────┐     ┌────────────┐
│Platform │     │   {Provider}  │     │  Business  │
└────┬────┘     └───────┬───────┘     └──────┬─────┘
     │                  │                    │
     │  {step 1}        │                    │
     │─────────────────>│                    │
     │                  │                    │
     │  {step 2}        │                    │
     │<─────────────────│                    │
     │                  │                    │
     │  {step 3}                             │
     │──────────────────────────────────────>│
```

______________________________________________________________________

## Business Integration

### Prerequisites

Before advertising this handler, businesses **MUST** complete:

1. {Prerequisite 1, e.g., "Register with {provider} to obtain a business identifier"}
1. {Prerequisite 2}

**Prerequisites Output:**

| Field                   | Description                                      |
| ----------------------- | ------------------------------------------------ |
| `identity.access_token` | {what identifier is assigned, e.g., business_id} |
| {additional config}     | {any additional configuration from onboarding}   |

### Handler Configuration

Businesses advertise support for this handler in their UCP profile's `payment_handlers` registry.

#### Handler Schema

**Schema URL:** `{schema_url}`

The handler schema defines three config variants for different contexts. See [Payment Handler Guide: Defining the Schema](https://ucp.dev/draft/specification/payment-handler-guide/#defining-the-schema) for the full pattern.

| Config Variant    | Context            | Purpose                             |
| ----------------- | ------------------ | ----------------------------------- |
| `business_config` | Business discovery | {describe business-specific fields} |
| `platform_config` | Platform discovery | {describe platform-specific fields} |
| `response_config` | Checkout responses | {describe runtime fields}           |

#### Business Config Fields

| Field   | Type   | Required | Description   |
| ------- | ------ | -------- | ------------- |
| {field} | {type} | {Yes/No} | {description} |

#### Response Config Fields

| Field   | Type   | Required | Description                                                       |
| ------- | ------ | -------- | ----------------------------------------------------------------- |
| {field} | {type} | {Yes/No} | {description — include runtime fields like available instruments} |

#### Example Handler Declaration

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "{handler_name}": [
        {
          "id": "{handler_id}",
          "version": "{version}",
          "spec": "{spec_url}",
          "schema": "{schema_url}",
          "config": {
            // Handler-specific configuration
          }
        }
      ]
    }
  }
}
```

### Processing Payments

Upon receiving a payment with this handler's instrument, businesses **MUST**:

1. **Validate Handler:** Confirm `instrument.handler_id` matches an advertised handler.
1. **Ensure Idempotency:** If the request is a retry (matches a previous `checkout_id` or idempotency key), return the previous result immediately without re-processing funds.
1. **{Step 3}:** {description}
1. **{Step 4}:** {description}
1. **Return Response:** Respond with the finalized checkout state.

{Include example request/response if the business calls an external service}

______________________________________________________________________

## Platform Integration

### Prerequisites

Before using this handler, Platforms **MUST** complete:

1. {Prerequisite 1, e.g., "Register with {provider} to obtain a Platform identifier"}
1. {Prerequisite 2}

**Prerequisites Output:**

| Field                   | Description                                    |
| ----------------------- | ---------------------------------------------- |
| `identity.access_token` | {what identifier is assigned}                  |
| {additional config}     | {any additional configuration from onboarding} |

### Handler Configuration

Platforms advertise support for this handler in their UCP profile's `payment_handlers` registry using `platform_config`.

#### Platform Config Fields

| Field   | Type   | Required | Description   |
| ------- | ------ | -------- | ------------- |
| {field} | {type} | {Yes/No} | {description} |

#### Example Platform Handler Declaration

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "{handler_name}": [
        {
          "id": "{handler_id}",
          "version": "{version}",
          "spec": "{spec_url}",
          "schema": "{schema_url}",
          "config": {
            // Platform-specific configuration
          }
        }
      ]
    }
  }
}
```

### Payment Protocol

Platforms **MUST** follow this flow to acquire a payment instrument:

#### Step 1: Discover Handler

The Platform identifies `{handler_name}` in the business's UCP profile `payment_handlers` registry (from `/.well-known/ucp`).

```json
{
  "ucp": {
    "payment_handlers": {
      "{handler_name}": [
        {
          "id": "{handler_id}",
          "version": "{version}",
          "config": {
            // Business's configuration
          }
        }
      ]
    }
  }
}
```

#### Step 2:

{Description of what the Platform does in this step.}

{Code example if applicable:}

```javascript
// Example SDK usage or API call
```

#### Step 3:

{Continue for all steps...}

#### Step N: Complete Checkout

The Platform submits the checkout with the constructed payment instrument.

```json
POST /checkout-sessions/{checkout_id}/complete
Content-Type: application/json

{
  "payment": {
    "instruments": [
      {
        "id": "{instrument_id}",
        "handler_id": "{handler_id}",
        "type": "{instrument_type}",
        "credential": {
          "type": "{credential_type}",
          // Credential fields
        }
        // Additional instrument fields
      }
    ]
  },
  "risk_signals": {
    // risk signal objects here
  }
}
```

______________________________________________________________________

## {Participant} Integration

### Prerequisites

Before participating in this handler's flow, {participants} **MUST** complete:

1. {Prerequisite 1}
1. {Prerequisite 2}

**Prerequisites Output:**

| Field                   | Description                                    |
| ----------------------- | ---------------------------------------------- |
| `identity.access_token` | {what identifier is assigned}                  |
| {additional config}     | {any additional configuration from onboarding} |

### {Action or Configuration}

{Describe what this participant needs to do.}

{Include examples as appropriate.}

______________________________________________________________________

## Security Considerations

| Requirement                  | Description                                                                                                                                                           |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Binding required**         | Credentials **MUST** be bound to `checkout_id` and `identity` to prevent reuse.                                                                                       |
| **Binding placement**        | Binding data (e.g., `checkout_id`) **SHOULD** be included within the `credential` payload to ensure it is covered by the signature, rather than in transport headers. |
| **Binding verified**         | The processing participant **MUST** verify binding matches before processing.                                                                                         |
| **Token Expiry**             | {If using tokens: Tokens **MUST** expire after {duration} or single-use.}                                                                                             |
| **Data Residency**           | {Specify if PII **MUST** be processed/stored in specific geographic regions (e.g., EU, US) to comply with local laws.}                                                |
| **{Additional requirement}** | {description}                                                                                                                                                         |

______________________________________________________________________

## References

- **Handler Spec:** `{spec_url}`
- **Handler Schema:** `{schema_url}` (defines config, instrument, and credential shapes)

# Tokenization Guide

**OpenAPI:** [Tokenization API](https://ucp.dev/handlers/tokenization/openapi.json)

## Overview

This guide is for **implementers building tokenization payment handlers**. It defines the shared API, security requirements, and conformance criteria that all tokenization handlers follow.

**Note:** While the examples in this guide use card credentials, tokenization patterns apply to **any sensitive credential type**—bank accounts, digital wallets, loyalty accounts, etc. Compliance requirements (e.g., PCI DSS for cards) vary by credential type.

We offer a range of examples to utilize forms of tokenization in UCP:

| Example                                                                                                            | Use Case                                            |
| ------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------- |
| [Processor Tokenizer](https://ucp.dev/draft/specification/examples/processor-tokenizer-payment-handler/index.md)   | Business or PSP runs tokenization and processing    |
| [Platform Tokenizer](https://ucp.dev/draft/specification/examples/platform-tokenizer-payment-handler/index.md)     | Platform tokenizes credentials for businesses/PSPs  |
| [Encrypted Credential Handler](https://ucp.dev/draft/specification/examples/encrypted-credential-handler/index.md) | Platform encrypts credentials instead of tokenizing |

______________________________________________________________________

## Core Concepts

### Credential Flow

Tokenization handlers transform credentials between source and checkout forms:

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                     Tokenization Payment Flow                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Platform has:            Tokenizer            Business receives:      │
│   Source Credential  ──▶  /tokenize  ──▶         TokenCredential        │
│                                                                         │
│   ┌─────────────────┐                      ┌─────────────────────────┐  │
│   │ source_         │                      │ checkout_               │  │
│   │ credentials     │    What goes IN      │ credentials             │  │
│   │                 │◀───────────────      │                         │  │
│   │ • card/fpan     │                      │ What comes OUT          │  │
│   │ • card/dpan     │                ─────▶│ • token                 │  │
│   │                 │                      │                         │  │
│   └─────────────────┘                      └─────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

Tokenization handlers accept source credentials (e.g., card with FPAN) and produce checkout credentials (e.g., tokens).

### Token Lifecycle

Tokens move through distinct phases. Your handler specification must document which lifecycle policy you use:

```text
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  Generation  │───▶│   Storage    │───▶│ Detokenize   │───▶│ Invalidation │
│              │    │              │    │              │    │              │
│Platform calls│    │ Tokenizer    │    │ Business/PSP │    │ Token expires│
│ /tokenize    │    │ holds token  │    │ calls        │    │ or is used   │
│              │    │ → credential │    │ /detokenize  │    │              │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
```

| Policy             | Description                                 | Use Case                                        |
| ------------------ | ------------------------------------------- | ----------------------------------------------- |
| **Single-use**     | Invalidated after first detokenization      | Most secure; recommended default                |
| **TTL-based**      | Expires after fixed duration (e.g., 15 min) | Allows retries on transient failures            |
| **Session-scoped** | Valid for checkout session duration         | Complex flows with multiple processing attempts |

### Binding

All tokenization requests require a `binding` object that ties the token to a specific context:

| Field         | Required    | Description                                                                                     |
| ------------- | ----------- | ----------------------------------------------------------------------------------------------- |
| `checkout_id` | Yes         | The checkout session this token is valid for                                                    |
| `identity`    | Conditional | The participant identity to bind to; required when caller acts on behalf of another participant |

The tokenizer **MUST** verify binding matches on `/detokenize`. See [Binding Schema](https://ucp.dev/schemas/shopping/types/binding.json).

______________________________________________________________________

## OpenAPI

Tokenization handlers implement two endpoints. Your handler **MAY** implement one or both depending on your architecture. Or none, like our encrypted payload example, which defines its own mechanism to encrypt.

### POST /tokenize

Converts a raw credential into a token bound to a checkout and identity.

**When to implement:** Always, unless you are an agent generating tokens internally.

```json
POST /tokenize
Content-Type: application/json

{
  "credential": {
    "type": "card",
    "card_number_type": "fpan",
    "number": "4111111111111111",
    "expiry_month": 12,
    "expiry_year": 2026,
    "cvc": "123"
  },
  "binding": {
    "checkout_id": "abc123",
    "identity": {
      "access_token": "merchant_001"
    }
  }
}
```

**Response:**

```json
{
  "token": "tok_abc123xyz789"
}
```

### POST /detokenize

Returns the original credential for a valid token. Binding must match.

**When to implement:** Always, unless you combine detokenization with processing (see PSP example).

```json
POST /detokenize
Content-Type: application/json
Authorization: Bearer {caller_access_token}

{
  "token": "tok_abc123xyz789",
  "binding": {
    "checkout_id": "abc123"
  }
}
```

**Response:**

```json
{
  "type": "card",
  "card_number_type": "fpan",
  "number": "4111111111111111",
  "expiry_month": 12,
  "expiry_year": 2026,
  "cvc": "123"
}
```

**Note:** `binding.identity` is omitted when the authenticated caller is the binding target. Include it when acting on behalf of another participant (e.g., PSP detokenizing for business).

See the full [OpenAPI specification](https://ucp.dev/handlers/tokenization/openapi.json) for complete request/response schemas.

______________________________________________________________________

## Security Requirements

| Requirement                  | Description                                                                                |
| ---------------------------- | ------------------------------------------------------------------------------------------ |
| **Binding required**         | Credentials **MUST** be bound to `checkout_id` and participant `identity` to prevent reuse |
| **Binding verified**         | Tokenizer **MUST** verify binding matches before returning credentials                     |
| **Cryptographically random** | Use secure random generators; tokens must be unguessable                                   |
| **Sufficient length**        | Minimum 128 bits of entropy                                                                |
| **Non-reversible**           | Cannot derive the credential from the token                                                |
| **Scoped**                   | Token should only work with your tokenizer                                                 |
| **Time-limited**             | Enforce TTL appropriate to use case (typically 5-30 minutes)                               |
| **Single-use preferred**     | Invalidate after first detokenization when possible                                        |

______________________________________________________________________

## Handler Specification Requirements

When publishing your handler, your specification document **MUST** include:

| Requirement                     | Example                                                           |
| ------------------------------- | ----------------------------------------------------------------- |
| **Unique handler name**         | `com.example.tokenization_payment` (reverse-DNS format)           |
| **Endpoint URLs**               | Production and sandbox base URLs                                  |
| **Authentication requirements** | OAuth 2.0, API keys, etc.                                         |
| **Onboarding process**          | How participants register and receive identities                  |
| **Accepted credentials**        | Which credential types are accepted for tokenization              |
| **Token lifecycle policy**      | Single-use, TTL, or session-scoped                                |
| **Security acknowledgements**   | Participants receiving raw credentials must accept responsibility |

### Example Specification Outline

```markdown
**Handler Name:** `com.acme.tokenization_payment`
**OpenAPI:** [Tokenization API](https://ucp.dev/handlers/tokenization/openapi.json)

| Environment | Base URL                           |
| :---------- | :--------------------------------- |
| Production  | `https://api.acme.com/ucp`         |
| Sandbox     | `https://sandbox.api.acme.com/ucp` |

**Supported Instruments:**

| Instrument | Source Credentials           | Checkout Credentials |
| :--------- | :--------------------------- | :------------------- |
| `card`     | `card` (fpan, network_token) | `token`              |

**Token Lifecycle:** Single-use (invalidated after detokenization)

**Authentication:** OAuth 2.0 client credentials

**Onboarding:** Register at portal.acme.com. Businesses receive `access_token` for handler identity.
```

______________________________________________________________________

## Conformance Checklist

A tokenizer handler conforms to this pattern if it:

- Publishes a handler specification at a stable URL with a unique, reverse-DNS `handler_name`
- Implements `/tokenize` and/or `/detokenize` per the OpenAPI
- Defines authentication and onboarding requirements
- Documents credential transformation between source and checkout forms
- Produces tokens compatible with the `TokenCredential` schema
- Specifies token lifecycle policy (TTL, single-use, etc.)
- Requires `binding` with `checkout_id` on tokenization requests
- Uses `PaymentIdentity` for participant identification
- Verifies `binding` matches on detokenization requests
- Requires security acknowledgements from participants receiving raw credentials

______________________________________________________________________

## References

| Resource                | URL                                                                   |
| ----------------------- | --------------------------------------------------------------------- |
| Tokenization OpenAPI    | `https://ucp.dev/handlers/tokenization/openapi.json`                  |
| Identity Schema         | `https://ucp.dev/schemas/shopping/types/payment_identity.json`        |
| Binding Schema          | `https://ucp.dev/schemas/shopping/types/binding.json`                 |
| Token Credential Schema | `https://ucp.dev/schemas/shopping/types/token_credential.json`        |
| Card Instrument Schema  | `https://ucp.dev/schemas/shopping/types/card_payment_instrument.json` |

______________________________________________________________________

## See Also

- **[Encrypted Credential Handler](https://ucp.dev/draft/specification/examples/encrypted-credential-handler/index.md)** — Alternative pattern using encryption instead of tokenize/detokenize round-trips
- **[AP2 Mandates Extension](https://ucp.dev/draft/specification/ap2-mandates/index.md)** — Add cryptographic proof of checkout agreement for PSP verification
# Payment Handler Examples

# Processor Tokenizer Payment Handler

- **Handler Name:** `com.example.processor_tokenizer`
- **Type:** Payment Handler Example

## Introduction

This handler implements a **"Tokenize to Process"** flow where the entity that generates the token (the Tokenizer) is the same entity that processes the final payment (the Processor).

**Note:** While this example uses card credentials, the pattern applies to **any credential type**. Compliance requirements vary by credential type (e.g., PCI DSS for cards).

This specification unifies two common implementation scenarios:

1. **Business-Hosted:** An enterprise Business hosts their own secure vault. The Business tokenizes and processes.
1. **PSP-Hosted:** The Business uses a third-party PSP. The PSP tokenizes and processes.

In both cases, **no API detokenization step is required**. The token resolution happens internally within the Processor's secure environment.

### Comparison of Scenarios

| Feature              | Scenario A: PSP-Hosted                       | Scenario B: Business-Hosted          |
| -------------------- | -------------------------------------------- | ------------------------------------ |
| **Tokenizer Host**   | Third-Party PSP                              | The Business                         |
| **Compliance Scope** | **Low** (Business never sees PAN)            | **High** (Business stores PAN)       |
| **Identity Binding** | **Required** (PSP needs Merchant Identifier) | **Implicit** (Business knows itself) |

______________________________________________________________________

## Participants

| Participant               | Role                                                                                 | Prerequisites                                             |
| ------------------------- | ------------------------------------------------------------------------------------ | --------------------------------------------------------- |
| **Tokenizer / Processor** | Host `/tokenize` endpoint, store tokens, process payments. (Can be Business or PSP). | Compliance per credential type (e.g., PCI DSS for cards). |
| **Platform**              | Collect credentials via secure credential provider, call Tokenizer, submit checkout. | Secure credential provider.                               |
| **Business**              | Configures the handler for the checkout.                                             | None (if PSP-hosted).                                     |

### Pattern Flow

```text
┌────────────┐                         ┌───────────────────────────────────┐
│  Platform  │                         │       Tokenizer / Processor       │
│ (Collector)│                         │      (Business or PSP)            │
└─────┬──────┘                         └─────────────────┬─────────────────┘
      │                                                  │
      │  1. GET ucp.payment_handlers                     │
      │─────────────────────────────────────────────────>│
      │                                                  │
      │  2. Handler Config (URL + Identity)              │
      │<─────────────────────────────────────────────────│
      │                                                  │
      │  3. POST /tokenize (Credential + Identity)       │
      │─────────────────────────────────────────────────>│
      │                                                  │
      │  4. Token                                        │
      │<─────────────────────────────────────────────────│
      │                                                  │
      │  5. POST checkout with TokenCredential           │
      │─────────────────────────────────────────────────>│
      │                                                  │
      │        (Internal Resolution: Token -> Info)      │
      │                                                  │
      │  6. Payment Result                               │
      │<─────────────────────────────────────────────────│
```

______________________________________________________________________

## Configuration

The Business advertises this handler in their UCP profile's `payment_handlers` registry. The configuration determines whether the Platform acts in "PSP Mode" (sending identity) or "Direct Mode" (implicit identity).

### Business Config (Discovery)

The business advertises their tokenization endpoint and identity during discovery. The handler's specification (referenced via the `spec` field) documents the `/tokenize` endpoint URL.

| Field         | Type   | Required | Description                                 |
| ------------- | ------ | -------- | ------------------------------------------- |
| `environment` | string | Yes      | API environment (`sandbox` or `production`) |
| `business_id` | string | Yes      | Business identifier with the processor      |

#### Example Business Handler Declaration

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "com.example.processor_tokenizer": [
        {
          "id": "processor_tokenizer",
          "version": "2026-01-11",
          "spec": "https://example.com/ucp/processor-tokenizer.json",
          "schema": "https://example.com/ucp/processor-tokenizer/schema.json",
          "config": {
            "environment": "production",
            "business_id": "merchant_xyz789"
          }
        }
      ]
    }
  }
}
```

### Response Config (Checkout)

The response config includes runtime information about what's available for this checkout.

| Field                | Type   | Required | Description                                  |
| -------------------- | ------ | -------- | -------------------------------------------- |
| `environment`        | string | Yes      | API environment used for this checkout       |
| `business_id`        | string | Yes      | Business identifier                          |
| `supported_networks` | array  | No       | Card networks supported for this transaction |

#### Example Response Config

```json
{
  "config": {
    "environment": "production",
    "business_id": "merchant_xyz789",
    "supported_networks": ["visa", "mastercard", "amex"]
  }
}
```

## Platform Integration

### Prerequisites

Before using this handler, platforms must:

1. Have access to a **compliant secure payment credential providers** that collects sensitive payment data from users. This service must meet the compliance requirements of the instruments being handled (e.g., PCI DSS).
1. Obtain authentication credentials (e.g., API Key) authorized to call the specific `endpoint` defined in the handler configuration.

**Prerequisites Output:**

| Field                        | Description                                                                   |
| ---------------------------- | ----------------------------------------------------------------------------- |
| payment credential providers | **Compliant** secure service for collecting sensitive payment data from users |
| Authentication credentials   | API key or OAuth token for authenticating `/tokenize` calls                   |

### Payment Protocol

#### Step 1: Discover Handler

Platform identifies the processor tokenizer handler and retrieves the business's configuration.

```json
{
  "ucp": {
    "payment_handlers": {
      "com.example.processor_tokenizer": [
        {
          "id": "processor_tokenizer",
          "version": "2026-01-11",
          "config": {
            "environment": "production",
            "business_id": "merchant_xyz789"
          }
        }
      ]
    }
  }
}
```

#### Step 2: Collect Sensitive Data

Platform's **compliant secure payment credential providers** collects the sensitive payment data from the user (e.g., via a compliant payment form that ensures the sensitive instrument details never touch the platform).

#### Step 3: Tokenize Data

Platform's payment credential provider calls the configured `endpoint`.

**Note:** If the handler configuration includes an `identity` object, the credential provider **MUST** inject it into the `binding` object.

Response:

```json
{
  "token": "tok_a1b2c3d4e5f6"
}
```

### Step 4: Complete Checkout

The Platform submits the token.

```json
POST /checkout-sessions/{checkout_id}/complete
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "payment": {
    "instruments": [
      {
        "id": "instr_1",
        "handler_id": "processor_tokenizer",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "visa",
          "last_digits": "1111",
          "expiry_month": 12,
          "expiry_year": 2026
        },
        "credential": {
          "type": "token",
          "token": "tok_a1b2c3d4e5f6"
        }
      }
    ]
  },
  "risk_signal": {
    // ... the key value pair for potential risk signal data
  }
}
```

______________________________________________________________________

## Implementation Guide

### Scenario A: Enterprise Implementation (Self-Hosted)

- **Role:** The Business implements this specification.
- **Requirements:**
  1. Deploy the `endpoint` on their own infrastructure.
  1. Internally map tokens to PANs in their own database.
- **Security:** **CRITICAL.** For card credentials, the Business **MUST** be PCI DSS compliant as they are receiving raw PANs at their endpoint. Other credential types have their own compliance requirements.

### Scenario B: PSP Implementation (Third-Party)

- **Role:** The PSP implements this specification.
- **Requirements:**
  1. Provide the `endpoint` URL to merchants.
  1. Issue `identity.access_token` (Merchant Secure Identifier) to merchants.
  1. Validate that the `binding.identity` matches the merchant requesting the final payment charge.
- **Security:** PSP bears the compliance burden for credential storage (e.g., PCI DSS for cards).

______________________________________________________________________

## Security Considerations

| Requirement            | Description                                                                                                                                                    |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **TLS/HTTPS**          | All traffic to `config.endpoint` **MUST** be encrypted.                                                                                                        |
| **Compliance**         | The entity hosting `config.endpoint` **MUST** be compliant with relevant data standards for the credential type (e.g., PCI DSS for cards, GDPR for PII, etc.). |
| **Scope Isolation**    | The Platform's main application **MUST NOT** see the raw credential; only the Platform's Secure credential provider and the Tokenizer Host may see it.         |
| **Binding Validation** | The Tokenizer/Processor **MUST** verify that the `checkout_id` submitted during final payment matches the `checkout_id` provided during tokenization.          |

# Platform Tokenizer Payment Handler

- **Handler Name:** `com.example.platform_tokenizer`
- **Type:** Payment Handler Example

## Introduction

This example demonstrates a tokenization payment handler where the **platform acts as the tokenizer**. The platform's **payment credential provider** securely stores sensitive payment data (e.g., stored cards from user wallets) and generates tokens internally without calling an external `/tokenize` endpoint.

The platform's credential provider exposes a `/detokenize` endpoint for businesses to call back and retrieve the sensitive instrument details for processing.

This pattern is ideal for platforms that operate as wallet providers with compliant credential storage.

**Note:** While this example uses card credentials, the pattern applies to **any credential type**. Compliance requirements vary by credential type (e.g., PCI DSS for cards).

### Key Benefits

- **Zero early transmission:** Platforms never expose sensitive data until a payment request is being finalized.
- **Platform-controlled security:** Platform defines token lifecycle and binding policies.
- **PSP flexibility:** Businesses can delegate detokenization to their PSP, keeping sensitive data out of business systems entirely.

### QuickStart

| If you are a...                        | Start here                                    |
| -------------------------------------- | --------------------------------------------- |
| **Business** accepting this handler    | [Business Integration](#business-integration) |
| **Platform** implementing this handler | [Platform Integration](#platform-integration) |
| **PSP** processing for businesses      | [PSP Integration](#psp-integration)           |

______________________________________________________________________

## Participants

| Participant  | Role                                                                                            | Prerequisites                         |
| ------------ | ----------------------------------------------------------------------------------------------- | ------------------------------------- |
| **Business** | Advertises handler, receives tokens, optionally delegates to PSP                                | Yes — onboards with platform          |
| **Platform** | Operates a payment credential provider that generates tokens and exposes `/detokenize` endpoint | Yes — implements tokenization service |
| **PSP**      | Optionally detokenizes on business's behalf, processes payments                                 | Yes — onboards with platform          |

### Pattern Flow: Business Detokenizes

```text
┌─────────────────┐                              ┌────────────┐
│    Platform     │                              │  Business  │
│  (Tokenizer)    │                              │            │
└────────┬────────┘                              └──────┬─────┘
         │                                              │
         │  1. Business registers with Platform (out-of-band)
         │<─────────────────────────────────────────────│
         │                                              │
         │  2. API credentials                          │
         │─────────────────────────────────────────────>│
         │                                              │
         │  3. GET ucp.payment_handlers                 │
         │─────────────────────────────────────────────>│
         │                                              │
         │  4. Handler with business identity           │
         │<─────────────────────────────────────────────│
         │                                              │
         │5. Platforms's Credential Provider generates token│
         │                                              │
         │  6. POST checkout with TokenCredential       │
         │─────────────────────────────────────────────>│
         │                                              │
         │  7. POST /detokenize (to Credential Provider)│
         │<─────────────────────────────────────────────│
         │                                              │
         │  8. Sensitive Data                           │
         │─────────────────────────────────────────────>│
         │                                              │
         │  9. Checkout complete                        │
         │<─────────────────────────────────────────────│
```

### Pattern Flow: PSP Detokenizes

```text
┌─────────────────┐     ┌────────────┐      ┌─────────┐
│    Platform     │     │  Business  │      │   PSP   │
│  (Tokenizer)    │     │            │      │         │
└────────┬────────┘     └──────┬─────┘      └────┬────┘
         │                     │                 │
         │  1. Business + PSP register with Platform (out-of-band)
         │<────────────────────│                 │
         │<──────────────────────────────────────│
         │                     │                 │
         │  2. API credentials │                 │
         │────────────────────>│                 │
         │──────────────────────────────────────>│
         │                     │                 │
         │  3. Payment Credential Provider       │
         │     generates token                   │
         │                     │                 │
         │  4. POST checkout with TokenCredential│
         │────────────────────>│                 │
         │                     │                 │
         │                     │  5. Forward     │
         │                     │  token to PSP   │
         │                     │────────────────>│
         │                     │                 │
         │  6. POST /detokenize (to Credential Provider, with business identity)
         │<──────────────────────────────────────│
         │                     │                 │
         │  7. Sensitive Data  │                 │
         │──────────────────────────────────────>│
         │                     │                 │
         │                     │  8. Payment     │
         │                     │  result         │
         │                     │<────────────────│
         │                     │                 │
         │  9. Checkout complete                 │
         │<────────────────────│                 │
```

______________________________________________________________________

## Business Integration

### Prerequisites

#### CRITICAL: Security & Compliance Required

Before accepting this handler, businesses must register with the platform to obtain authentication credentials for calling `/detokenize`.

As the party receiving sensitive instrument details via the `/detokenize` endpoint, businesses **MUST** be compliant with relevant data security standards for the credential type being handled (e.g., PCI DSS for cards). This includes:

- Secure transmission (HTTPS/TLS with strong cipher suites)
- Secure handling of sensitive data during payment processing
- Compliance with all regulations regarding the storage and processing of financial instruments

Optionally, businesses may configure their PSP to detokenize on their behalf (PSP must also be compliant).

**Prerequisites Output:**

| Field                      | Description                                                   |
| -------------------------- | ------------------------------------------------------------- |
| `identity.access_token`    | Business identifier assigned by platform during onboarding    |
| Authentication credentials | API key or OAuth token for authenticating `/detokenize` calls |

### Handler Configuration

Businesses advertise the platform's tokenization handler. The `config` contains the business's identity with the platform for token binding. The platform's handler specification (referenced via `spec`) documents the `/detokenize` endpoint URL exposed by the platform's **payment credential provider**.

The handler accepts [CardCredential](https://ucp.dev/schemas/shopping/types/card_credential.json) for tokenization and produces [TokenCredential](https://ucp.dev/schemas/shopping/types/token_credential.json) for checkout.

**Note:** The result of `/detokenize` contains **sensitive payment data**. Both the sender (platform's credential provider) and receiver (business or PSP) **MUST** be compliant with relevant standards for the credential type (e.g., PCI DSS for cards).

#### Business Config (Discovery)

| Field         | Type   | Required | Description                                 |
| ------------- | ------ | -------- | ------------------------------------------- |
| `environment` | string | Yes      | API environment (`sandbox` or `production`) |
| `business_id` | string | Yes      | Business identifier assigned by platform    |

#### Example Business Handler Declaration

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "com.example.platform_tokenizer": [
        {
          "id": "platform_wallet",
          "version": "2026-01-11",
          "spec": "https://platform.example.com/ucp/handler.json",
          "schema": "https://platform.example.com/ucp/handler/schema.json",
          "config": {
            "environment": "production",
            "business_id": "business_abc123"
          }
        }
      ]
    }
  }
}
```

#### Response Config (Checkout)

The response config includes runtime token lifecycle information.

| Field               | Type    | Required | Description                   |
| ------------------- | ------- | -------- | ----------------------------- |
| `environment`       | string  | Yes      | API environment               |
| `business_id`       | string  | Yes      | Business identifier           |
| `token_ttl_seconds` | integer | No       | Token time-to-live in seconds |

#### Example Response Config

```json
{
  "config": {
    "environment": "production",
    "business_id": "business_abc123",
    "token_ttl_seconds": 900,
  }
}
```

### Processing Payments

Upon receiving a checkout with a token credential:

1. **Validate Handler:** Confirm `instrument.handler_id` matches the expected handler ID.
1. **Detokenize or Delegate:**
1. **Option A (Direct):** Call the platform's **credential provider** `/detokenize` endpoint directly, then process payments.
1. **Option B (Delegated):** Forward the token to a PSP for detokenization and payment processing.
1. **Return Response:** Respond with the finalized checkout state.

For option B, see section [PSP Integration](#psp-integration).

#### Detokenize Request Example (Business)

```json
POST https://provider.platform.example.com/ucp/detokenize
Content-Type: application/json
Authorization: Bearer {business_api_key}

{
  "token": "ptok_x9y8z7w6v5u4",
  "binding": {
    "checkout_id": "checkout_789"
  }
}
```

Note: No `binding.identity` is needed if the business authenticates directly—the platform knows who they are based on the API key.

______________________________________________________________________

## Platform Integration

### Prerequisites

This handler is implemented by platforms that operate **compliant payment credential providers** or wallet services. The payment credential provider (not the main platform application) handles sensitive data and exposes the `/detokenize` endpoint. To implement, platforms must:

1. Deploy a **compliant payment credential provider** that maintains compliance for credential storage and handling.
1. Expose a `/detokenize` endpoint conforming to the API pattern from the credential provider.
1. Onboard businesses and PSPs who will call the credential provider's `/detokenize` endpoint.

**Implementation Requirements:**

| Requirement            | Description                                                                              |
| ---------------------- | ---------------------------------------------------------------------------------------- |
| `/detokenize` endpoint | Exposed by the compliant payment credential provider (not the platform application)      |
| Token storage          | Map tokens to credentials with binding metadata in the credential provider               |
| Participant allowlist  | Only onboarded businesses/PSPs can call the credential provider's `/detokenize`          |
| Binding verification   | payment credential provider verifies `checkout_id` and caller identity on detokenization |

### Handler Configuration (Platform)

Platforms advertise this handler in their UCP profile's `payment_handlers` registry using `platform_config`.

#### Platform Config (Discovery)

| Field                       | Type    | Required | Description                                 |
| --------------------------- | ------- | -------- | ------------------------------------------- |
| `environment`               | string  | Yes      | API environment (`sandbox` or `production`) |
| `platform_id`               | string  | Yes      | Platform identifier                         |
| `default_token_ttl_seconds` | integer | No       | Default token TTL offered to businesses     |

#### Example Platform Handler Declaration

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "com.example.platform_tokenizer": [
        {
          "id": "platform_wallet",
          "version": "2026-01-11",
          "spec": "https://platform.example.com/ucp/handler.json",
          "schema": "https://platform.example.com/ucp/handler/schema.json",
          "config": {
            "environment": "production",
            "platform_id": "platform_abc123",
            "default_token_ttl_seconds": 900
          }
        }
      ]
    }
  }
}
```

### Token Generation

The platform application orchestrates the payment flow but **never has access to sensitive payment data**. Instead:

1. The platform's **payment credential provider** securely stores payment credentials.
1. When a payment is needed, the platform application requests a token from the credential provider.
1. The credential provider generates a token bound to both the `checkout_id` and the business's `identity` (from the handler declaration).
1. The credential provider returns the token to the platform application.
1. The platform application includes this token in the checkout submission.

This separation ensures the platform application itself never handles or has access to sensitive instrument details.

### Submitting Checkout

The platform application submits the checkout with the token (received from its payment credential provider):

```json
POST /checkout-sessions/{checkout_id}/complete
Content-Type: application/json

{
  "payment": {
    "instruments": [
      {
        "id": "instr_1",
        "handler_id": "platform_wallet",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "visa",
          "last_digits": "4242"
        },
        "credential": {
          "type": "token",
          "token": "ptok_x9y8z7w6v5u4"
        }
      }
    ]
  },
  "risk_signals": {
    // ... the key value pair for potential risk signal data
  }
}
```

______________________________________________________________________

## PSP Integration

### Prerequisites

#### CRITICAL: Security & Compliance Required

Before detokenizing on behalf of businesses, PSPs must register with the platform, providing the list of businesses they process for.

As the party receiving sensitive instrument details via the `/detokenize` endpoint, PSPs **MUST** be **compliant** with relevant security standards for the credential type being handled (e.g., PCI DSS for cards). This includes:

- Secure transmission (HTTPS/TLS with strong cipher suites)
- Secure handling of sensitive data during payment processing
- Compliance with all regulations regarding the storage and processing of financial instruments

**Prerequisites Output:**

| Field                      | Description                                                   |
| -------------------------- | ------------------------------------------------------------- |
| Authentication credentials | API key or OAuth token for authenticating `/detokenize` calls |
| Business associations      | List of business identities this PSP can detokenize for       |

### Detokenization Flow

When the business forwards a token to the PSP:

1. Extract the token from the payment instrument.
1. Call the platform's **payment credential provider** `/detokenize` endpoint with the business's identity in binding.
1. Process the payment with the returned credential.

#### Detokenize Request Example (PSP)

```json
POST https://provider.platform.example.com/ucp/detokenize
Content-Type: application/json
Authorization: Bearer {psp_api_key}

{
  "token": "ptok_x9y8z7w6v5u4",
  "binding": {
    "checkout_id": "checkout_789",
    "identity": {
      "access_token": "business_abc123"
    }
  }
}
```

Note: `binding.identity` IS required here—the PSP is calling on behalf of a business, so they must specify which businesses' token they are retrieving.

The platform's payment credential provider verifies that:

- The PSP is authorized to detokenize for this business.
- The `checkout_id` matches the original tokenization.
- The token has not expired or been used.

______________________________________________________________________

## Security Considerations

| Requirement                          | Description                                                                                                                                                                            |
| ------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Compliance (credential provider)** | Platform's credential provider **MUST** be compliant with relevant standards for the credential type (e.g., PCI DSS for cards) when handling and storing sensitive instrument details. |
| **Compliance (Receivers)**           | Businesses/PSPs calling `/detokenize` **MUST** be compliant with relevant standards for the credential type when receiving sensitive data payloads.                                    |
| **Secure transmission**              | Data transmission via `/detokenize` **MUST** use HTTPS/TLS with strong cipher suites.                                                                                                  |
| **No Platform App access**           | Platform applications **MUST NOT** handle sensitive data—only the compliant payment credential provider does.                                                                          |
| **Endpoint isolation**               | `/detokenize` endpoint **MUST** be exposed by the payment credential provider, not the platform application.                                                                           |
| **Participant authentication**       | Platform's credential provider **MUST** authenticate businesses/PSPs before accepting `/detokenize` calls.                                                                             |
| **Identity binding**                 | Tokens **MUST** be bound to the business's `identity` from the handler declaration.                                                                                                    |
| **Checkout-bound**                   | Tokens **MUST** be bound to the specific `checkout_id`.                                                                                                                                |
| **Caller verification**              | Platform **MUST** verify authenticated caller matches the token's bound identity (or is an authorized PSP).                                                                            |
| **Single-use**                       | Tokens **SHOULD** be invalidated after detokenization.                                                                                                                                 |
| **Short TTL**                        | Tokens **SHOULD** expire shortly.                                                                                                                                                      |
| **HTTPS required**                   | All `/detokenize` calls must use TLS.                                                                                                                                                  |

______________________________________________________________________

## References

- **Pattern:** [Tokenization Payment Handler](https://ucp.dev/specification/payment-handler-guide)
- **API Pattern:** `https://ucp.dev/handlers/tokenization/openapi.json`
- **Identity Schema:** `https://ucp.dev/schemas/shopping/types/payment_identity.json`

# Encrypted Credential Handler

- **Handler Name:** `com.example.encrypted_credential`
- **Type:** Payment Handler Example

## Introduction

This example demonstrates a payment handler where the **platform encrypts credentials directly for the business**. Unlike tokenization patterns, there is no `/tokenize` or `/detokenize` endpoint—the platform's compliant credential vault encrypts credentials using the business's public key, and the business decrypts them locally.

This pattern is ideal when businesses want to avoid round-trip latency to a tokenizer at payment time.

**Note:** While this example uses card credentials (requiring PCI DSS compliance), the encryption pattern applies to **any credential type**. Compliance requirements vary by credential type.

### Key Benefits

- **No runtime round-trips:** Business decrypts locally, no `/detokenize` call needed
- **Simpler architecture:** No token storage or token-to-credential mapping
- **Business-controlled keys:** Business manages their own decryption keys

### Quick Start

| If you are a...                        | Start here                                    |
| -------------------------------------- | --------------------------------------------- |
| **Business** accepting this handler    | [Business Integration](#business-integration) |
| **Platform** implementing this handler | [Platform Integration](#platform-integration) |

______________________________________________________________________

## Participants

| Participant  | Role                                                                              | Prerequisites                 |
| ------------ | --------------------------------------------------------------------------------- | ----------------------------- |
| **Business** | Registers public key, receives encrypted credentials, decrypts locally            | Yes — registers with platform |
| **Platform** | Operates compliant credential vault, encrypts for business using their public key | Yes — implements encryption   |

### Pattern Flow

```text
┌─────────────────┐                              ┌────────────┐
│  Platform       │                              │  Business  │
│                 │                              │            │
└────────┬────────┘                              └──────┬─────┘
         │                                              │
         │  1. Business registers public key (out-of-band)
         │<─────────────────────────────────────────────│
         │                                              │
         │  2. Confirmation                             │
         │─────────────────────────────────────────────>│
         │                                              │
         │  3. GET ucp.payment_handlers                 │
         │─────────────────────────────────────────────>│
         │                                              │
         │  4. Handler with business identity           │
         │<─────────────────────────────────────────────│
         │                                              │
         │  5. Platform's vaulting service encrypts     │
         │     credential with business's key           │
         │                                              │
         │  6. POST checkout with EncryptedCredential   │
         │─────────────────────────────────────────────>│
         │                                              │
         │       (Business decrypts locally)            │
         │                                              │
         │  7. Checkout complete                        │
         │<─────────────────────────────────────────────│
```

______________________________________________________________________

## Business Integration

### Prerequisites

#### CRITICAL: Compliance Required for Card Credentials

Before accepting this handler, businesses must register their public encryption key with the platform.

While businesses receive only encrypted `EncryptedCredential` payloads during checkout, they decrypt these payloads locally to obtain raw credentials for payment processing. **For card credentials**, businesses MUST be **PCI DSS compliant** because they will handle raw PANs. This includes:

- Secure key management for decryption keys
- Secure handling of raw credentials after decryption
- For cards: Compliance with all PCI DSS requirements for handling Primary Account Numbers (PANs)

**Prerequisites Output:**

| Field                   | Description                                                |
| ----------------------- | ---------------------------------------------------------- |
| `identity.access_token` | Business identifier assigned by platform during onboarding |
| Public key registered   | Platform stores business's public key for encryption       |

### Handler Configuration

Businesses advertise the platform's handler. The `business_id` field identifies the business, which the platform uses to look up the correct public key for encryption.

The only supported instrument schema is [CardPaymentInstrument](https://ucp.dev/schemas/shopping/types/card_payment_instrument.json), the only supported checkout credential schema is `EncryptedCredential`, and the only supported source credential schema is [CardCredential](https://ucp.dev/schemas/shopping/types/card_credential.json).

**Note:** The `EncryptedCredential` shape would be formally defined in the handler's schema (referenced via the `schema` field in the handler declaration).

**Note:** `CardCredential` contains raw PANs. For card credentials, the platform's vaulting service must be **PCI DSS compliant** when handling these credentials. Businesses receive only encrypted payloads but must be PCI DSS compliant once they decrypt card credentials locally. Other credential types have their own compliance requirements.

#### Business Config (Discovery)

| Field           | Type   | Required | Description                                         |
| --------------- | ------ | -------- | --------------------------------------------------- |
| `environment`   | string | Yes      | API environment (`sandbox` or `production`)         |
| `business_id`   | string | Yes      | Business identifier assigned by platform            |
| `public_key_id` | string | Yes      | Identifier for the business's registered public key |

#### Example Business Handler Declaration

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "com.example.platform_encrypted": [
        {
          "id": "platform_encrypted",
          "version": "2026-01-11",
          "spec": "https://platform.example.com/ucp/encrypted-handler.json",
          "schema": "https://platform.example.com/ucp/encrypted-handler/schema.json",
          "config": {
            "environment": "production",
            "business_id": "merchant_abc123",
            "public_key_id": "key_2026_01"
          }
        }
      ]
    }
  }
}
```

#### Response Config (Checkout)

The response config includes information about the encryption used.

| Field                  | Type   | Required | Description                           |
| ---------------------- | ------ | -------- | ------------------------------------- |
| `environment`          | string | Yes      | API environment                       |
| `business_id`          | string | Yes      | Business identifier                   |
| `encryption_algorithm` | string | Yes      | Algorithm used (e.g., `RSA-OAEP-256`) |
| `key_id`               | string | Yes      | Key identifier used for encryption    |

#### Example Response Config

```json
{
  "config": {
    "environment": "production",
    "business_id": "merchant_abc123",
    "encryption_algorithm": "RSA-OAEP-256",
    "key_id": "key_2026_01"
  }
}
```

### Processing Payments

Upon receiving a checkout with an encrypted credential:

1. **Validate Handler:** Confirm `instrument.handler_id` matches the expected handler ID
1. **Decrypt Credential:** Use business's private key to decrypt the credential
1. **Verify Binding:** Confirm the decrypted `checkout_id` matches the current checkout
1. **Process Payment:** Use the decrypted credential to complete payment
1. **Return Response:** Respond with the finalized checkout state

______________________________________________________________________

## Platform Integration

### Prerequisites

This handler is implemented by platforms that operate compliant credential vaults and can encrypt credentials for businesses. To implement, platforms must:

1. Maintain compliance for credential storage and handling (e.g., PCI DSS for cards)
1. Store business public keys during onboarding
1. Encrypt credentials using the correct business's key based on handler identity

**Implementation Requirements:**

| Requirement | Description                                                      |
| ----------- | ---------------------------------------------------------------- |
| Key storage | Map business identities to their public keys                     |
| Encryption  | Encrypt credentials + binding context with business's public key |

### Handler Configuration (Platform)

Platforms advertise this handler in their UCP profile's `payment_handlers` registry using `platform_config`.

#### Platform Config (Discovery)

| Field                  | Type   | Required | Description                                                |
| ---------------------- | ------ | -------- | ---------------------------------------------------------- |
| `environment`          | string | Yes      | API environment (`sandbox` or `production`)                |
| `platform_id`          | string | Yes      | Platform identifier                                        |
| `supported_algorithms` | array  | Yes      | Encryption algorithms supported (e.g., `["RSA-OAEP-256"]`) |

#### Example Platform Handler Declaration

```json
{
  "ucp": {
    "version": "2026-01-11",
    "payment_handlers": {
      "com.example.platform_encrypted": [
        {
          "id": "platform_encrypted",
          "version": "2026-01-11",
          "spec": "https://platform.example.com/ucp/encrypted-handler.json",
          "schema": "https://platform.example.com/ucp/encrypted-handler/schema.json",
          "config": {
            "environment": "production",
            "platform_id": "platform_abc123",
            "supported_algorithms": ["RSA-OAEP-256", "RSA-OAEP-384"]
          }
        }
      ]
    }
  }
}
```

### Credential Encryption

The platform application orchestrates the payment flow but **never has access to raw credentials**. Instead:

1. The platform's **compliant vaulting service** receives the raw credential from the user
1. The vaulting service encrypts the credential along with binding context using the business's public key
1. The vaulting service returns the encrypted payload to the platform application
1. The platform application includes this encrypted payload in the checkout submission

This separation ensures the platform application itself never handles or has access to raw PANs.

### Submitting Checkout

Platform application submits the checkout with the encrypted credential (received from its vaulting service):

```json
POST /checkout-sessions/{checkout_id}/complete
UCP-Agent: profile="https://platform.example/profile"
Content-Type: application/json

{
  "payment": {
    "instruments": [
      {
        "id": "instr_1",
        "handler_id": "platform_encrypted",
        "type": "card",
        "selected": true,
        "display": {
          "brand": "visa",
          "last_digits": "1111",
          "expiry_month": 12,
          "expiry_year": 2026
        },
        "credential": {
          "type": "encrypted",
          "encrypted_data": "base64-encoded-encrypted-payload..."
        }
      }
    ]
  },
  "risk_signals": {
    // ... the key value pair for potential risk signal data
  }
}
```

______________________________________________________________________

## Security Considerations

| Requirement                           | Description                                                                                                                              |
| ------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **Compliance (Platform)**             | Platform vaulting services MUST be compliant with relevant standards for the credential type (e.g., PCI DSS for cards handling raw PANs) |
| **Compliance (Business)**             | Businesses MUST be compliant with relevant standards for decryption and handling of raw credentials locally (e.g., PCI DSS for cards)    |
| **No platform app credential access** | Platform applications MUST NOT handle raw credentials—only the compliant vaulting service does                                           |
| **Asymmetric encryption**             | Platform's credential vault encrypts with business's public key; only business can decrypt                                               |
| **Binding embedded**                  | `checkout_id` MUST be included in encrypted payload to prevent replay                                                                    |
| **Key rotation**                      | Businesses SHOULD rotate keys periodically; platform must support key updates                                                            |
| **No credential storage**             | Platform does not store encrypted credentials; encryption is one-way                                                                     |
| **HTTPS required**                    | All checkout submissions must use TLS                                                                                                    |

______________________________________________________________________

## References

- **Identity Schema:** `https://ucp.dev/schemas/shopping/types/payment_identity.json`
- **Instrument Schema:** `https://ucp.dev/schemas/shopping/types/card_payment_instrument.json`
# Schema Authoring

# Schema Authoring Guide

This guide documents conventions for authoring UCP JSON schemas: metadata fields, the registry pattern, schema variants, and versioning.

## Schema Metadata Fields

UCP schemas use standard JSON Schema fields plus UCP-specific metadata:

| Field         | Standard    | Purpose                                                             | Required For                             |
| ------------- | ----------- | ------------------------------------------------------------------- | ---------------------------------------- |
| `$schema`     | JSON Schema | Declares JSON Schema draft version (**SHOULD** use `draft/2020-12`) | All schemas                              |
| `$id`         | JSON Schema | Schema's canonical URI for `$ref` resolution                        | All schemas                              |
| `title`       | JSON Schema | Human-readable display name                                         | All schemas                              |
| `description` | JSON Schema | Schema purpose and usage                                            | All schemas                              |
| `name`        | UCP         | Reverse-domain identifier; doubles as registry key                  | Capabilities, services, handlers         |
| `version`     | UCP         | Entity version (`YYYY-MM-DD` format)                                | Capabilities, services, payment handlers |
| `id`          | UCP         | Instance identifier for multiple configurations                     | Payment handlers only                    |

### Why Self-Describing?

Capability schemas **must be self-describing**: when a platform fetches a schema, it should determine exactly what capability and version it represents without cross-referencing other documents. This matters because:

1. **Independent versioning**: Capabilities may version independently. The schema must declare its version explicitly—you can't infer it from the URL.
1. **Validation**: Validators can cross-check that a capability declaration's `schema` URL points to a schema whose embedded `name`/`version` match the declaration. Mismatches are authoring errors caught at build time.
1. **Developer experience**: When reading a schema file, integrators immediately see what capability it defines without reverse-engineering the `$id` URL.
1. **Compact namespace**: The `name` field provides a standardized reverse-domain identifier (e.g., `dev.ucp.shopping.checkout`) that's more compact and semantic than the full `$id` URL.

### Why Both `$id` and `name`?

| Field  | Role                                                    | Format                 |
| ------ | ------------------------------------------------------- | ---------------------- |
| `$id`  | JSON Schema primitive for `$ref` resolution and tooling | URI (required by spec) |
| `name` | Registry key and stable identifier                      | Reverse-domain         |

`$id` must be a valid URI per JSON Schema spec. `name` is the **key used in registries** (`capabilities`, `services`, `payment_handlers`) and the wire protocol identifier used in capability negotiation—decoupled from schema hosting so that `schema` URLs can change as infrastructure evolves.

The reverse-domain format provides **namespace governance**: domain owners control their namespace (`dev.ucp.*`, `com.shopify.*`), avoiding collisions between UCP and vendor entities. This stable identity layer allows trust and resolution mechanisms to evolve independently—future versions could adopt verifiable credentials, content-addressed schemas, or other verification methods without breaking capability negotiation.

### Why `version` Uses Dates?

The `version` field uses date-based versioning (`YYYY-MM-DD`) to enable:

- **Capability negotiation**: Platforms request specific versions they support
- **Breaking change management**: New versions get new dates; old versions remain valid and resolvable
- **Independent lifecycles**: Extensions can release on their own schedule

## Schema Categories

UCP schemas fall into six categories based on their role in the protocol.

### Capability Schemas

Define negotiated capabilities that appear in `ucp.capabilities{}` registries.

- **Top-level fields**: `$schema`, `$id`, `title`, `description`, `name`, `version`
- **Variants**: `platform_schema`, `business_schema`, `response_schema`

Examples: `checkout.json`, `fulfillment.json`, `discount.json`, `order.json`

### Service Schemas

Define transport bindings that appear in `ucp.services{}` registries. Each transport (REST, MCP, A2A, Embedded) is a separate entry.

- **Top-level fields**: `$schema`, `$id`, `title`, `description`, `name`, `version`
- **Variants**: `platform_schema`, `business_schema`
- **Transport requirements**:
  - REST/MCP: `endpoint`, `schema` (OpenAPI/OpenRPC URL)
  - A2A: `endpoint` (Agent Card URL)
  - Embedded: `schema` (OpenRPC URL)

### Payment Handler Schemas

Define payment handler configurations in `ucp.payment_handlers{}` registries.

- **Top-level fields**: `$schema`, `$id`, `title`, `description`, `name`, `version`
- **Variants**: `platform_schema`, `business_schema`, `response_schema`
- **Instance `id`**: Required to distinguish multiple configurations of the same handler

Examples: `com.google.pay`, `dev.shopify.shop_pay`, `dev.ucp.processor_tokenizer`

**→ See [Payment Handler Guide](https://ucp.dev/draft/specification/payment-handler-guide/index.md)** for detailed guidance on handler structure, config/instrument/credential schemas, and the full specification template.

### Component Schemas

Data structures embedded within capabilities but not independently negotiated. Do **not** appear in registries.

- **Top-level fields**: `$schema`, `$id`, `title`, `description`
- **Omit**: `name`, `version` (not independently versioned)

Examples:

- `schemas/shopping/payment.json` — Payment configuration (part of checkout)

### Type Schemas

Reusable definitions referenced by other schemas. Do **not** appear in registries.

- **Top-level fields**: `$schema`, `$id`, `title`, `description`
- **Omit**: `name`, `version`

Examples: `types/buyer.json`, `types/line_item.json`, `types/postal_address.json`

### Meta Schemas

Define protocol structure rather than entity payloads.

- **Top-level fields**: `$schema`, `$id`, `title`, `description`
- **Omit**: `name`, `version`

Examples: `ucp.json` (entity base), `capability.json`, `service.json`, `payment_handler.json`

## The Registry Pattern

UCP organizes capabilities, services, and handlers in **registries**—objects keyed by `name` rather than arrays of objects with `name` fields.

```json
{
  "capabilities": {
    "dev.ucp.shopping.checkout": [{"version": "2026-01-11"}],
    "dev.ucp.shopping.fulfillment": [{"version": "2026-01-11"}]
  },
  "services": {
    "dev.ucp.shopping": [
      {"version": "2026-01-11", "transport": "rest"},
      {"version": "2026-01-11", "transport": "mcp"}
    ]
  },
  "payment_handlers": {
    "com.google.pay": [{"id": "gpay_1234", "version": "2026-01-11"}]
  }
}
```

### Registry Contexts

The same registry structure appears in three contexts with different field requirements:

| Context          | Location                | Required Fields                 |
| ---------------- | ----------------------- | ------------------------------- |
| Platform Profile | Advertised URI          | `version`, `spec`, `schema`     |
| Business Profile | `/.well-known/ucp`      | `version`; may add `config`     |
| API Responses    | Checkout/order payloads | `version` (+ `id` for handlers) |

## The Entity Pattern

All capabilities, services, and handlers extend a common `entity` base schema:

| Field     | Type   | Description                                     |
| --------- | ------ | ----------------------------------------------- |
| `version` | string | Entity version (`YYYY-MM-DD`) — always required |
| `spec`    | URI    | Human-readable specification                    |
| `schema`  | URI    | JSON Schema URL                                 |
| `id`      | string | Instance identifier (handlers only)             |
| `config`  | object | Entity-specific configuration                   |

### Schema Variants

Each entity type defines **three variants** for different contexts:

**`platform_schema`** — Full declarations for discovery

```json
{
  "dev.ucp.shopping.fulfillment": [{
    "version": "2026-01-11",
    "spec": "https://ucp.dev/specification/fulfillment",
    "schema": "https://ucp.dev/schemas/shopping/fulfillment.json",
    "config": {
      "supports_multi_group": true
    }
  }]
}
```

**`business_schema`** — Business-specific overrides

```json
{
  "dev.ucp.shopping.fulfillment": [{
    "version": "2026-01-11",
    "config": {
      "allows_multi_destination": {"shipping": true}
    }
  }]
}
```

**`response_schema`** — Minimal references in API responses

```json
{
  "ucp": {
    "capabilities": {
      "dev.ucp.shopping.fulfillment": [{"version": "2026-01-11"}]
    }
  }
}
```

Define all three in your schema's `$defs`:

```json
"$defs": {
  "platform_schema": {
    "allOf": [{"$ref": "../capability.json#/$defs/platform_schema"}]
  },
  "business_schema": {
    "allOf": [{"$ref": "../capability.json#/$defs/business_schema"}]
  },
  "response_schema": {
    "allOf": [{"$ref": "../capability.json#/$defs/response_schema"}]
  }
}
```

## Versioning Strategy

### UCP Capabilities (`dev.ucp.*`)

UCP-authored capabilities version with protocol releases by default. Individual capabilities **may** version independently when needed.

### Vendor Capabilities (`com.{vendor}.*`)

Capabilities outside `dev.ucp.*` version fully independently:

```json
{
  "name": "com.shopify.loyalty",
  "version": "2025-09-01",
  "spec": "https://shopify.dev/ucp/loyalty",
  "schema": "https://shopify.dev/ucp/schemas/loyalty.json"
}
```

Vendor schemas follow the same self-describing requirements.

## Complete Example: Capability Schema

A capability schema defines both payload structure and declaration variants:

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ucp.dev/schemas/shopping/checkout.json",
  "name": "dev.ucp.shopping.checkout",
  "version": "2026-01-11",
  "title": "Checkout",
  "description": "Base checkout schema. Extensions compose via allOf.",

  "$defs": {
    "platform_schema": {
      "allOf": [{"$ref": "../capability.json#/$defs/platform_schema"}]
    },
    "business_schema": {
      "allOf": [{"$ref": "../capability.json#/$defs/business_schema"}]
    },
    "response_schema": {
      "allOf": [{"$ref": "../capability.json#/$defs/response_schema"}]
    }
  },

  "type": "object",
  "required": ["ucp", "id", "line_items", "status", "currency", "totals", "links"],
  "properties": {
    "ucp": {"$ref": "../ucp.json#/$defs/response_checkout_schema"},
    "id": {"type": "string", "description": "Checkout identifier"},
    "line_items": {"type": "array", "items": {"$ref": "types/line_item.json"}},
    "status": {"type": "string", "enum": ["open", "completed", "expired"]},
    "currency": {"type": "string", "pattern": "^[A-Z]{3}$"},
    "totals": {"$ref": "types/totals.json"},
    "links": {"$ref": "types/links.json"}
  }
}
```

Key points:

- **Top-level `name` and `version`** make the schema self-describing
- **`$defs` variants** enable validation in different contexts
- **Payload properties** define the actual checkout response structure
# Reference

# Schema Reference

This page provides a reference for all the capability data models and types used within the UCP.

## Capability Schemas

### Cart

| Name         | Type                                                                                 | Required | Description                                                                                                                                        |
| ------------ | ------------------------------------------------------------------------------------ | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Cart Schema](/draft/specification/reference/#ucp-response-cart-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                            |
| id           | string                                                                               | **Yes**  | Unique cart identifier.                                                                                                                            |
| line_items   | Array\[[Line Item](/draft/specification/reference/#line-item)\]                      | **Yes**  | Cart line items. Same structure as checkout. Full replacement on update.                                                                           |
| context      | [Context](/draft/specification/reference/#context)                                   | No       | Buyer signals for localization (country, region, postal_code). Merchant uses for pricing, availability, currency. Falls back to geo-IP if omitted. |
| buyer        | [Buyer](/draft/specification/reference/#buyer)                                       | No       | Optional buyer information for personalized estimates.                                                                                             |
| currency     | string                                                                               | **Yes**  | ISO 4217 currency code. Determined by merchant based on context or geo-IP.                                                                         |
| totals       | Array\[[Total](/draft/specification/reference/#total)\]                              | **Yes**  | Estimated cost breakdown. May be partial if shipping/tax not yet calculable.                                                                       |
| messages     | Array\[[Message](/draft/specification/reference/#message)\]                          | No       | Validation messages, warnings, or informational notices.                                                                                           |
| links        | Array\[[Link](/draft/specification/reference/#link)\]                                | No       | Optional merchant links (policies, FAQs).                                                                                                          |
| continue_url | string                                                                               | No       | URL for cart handoff and session recovery. Enables sharing and human-in-the-loop flows.                                                            |
| expires_at   | string                                                                               | No       | Cart expiry timestamp (RFC 3339). Optional.                                                                                                        |

______________________________________________________________________

### Checkout

| Name         | Type                                                                                         | Required | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ------------ | -------------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | [UCP Response Checkout Schema](/draft/specification/reference/#ucp-response-checkout-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| id           | string                                                                                       | **Yes**  | Unique identifier of the checkout session.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| line_items   | Array\[[Line Item](/draft/specification/reference/#line-item)\]                              | **Yes**  | List of line items being checked out.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| buyer        | [Buyer](/draft/specification/reference/#buyer)                                               | No       | Representation of the buyer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| context      | [Context](/draft/specification/reference/#context)                                           | No       | Provisional buyer signals for relevance and localization: product availability, pricing, currency, tax, shipping, payment methods, and eligibility (e.g., student or affiliation discounts). Businesses SHOULD use these values when authoritative data (e.g., address) is absent, and MAY ignore unsupported values without returning errors. Context SHOULD be non-identifying and can be disclosed progressively—coarse signals early, finer resolution as the session progresses. Higher-resolution data (shipping address, billing address) supersedes context. Platforms SHOULD progressively enhance context throughout the buyer journey. |
| status       | string                                                                                       | **Yes**  | Checkout state indicating the current phase and required action. See Checkout Status lifecycle documentation for state transition details. **Enum:** `incomplete`, `requires_escalation`, `ready_for_complete`, `complete_in_progress`, `completed`, `canceled`                                                                                                                                                                                                                                                                                                                                                                                   |
| currency     | string                                                                                       | **Yes**  | ISO 4217 currency code reflecting the merchant's market determination. Derived from address, context, and geo IP—buyers provide signals, merchants determine currency.                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| totals       | Array\[[Total](/draft/specification/reference/#total)\]                                      | **Yes**  | Different cart totals.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| messages     | Array\[[Message](/draft/specification/reference/#message)\]                                  | No       | List of messages with error and info about the checkout session state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| links        | Array\[[Link](/draft/specification/reference/#link)\]                                        | **Yes**  | Links to be displayed by the platform (Privacy Policy, TOS). Mandatory for legal compliance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| expires_at   | string                                                                                       | No       | RFC 3339 expiry timestamp. Default TTL is 6 hours from creation if not sent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| continue_url | string                                                                                       | No       | URL for checkout handoff and session recovery. MUST be provided when status is requires_escalation. See specification for format and availability requirements.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| payment      | [Payment](/draft/specification/reference/#payment)                                           | No       | Payment configuration containing handlers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| order        | [Order Confirmation](/draft/specification/reference/#order-confirmation)                     | No       | Details about an order created for this checkout session.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

______________________________________________________________________

### Order

| Name          | Type                                                                                   | Required | Description                                                                                                                                  |
| ------------- | -------------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp           | [UCP Response Order Schema](/draft/specification/reference/#ucp-response-order-schema) | **Yes**  | Protocol metadata for discovery profiles and responses. Uses slim schema pattern with context-specific required fields.                      |
| id            | string                                                                                 | **Yes**  | Unique order identifier.                                                                                                                     |
| checkout_id   | string                                                                                 | **Yes**  | Associated checkout ID for reconciliation.                                                                                                   |
| permalink_url | string                                                                                 | **Yes**  | Permalink to access the order on merchant site.                                                                                              |
| line_items    | Array\[[Order Line Item](/draft/specification/reference/#order-line-item)\]            | **Yes**  | Immutable line items — source of truth for what was ordered.                                                                                 |
| fulfillment   | object                                                                                 | **Yes**  | Fulfillment data: buyer expectations and what actually happened.                                                                             |
| adjustments   | Array\[[Adjustment](/draft/specification/reference/#adjustment)\]                      | No       | Append-only event log of money movements (refunds, returns, credits, disputes, cancellations, etc.) that exist independently of fulfillment. |
| totals        | Array\[[Total](/draft/specification/reference/#total)\]                                | **Yes**  | Different totals for the order.                                                                                                              |

______________________________________________________________________

### Payment

| Name        | Type                                                                                                | Required | Description                                                                                                                                                                                                                |
| ----------- | --------------------------------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| instruments | Array\[[Selected Payment Instrument](/draft/specification/reference/#selected-payment-instrument)\] | No       | The payment instruments available for this payment. Each instrument is associated with a specific handler via the handler_id field. Handlers can extend the base payment_instrument schema to add handler-specific fields. |

______________________________________________________________________

## Type Schemas

### Payment Account Info

| Name                      | Type   | Required | Description                                                                                                                                   |
| ------------------------- | ------ | -------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| payment_account_reference | string | No       | EMVCo PAR. A unique identifier linking a payment card to a specific account, enabling tracking across tokens (Apple Pay, physical card, etc). |

______________________________________________________________________

### Adjustment

| Name        | Type          | Required | Description                                                                                                                                                                                     |
| ----------- | ------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id          | string        | **Yes**  | Adjustment event identifier.                                                                                                                                                                    |
| type        | string        | **Yes**  | Type of adjustment (open string). Typically money-related like: refund, return, credit, price_adjustment, dispute, cancellation. Can be any value that makes sense for the merchant's business. |
| occurred_at | string        | **Yes**  | RFC 3339 timestamp when this adjustment occurred.                                                                                                                                               |
| status      | string        | **Yes**  | Adjustment status. **Enum:** `pending`, `completed`, `failed`                                                                                                                                   |
| line_items  | Array[object] | No       | Which line items and quantities are affected (optional).                                                                                                                                        |
| amount      | integer       | No       | Amount in minor units (cents) for refunds, credits, price adjustments (optional).                                                                                                               |
| description | string        | No       | Human-readable reason or description (e.g., 'Defective item', 'Customer requested').                                                                                                            |

______________________________________________________________________

### Binding

| Name        | Type                                                                 | Required | Description                                                                                                                                                                                    |
| ----------- | -------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| checkout_id | string                                                               | **Yes**  | The checkout session identifier this token is bound to.                                                                                                                                        |
| identity    | [Payment Identity](/draft/specification/reference/#payment-identity) | No       | The participant this token is bound to. Required when acting on behalf of another participant (e.g., agent tokenizing for merchant). Omit when the authenticated caller is the binding target. |

______________________________________________________________________

### Business Fulfillment Config

| Name                       | Type         | Required | Description                                    |
| -------------------------- | ------------ | -------- | ---------------------------------------------- |
| allows_multi_destination   | object       | No       | Permits multiple destinations per method type. |
| allows_method_combinations | Array[array] | No       | Allowed method type combinations.              |

______________________________________________________________________

### Buyer

| Name         | Type   | Required | Description              |
| ------------ | ------ | -------- | ------------------------ |
| first_name   | string | No       | First name of the buyer. |
| last_name    | string | No       | Last name of the buyer.  |
| email        | string | No       | Email of the buyer.      |
| phone_number | string | No       | E.164 standard.          |

______________________________________________________________________

### Card Credential

| Name             | Type    | Required | Description                                                                                                                                            |
| ---------------- | ------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| type             | string  | **Yes**  | The credential type discriminator. Specific schemas will constrain this to a constant value.                                                           |
| type             | any     | **Yes**  | **Constant = card**. The credential type identifier for card credentials.                                                                              |
| card_number_type | string  | **Yes**  | The type of card number. Network tokens are preferred with fallback to FPAN. See PCI Scope for more details. **Enum:** `fpan`, `network_token`, `dpan` |
| number           | string  | No       | Card number.                                                                                                                                           |
| expiry_month     | integer | No       | The month of the card's expiration date (1-12).                                                                                                        |
| expiry_year      | integer | No       | The year of the card's expiration date.                                                                                                                |
| name             | string  | No       | Cardholder name.                                                                                                                                       |
| cvc              | string  | No       | Card CVC number.                                                                                                                                       |
| cryptogram       | string  | No       | Cryptogram provided with network tokens.                                                                                                               |
| eci_value        | string  | No       | Electronic Commerce Indicator / Security Level Indicator provided with network tokens.                                                                 |

______________________________________________________________________

### Card Payment Instrument

| Name            | Type                                                                     | Required | Description                                                                                                                                                  |
| --------------- | ------------------------------------------------------------------------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| id              | string                                                                   | **Yes**  | A unique identifier for this instrument instance, assigned by the platform.                                                                                  |
| handler_id      | string                                                                   | **Yes**  | The unique identifier for the handler instance that produced this instrument. This corresponds to the 'id' field in the Payment Handler definition.          |
| type            | string                                                                   | **Yes**  | The broad category of the instrument (e.g., 'card', 'tokenized_card'). Specific schemas will constrain this to a constant value.                             |
| billing_address | [Postal Address](/draft/specification/reference/#postal-address)         | No       | The billing address associated with this payment method.                                                                                                     |
| credential      | [Payment Credential](/draft/specification/reference/#payment-credential) | No       | The base definition for any payment credential. Handlers define specific credential types.                                                                   |
| display         | object                                                                   | No       | Display information for this payment instrument. Each payment instrument schema defines its specific display properties, as outlined by the payment handler. |
| type            | string                                                                   | **Yes**  | **Constant = card**. Indicates this is a card payment instrument.                                                                                            |
| display         | object                                                                   | No       | Display information for this card payment instrument.                                                                                                        |

______________________________________________________________________

### Context

| Name            | Type   | Required | Description                                                                                                                                                                                                                                                                                                                                                                         |
| --------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| address_country | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. Optional hint for market context (currency, availability, pricing)—higher-resolution data (e.g., shipping address) supersedes this value. |
| address_region  | string | No       | The region in which the locality is, and which is in the country. For example, California or another appropriate first-level Administrative division. Optional hint for progressive localization—higher-resolution data (e.g., shipping address) supersedes this value.                                                                                                             |
| postal_code     | string | No       | The postal code. For example, 94043. Optional hint for regional refinement—higher-resolution data (e.g., shipping address) supersedes this value.                                                                                                                                                                                                                                   |
| intent          | string | No       | Background context describing buyer's intent (e.g., 'looking for a gift under $50', 'need something durable for outdoor use'). Informs relevance, recommendations, and personalization.                                                                                                                                                                                             |

______________________________________________________________________

### Expectation

| Name           | Type                                                             | Required | Description                                                                                                 |
| -------------- | ---------------------------------------------------------------- | -------- | ----------------------------------------------------------------------------------------------------------- |
| id             | string                                                           | **Yes**  | Expectation identifier.                                                                                     |
| line_items     | Array[object]                                                    | **Yes**  | Which line items and quantities are in this expectation.                                                    |
| method_type    | string                                                           | **Yes**  | Delivery method type (shipping, pickup, digital). **Enum:** `shipping`, `pickup`, `digital`                 |
| destination    | [Postal Address](/draft/specification/reference/#postal-address) | **Yes**  | Delivery destination address.                                                                               |
| description    | string                                                           | No       | Human-readable delivery description (e.g., 'Arrives in 5-8 business days').                                 |
| fulfillable_on | string                                                           | No       | When this expectation can be fulfilled: 'now' or ISO 8601 timestamp for future date (backorder, pre-order). |

______________________________________________________________________

### Fulfillment

| Name              | Type                                                                                                  | Required | Description                         |
| ----------------- | ----------------------------------------------------------------------------------------------------- | -------- | ----------------------------------- |
| methods           | Array\[[Fulfillment Method](/draft/specification/reference/#fulfillment-method)\]                     | No       | Fulfillment methods for cart items. |
| available_methods | Array\[[Fulfillment Available Method](/draft/specification/reference/#fulfillment-available-method)\] | No       | Inventory availability hints.       |

______________________________________________________________________

### Fulfillment Available Method

| Name           | Type               | Required | Description                                                                              |
| -------------- | ------------------ | -------- | ---------------------------------------------------------------------------------------- |
| type           | string             | **Yes**  | Fulfillment method type this availability applies to. **Enum:** `shipping`, `pickup`     |
| line_item_ids  | Array[string]      | **Yes**  | Line items available for this fulfillment method.                                        |
| fulfillable_on | ['string', 'null'] | No       | 'now' for immediate availability, or ISO 8601 date for future (preorders, transfers).    |
| description    | string             | No       | Human-readable availability info (e.g., 'Available for pickup at Downtown Store today'). |

______________________________________________________________________

### Fulfillment Destination

This object MUST be one of the following types: [Shipping Destination](/draft/specification/reference/#shipping-destination), [Retail Location](/draft/specification/reference/#retail-location).

______________________________________________________________________

### Fulfillment Event

| Name            | Type          | Required | Description                                                                                                                                                                                                                                                                                                                             |
| --------------- | ------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id              | string        | **Yes**  | Fulfillment event identifier.                                                                                                                                                                                                                                                                                                           |
| occurred_at     | string        | **Yes**  | RFC 3339 timestamp when this fulfillment event occurred.                                                                                                                                                                                                                                                                                |
| type            | string        | **Yes**  | Fulfillment event type. Common values include: processing (preparing to ship), shipped (handed to carrier), in_transit (in delivery network), delivered (received by buyer), failed_attempt (delivery attempt failed), canceled (fulfillment canceled), undeliverable (cannot be delivered), returned_to_sender (returned to merchant). |
| line_items      | Array[object] | **Yes**  | Which line items and quantities are fulfilled in this event.                                                                                                                                                                                                                                                                            |
| tracking_number | string        | No       | Carrier tracking number (required if type != processing).                                                                                                                                                                                                                                                                               |
| tracking_url    | string        | No       | URL to track this shipment (required if type != processing).                                                                                                                                                                                                                                                                            |
| carrier         | string        | No       | Carrier name (e.g., 'FedEx', 'USPS').                                                                                                                                                                                                                                                                                                   |
| description     | string        | No       | Human-readable description of the shipment status or delivery information (e.g., 'Delivered to front door', 'Out for delivery').                                                                                                                                                                                                        |

______________________________________________________________________

### Fulfillment Group

| Name               | Type                                                                              | Required | Description                                                            |
| ------------------ | --------------------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------- |
| id                 | string                                                                            | **Yes**  | Group identifier for referencing merchant-generated groups in updates. |
| line_item_ids      | Array[string]                                                                     | **Yes**  | Line item IDs included in this group/package.                          |
| options            | Array\[[Fulfillment Option](/draft/specification/reference/#fulfillment-option)\] | No       | Available fulfillment options for this group.                          |
| selected_option_id | ['string', 'null']                                                                | No       | ID of the selected fulfillment option for this group.                  |

______________________________________________________________________

### Fulfillment Method

| Name                    | Type                                                                                        | Required | Description                                                                                                  |
| ----------------------- | ------------------------------------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------ |
| id                      | string                                                                                      | **Yes**  | Unique fulfillment method identifier.                                                                        |
| type                    | string                                                                                      | **Yes**  | Fulfillment method type. **Enum:** `shipping`, `pickup`                                                      |
| line_item_ids           | Array[string]                                                                               | **Yes**  | Line item IDs fulfilled via this method.                                                                     |
| destinations            | Array\[[Fulfillment Destination](/draft/specification/reference/#fulfillment-destination)\] | No       | Available destinations. For shipping: addresses. For pickup: retail locations.                               |
| selected_destination_id | ['string', 'null']                                                                          | No       | ID of the selected destination.                                                                              |
| groups                  | Array\[[Fulfillment Group](/draft/specification/reference/#fulfillment-group)\]             | No       | Fulfillment groups for selecting options. Agent sets selected_option_id on groups to choose shipping method. |

______________________________________________________________________

### Fulfillment Option

| Name                      | Type                                                    | Required | Description                                                                |
| ------------------------- | ------------------------------------------------------- | -------- | -------------------------------------------------------------------------- |
| id                        | string                                                  | **Yes**  | Unique fulfillment option identifier.                                      |
| title                     | string                                                  | **Yes**  | Short label (e.g., 'Express Shipping', 'Curbside Pickup').                 |
| description               | string                                                  | No       | Complete context for buyer decision (e.g., 'Arrives Dec 12-15 via FedEx'). |
| carrier                   | string                                                  | No       | Carrier name (for shipping).                                               |
| earliest_fulfillment_time | string                                                  | No       | Earliest fulfillment date.                                                 |
| latest_fulfillment_time   | string                                                  | No       | Latest fulfillment date.                                                   |
| totals                    | Array\[[Total](/draft/specification/reference/#total)\] | **Yes**  | Fulfillment option totals breakdown.                                       |

______________________________________________________________________

### Item

| Name      | Type    | Required | Description                                                                                                                                                                 |
| --------- | ------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id        | string  | **Yes**  | The product identifier, often the SKU, required to resolve the product details associated with this line item. Should be recognized by both the Platform, and the Business. |
| title     | string  | **Yes**  | Product title.                                                                                                                                                              |
| price     | integer | **Yes**  | Unit price in minor (cents) currency units.                                                                                                                                 |
| image_url | string  | No       | Product image URI.                                                                                                                                                          |

______________________________________________________________________

### Line Item

| Name      | Type                                                    | Required | Description                                            |
| --------- | ------------------------------------------------------- | -------- | ------------------------------------------------------ |
| id        | string                                                  | **Yes**  |                                                        |
| item      | [Item](/draft/specification/reference/#item)            | **Yes**  |                                                        |
| quantity  | integer                                                 | **Yes**  | Quantity of the item being purchased.                  |
| totals    | Array\[[Total](/draft/specification/reference/#total)\] | **Yes**  | Line item totals breakdown.                            |
| parent_id | string                                                  | No       | Parent line item identifier for any nested structures. |

______________________________________________________________________

### Link

| Name  | Type   | Required | Description                                                                                                                                                                                                                          |
| ----- | ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| type  | string | **Yes**  | Type of link. Well-known values: `privacy_policy`, `terms_of_service`, `refund_policy`, `shipping_policy`, `faq`. Consumers SHOULD handle unknown values gracefully by displaying them using the `title` field or omitting the link. |
| url   | string | **Yes**  | The actual URL pointing to the content to be displayed.                                                                                                                                                                              |
| title | string | No       | Optional display text for the link. When provided, use this instead of generating from type.                                                                                                                                         |

______________________________________________________________________

### Merchant Fulfillment Config

| Name                       | Type         | Required | Description                                    |
| -------------------------- | ------------ | -------- | ---------------------------------------------- |
| allows_multi_destination   | object       | No       | Permits multiple destinations per method type. |
| allows_method_combinations | Array[array] | No       | Allowed method type combinations.              |

______________________________________________________________________

### Message

This object MUST be one of the following types: [Message Error](/draft/specification/reference/#message-error), [Message Warning](/draft/specification/reference/#message-warning), [Message Info](/draft/specification/reference/#message-info).

______________________________________________________________________

### Message Error

| Name         | Type   | Required | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------------ | ------ | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = error**. Message type discriminator.                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| code         | string | **Yes**  | Error code. Possible values include: missing, invalid, out_of_stock, payment_declined, requires_sign_in, requires_3ds, requires_identity_linking. Freeform codes also allowed.                                                                                                                                                                                                                                                                                                                                 |
| path         | string | No       | RFC 9535 JSONPath to the component the message refers to (e.g., $.items[1]).                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown`                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| content      | string | **Yes**  | Human-readable message.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| severity     | string | **Yes**  | Declares who resolves this error. 'recoverable': agent can fix via API. 'requires_buyer_input': merchant requires information their API doesn't support collecting programmatically (checkout incomplete). 'requires_buyer_review': buyer must authorize before order placement due to policy, regulatory, or entitlement rules (checkout complete). Errors with 'requires\_*' severity contribute to 'status: requires_escalation'.* *Enum:*\* `recoverable`, `requires_buyer_input`, `requires_buyer_review` |

______________________________________________________________________

### Message Info

| Name         | Type   | Required | Description                                                    |
| ------------ | ------ | -------- | -------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = info**. Message type discriminator.               |
| path         | string | No       | RFC 9535 JSONPath to the component the message refers to.      |
| code         | string | No       | Info code for programmatic handling.                           |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown` |
| content      | string | **Yes**  | Human-readable message.                                        |

______________________________________________________________________

### Message Warning

| Name         | Type   | Required | Description                                                                                                                           |
| ------------ | ------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| type         | string | **Yes**  | **Constant = warning**. Message type discriminator.                                                                                   |
| path         | string | No       | JSONPath (RFC 9535) to related field (e.g., $.line_items[0]).                                                                         |
| code         | string | **Yes**  | Warning code. Machine-readable identifier for the warning type (e.g., final_sale, prop65, fulfillment_changed, age_restricted, etc.). |
| content      | string | **Yes**  | Human-readable warning message that MUST be displayed.                                                                                |
| content_type | string | No       | Content format, default = plain. **Enum:** `plain`, `markdown`                                                                        |

______________________________________________________________________

### Order Confirmation

| Name          | Type   | Required | Description                                     |
| ------------- | ------ | -------- | ----------------------------------------------- |
| id            | string | **Yes**  | Unique order identifier.                        |
| permalink_url | string | **Yes**  | Permalink to access the order on merchant site. |

______________________________________________________________________

### Order Line Item

| Name      | Type                                                    | Required | Description                                                                                                                                                                |
| --------- | ------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| id        | string                                                  | **Yes**  | Line item identifier.                                                                                                                                                      |
| item      | [Item](/draft/specification/reference/#item)            | **Yes**  | Product data (id, title, price, image_url).                                                                                                                                |
| quantity  | object                                                  | **Yes**  | Quantity tracking. Both total and fulfilled are derived from events.                                                                                                       |
| totals    | Array\[[Total](/draft/specification/reference/#total)\] | **Yes**  | Line item totals breakdown.                                                                                                                                                |
| status    | string                                                  | **Yes**  | Derived status: fulfilled if quantity.fulfilled == quantity.total, partial if quantity.fulfilled > 0, otherwise processing. **Enum:** `processing`, `partial`, `fulfilled` |
| parent_id | string                                                  | No       | Parent line item identifier for any nested structures.                                                                                                                     |

______________________________________________________________________

### Payment Credential

| Name | Type   | Required | Description                                                                                  |
| ---- | ------ | -------- | -------------------------------------------------------------------------------------------- |
| type | string | **Yes**  | The credential type discriminator. Specific schemas will constrain this to a constant value. |

______________________________________________________________________

### Payment Identity

| Name         | Type   | Required | Description                                                                            |
| ------------ | ------ | -------- | -------------------------------------------------------------------------------------- |
| access_token | string | **Yes**  | Unique identifier for this participant, obtained during onboarding with the tokenizer. |

______________________________________________________________________

### Payment Instrument

| Name            | Type                                                                     | Required | Description                                                                                                                                                  |
| --------------- | ------------------------------------------------------------------------ | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| id              | string                                                                   | **Yes**  | A unique identifier for this instrument instance, assigned by the platform.                                                                                  |
| handler_id      | string                                                                   | **Yes**  | The unique identifier for the handler instance that produced this instrument. This corresponds to the 'id' field in the Payment Handler definition.          |
| type            | string                                                                   | **Yes**  | The broad category of the instrument (e.g., 'card', 'tokenized_card'). Specific schemas will constrain this to a constant value.                             |
| billing_address | [Postal Address](/draft/specification/reference/#postal-address)         | No       | The billing address associated with this payment method.                                                                                                     |
| credential      | [Payment Credential](/draft/specification/reference/#payment-credential) | No       | The base definition for any payment credential. Handlers define specific credential types.                                                                   |
| display         | object                                                                   | No       | Display information for this payment instrument. Each payment instrument schema defines its specific display properties, as outlined by the payment handler. |

______________________________________________________________________

### Platform Fulfillment Config

| Name                 | Type    | Required | Description                         |
| -------------------- | ------- | -------- | ----------------------------------- |
| supports_multi_group | boolean | No       | Enables multiple groups per method. |

______________________________________________________________________

### Postal Address

| Name             | Type   | Required | Description                                                                                                                                                                                                                               |
| ---------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extended_address | string | No       | An address extension such as an apartment number, C/O or alternative name.                                                                                                                                                                |
| street_address   | string | No       | The street address.                                                                                                                                                                                                                       |
| address_locality | string | No       | The locality in which the street address is, and which is in the region. For example, Mountain View.                                                                                                                                      |
| address_region   | string | No       | The region in which the locality is, and which is in the country. Required for applicable countries (i.e. state in US, province in CA). For example, California or another appropriate first-level Administrative division.               |
| address_country  | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. |
| postal_code      | string | No       | The postal code. For example, 94043.                                                                                                                                                                                                      |
| first_name       | string | No       | Optional. First name of the contact associated with the address.                                                                                                                                                                          |
| last_name        | string | No       | Optional. Last name of the contact associated with the address.                                                                                                                                                                           |
| phone_number     | string | No       | Optional. Phone number of the contact associated with the address.                                                                                                                                                                        |

______________________________________________________________________

### Retail Location

| Name    | Type                                                             | Required | Description                       |
| ------- | ---------------------------------------------------------------- | -------- | --------------------------------- |
| id      | string                                                           | **Yes**  | Unique location identifier.       |
| name    | string                                                           | **Yes**  | Location name (e.g., store name). |
| address | [Postal Address](/draft/specification/reference/#postal-address) | No       | Physical address of the location. |

______________________________________________________________________

### Shipping Destination

| Name             | Type   | Required | Description                                                                                                                                                                                                                               |
| ---------------- | ------ | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extended_address | string | No       | An address extension such as an apartment number, C/O or alternative name.                                                                                                                                                                |
| street_address   | string | No       | The street address.                                                                                                                                                                                                                       |
| address_locality | string | No       | The locality in which the street address is, and which is in the region. For example, Mountain View.                                                                                                                                      |
| address_region   | string | No       | The region in which the locality is, and which is in the country. Required for applicable countries (i.e. state in US, province in CA). For example, California or another appropriate first-level Administrative division.               |
| address_country  | string | No       | The country. Recommended to be in 2-letter ISO 3166-1 alpha-2 format, for example "US". For backward compatibility, a 3-letter ISO 3166-1 alpha-3 country code such as "SGP" or a full country name such as "Singapore" can also be used. |
| postal_code      | string | No       | The postal code. For example, 94043.                                                                                                                                                                                                      |
| first_name       | string | No       | Optional. First name of the contact associated with the address.                                                                                                                                                                          |
| last_name        | string | No       | Optional. Last name of the contact associated with the address.                                                                                                                                                                           |
| phone_number     | string | No       | Optional. Phone number of the contact associated with the address.                                                                                                                                                                        |
| id               | string | **Yes**  | ID specific to this shipping destination.                                                                                                                                                                                                 |

______________________________________________________________________

### Token Credential

| Name  | Type   | Required | Description                                                                                  |
| ----- | ------ | -------- | -------------------------------------------------------------------------------------------- |
| type  | string | **Yes**  | The credential type discriminator. Specific schemas will constrain this to a constant value. |
| type  | string | **Yes**  | The specific type of token produced by the handler (e.g., 'stripe_token').                   |
| token | string | **Yes**  | The token value.                                                                             |

______________________________________________________________________

### Total

| Name         | Type    | Required | Description                                                                                                                   |
| ------------ | ------- | -------- | ----------------------------------------------------------------------------------------------------------------------------- |
| type         | string  | **Yes**  | Type of total categorization. **Enum:** `items_discount`, `subtotal`, `discount`, `fulfillment`, `tax`, `fee`, `total`        |
| display_text | string  | No       | Text to display against the amount. Should reflect appropriate method (e.g., 'Shipping', 'Delivery').                         |
| amount       | integer | **Yes**  | If type == total, sums subtotal - discount + fulfillment + tax + fee. Should be >= 0. Amount in minor (cents) currency units. |

______________________________________________________________________

## Extension Schemas

### AP2 Mandate Extension

#### Merchant Authorization

JWS Detached Content signature (RFC 7515 Appendix F) over the checkout response body (excluding ap2 field). Format: `<base64url-header>..<base64url-signature>`. The header MUST contain 'alg' (ES256/ES384/ES512) and 'kid' claims. The signature covers both the header and JCS-canonicalized checkout payload.

**Pattern:** `^[A-Za-z0-9_-]+\.\.[A-Za-z0-9_-]+$`

#### Checkout Mandate

SD-JWT+kb credential in `ap2.checkout_mandate`. Proving user authorization for the checkout. Contains the full checkout including `ap2.merchant_authorization`.

**Pattern:** `^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]*\.[A-Za-z0-9_-]+(~[A-Za-z0-9_-]+)*$`

#### Ap2 With Merchant Authorization

| Name                   | Type                                                                             | Required | Description                                                |
| ---------------------- | -------------------------------------------------------------------------------- | -------- | ---------------------------------------------------------- |
| merchant_authorization | [Merchant Authorization](/draft/specification/reference/#merchant-authorization) | No       | Merchant's signature proving checkout terms are authentic. |

#### Ap2 With Checkout Mandate

| Name             | Type                                                                 | Required | Description                                      |
| ---------------- | -------------------------------------------------------------------- | -------- | ------------------------------------------------ |
| checkout_mandate | [Checkout Mandate](/draft/specification/reference/#checkout-mandate) | No       | SD-JWT+kb proving user authorized this checkout. |

#### Checkout with AP2 Mandate

| Name         | Type          | Required | Description                                                                                                                                                                                                                                                     |
| ------------ | ------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | any           | **Yes**  | UCP metadata for checkout responses.                                                                                                                                                                                                                            |
| id           | string        | **Yes**  | Unique identifier of the checkout session.                                                                                                                                                                                                                      |
| line_items   | Array[object] | **Yes**  | List of line items being checked out.                                                                                                                                                                                                                           |
| buyer        | object        | No       | Representation of the buyer.                                                                                                                                                                                                                                    |
| status       | string        | **Yes**  | Checkout state indicating the current phase and required action. See Checkout Status lifecycle documentation for state transition details. **Enum:** `incomplete`, `requires_escalation`, `ready_for_complete`, `complete_in_progress`, `completed`, `canceled` |
| currency     | string        | **Yes**  | ISO 4217 currency code reflecting the merchant's market determination. Derived from address, context, and geo IP—buyers provide signals, merchants determine currency.                                                                                          |
| totals       | Array[object] | **Yes**  | Different cart totals.                                                                                                                                                                                                                                          |
| messages     | Array[object] | No       | List of messages with error and info about the checkout session state.                                                                                                                                                                                          |
| links        | Array[object] | **Yes**  | Links to be displayed by the platform (Privacy Policy, TOS). Mandatory for legal compliance.                                                                                                                                                                    |
| expires_at   | string        | No       | RFC 3339 expiry timestamp. Default TTL is 6 hours from creation if not sent.                                                                                                                                                                                    |
| continue_url | string        | No       | URL for checkout handoff and session recovery. MUST be provided when status is requires_escalation. See specification for format and availability requirements.                                                                                                 |
| payment      | object        | No       | Payment configuration containing handlers.                                                                                                                                                                                                                      |
| order        | object        | No       | Details about an order created for this checkout session.                                                                                                                                                                                                       |
| ap2          | any           | No       |                                                                                                                                                                                                                                                                 |

#### AP2 Error Code

Error codes specific to AP2 mandate verification.

**Enum:** `mandate_required`, `agent_missing_key`, `mandate_invalid_signature`, `mandate_expired`, `mandate_scope_mismatch`, `merchant_authorization_invalid`, `merchant_authorization_missing`

______________________________________________________________________

### Buyer Consent Extension

#### Consent

| Name         | Type    | Required | Description                                       |
| ------------ | ------- | -------- | ------------------------------------------------- |
| analytics    | boolean | No       | Consent for analytics and performance tracking.   |
| preferences  | boolean | No       | Consent for storing user preferences.             |
| marketing    | boolean | No       | Consent for marketing communications.             |
| sale_of_data | boolean | No       | Consent for selling data to third parties (CCPA). |

#### Buyer with Consent

| Name         | Type                                               | Required | Description              |
| ------------ | -------------------------------------------------- | -------- | ------------------------ |
| first_name   | string                                             | No       | First name of the buyer. |
| last_name    | string                                             | No       | Last name of the buyer.  |
| email        | string                                             | No       | Email of the buyer.      |
| phone_number | string                                             | No       | E.164 standard.          |
| consent      | [Consent](/draft/specification/reference/#consent) | No       | Consent tracking fields. |

#### Checkout with Buyer Consent

| Name         | Type                                           | Required | Description                                                                                                                                                                                                                                                     |
| ------------ | ---------------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | any                                            | **Yes**  | UCP metadata for checkout responses.                                                                                                                                                                                                                            |
| id           | string                                         | **Yes**  | Unique identifier of the checkout session.                                                                                                                                                                                                                      |
| line_items   | Array[object]                                  | **Yes**  | List of line items being checked out.                                                                                                                                                                                                                           |
| buyer        | object                                         | No       | Representation of the buyer.                                                                                                                                                                                                                                    |
| status       | string                                         | **Yes**  | Checkout state indicating the current phase and required action. See Checkout Status lifecycle documentation for state transition details. **Enum:** `incomplete`, `requires_escalation`, `ready_for_complete`, `complete_in_progress`, `completed`, `canceled` |
| currency     | string                                         | **Yes**  | ISO 4217 currency code reflecting the merchant's market determination. Derived from address, context, and geo IP—buyers provide signals, merchants determine currency.                                                                                          |
| totals       | Array[object]                                  | **Yes**  | Different cart totals.                                                                                                                                                                                                                                          |
| messages     | Array[object]                                  | No       | List of messages with error and info about the checkout session state.                                                                                                                                                                                          |
| links        | Array[object]                                  | **Yes**  | Links to be displayed by the platform (Privacy Policy, TOS). Mandatory for legal compliance.                                                                                                                                                                    |
| expires_at   | string                                         | No       | RFC 3339 expiry timestamp. Default TTL is 6 hours from creation if not sent.                                                                                                                                                                                    |
| continue_url | string                                         | No       | URL for checkout handoff and session recovery. MUST be provided when status is requires_escalation. See specification for format and availability requirements.                                                                                                 |
| payment      | object                                         | No       | Payment configuration containing handlers.                                                                                                                                                                                                                      |
| order        | object                                         | No       | Details about an order created for this checkout session.                                                                                                                                                                                                       |
| buyer        | [Buyer](/draft/specification/reference/#buyer) | No       | Buyer with consent tracking.                                                                                                                                                                                                                                    |

______________________________________________________________________

### Discount Extension

#### Allocation

| Name   | Type    | Required | Description                                                                       |
| ------ | ------- | -------- | --------------------------------------------------------------------------------- |
| path   | string  | **Yes**  | JSONPath to the allocation target (e.g., '$.line_items[0]', '$.totals.shipping'). |
| amount | integer | **Yes**  | Amount allocated to this target in minor (cents) currency units.                  |

#### Applied Discount

| Name        | Type                                                              | Required | Description                                                                                                                      |
| ----------- | ----------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------- |
| code        | string                                                            | No       | The discount code. Omitted for automatic discounts.                                                                              |
| title       | string                                                            | **Yes**  | Human-readable discount name (e.g., 'Summer Sale 20% Off').                                                                      |
| amount      | integer                                                           | **Yes**  | Total discount amount in minor (cents) currency units.                                                                           |
| automatic   | boolean                                                           | No       | True if applied automatically by merchant rules (no code required).                                                              |
| method      | string                                                            | No       | Allocation method. 'each' = applied independently per item. 'across' = split proportionally by value. **Enum:** `each`, `across` |
| priority    | integer                                                           | No       | Stacking order for discount calculation. Lower numbers applied first (1 = first).                                                |
| allocations | Array\[[Allocation](/draft/specification/reference/#allocation)\] | No       | Breakdown of where this discount was allocated. Sum of allocation amounts equals total amount.                                   |

#### Discounts Object

| Name    | Type                                                                          | Required | Description                                                                                                |
| ------- | ----------------------------------------------------------------------------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| codes   | Array[string]                                                                 | No       | Discount codes to apply. Case-insensitive. Replaces previously submitted codes. Send empty array to clear. |
| applied | Array\[[Applied Discount](/draft/specification/reference/#applied-discount)\] | No       | Discounts successfully applied (code-based and automatic).                                                 |

#### Checkout with Discount

| Name         | Type                                                                 | Required | Description                                                                                                                                                                                                                                                     |
| ------------ | -------------------------------------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | any                                                                  | **Yes**  | UCP metadata for checkout responses.                                                                                                                                                                                                                            |
| id           | string                                                               | **Yes**  | Unique identifier of the checkout session.                                                                                                                                                                                                                      |
| line_items   | Array[object]                                                        | **Yes**  | List of line items being checked out.                                                                                                                                                                                                                           |
| buyer        | object                                                               | No       | Representation of the buyer.                                                                                                                                                                                                                                    |
| status       | string                                                               | **Yes**  | Checkout state indicating the current phase and required action. See Checkout Status lifecycle documentation for state transition details. **Enum:** `incomplete`, `requires_escalation`, `ready_for_complete`, `complete_in_progress`, `completed`, `canceled` |
| currency     | string                                                               | **Yes**  | ISO 4217 currency code reflecting the merchant's market determination. Derived from address, context, and geo IP—buyers provide signals, merchants determine currency.                                                                                          |
| totals       | Array[object]                                                        | **Yes**  | Different cart totals.                                                                                                                                                                                                                                          |
| messages     | Array[object]                                                        | No       | List of messages with error and info about the checkout session state.                                                                                                                                                                                          |
| links        | Array[object]                                                        | **Yes**  | Links to be displayed by the platform (Privacy Policy, TOS). Mandatory for legal compliance.                                                                                                                                                                    |
| expires_at   | string                                                               | No       | RFC 3339 expiry timestamp. Default TTL is 6 hours from creation if not sent.                                                                                                                                                                                    |
| continue_url | string                                                               | No       | URL for checkout handoff and session recovery. MUST be provided when status is requires_escalation. See specification for format and availability requirements.                                                                                                 |
| payment      | object                                                               | No       | Payment configuration containing handlers.                                                                                                                                                                                                                      |
| order        | object                                                               | No       | Details about an order created for this checkout session.                                                                                                                                                                                                       |
| discounts    | [Discounts Object](/draft/specification/reference/#discounts-object) | No       |                                                                                                                                                                                                                                                                 |

______________________________________________________________________

### Fulfillment Extension

#### Fulfillment Option

| Name                      | Type          | Required | Description                                                                |
| ------------------------- | ------------- | -------- | -------------------------------------------------------------------------- |
| id                        | string        | **Yes**  | Unique fulfillment option identifier.                                      |
| title                     | string        | **Yes**  | Short label (e.g., 'Express Shipping', 'Curbside Pickup').                 |
| description               | string        | No       | Complete context for buyer decision (e.g., 'Arrives Dec 12-15 via FedEx'). |
| carrier                   | string        | No       | Carrier name (for shipping).                                               |
| earliest_fulfillment_time | string        | No       | Earliest fulfillment date.                                                 |
| latest_fulfillment_time   | string        | No       | Latest fulfillment date.                                                   |
| totals                    | Array[object] | **Yes**  | Fulfillment option totals breakdown.                                       |

#### Fulfillment Group

| Name               | Type               | Required | Description                                                            |
| ------------------ | ------------------ | -------- | ---------------------------------------------------------------------- |
| id                 | string             | **Yes**  | Group identifier for referencing merchant-generated groups in updates. |
| line_item_ids      | Array[string]      | **Yes**  | Line item IDs included in this group/package.                          |
| options            | Array[object]      | No       | Available fulfillment options for this group.                          |
| selected_option_id | ['string', 'null'] | No       | ID of the selected fulfillment option for this group.                  |

#### Fulfillment Method

| Name                    | Type               | Required | Description                                                                                                  |
| ----------------------- | ------------------ | -------- | ------------------------------------------------------------------------------------------------------------ |
| id                      | string             | **Yes**  | Unique fulfillment method identifier.                                                                        |
| type                    | string             | **Yes**  | Fulfillment method type. **Enum:** `shipping`, `pickup`                                                      |
| line_item_ids           | Array[string]      | **Yes**  | Line item IDs fulfilled via this method.                                                                     |
| destinations            | Array[object]      | No       | Available destinations. For shipping: addresses. For pickup: retail locations.                               |
| selected_destination_id | ['string', 'null'] | No       | ID of the selected destination.                                                                              |
| groups                  | Array[object]      | No       | Fulfillment groups for selecting options. Agent sets selected_option_id on groups to choose shipping method. |

#### Fulfillment Available Method

| Name           | Type               | Required | Description                                                                              |
| -------------- | ------------------ | -------- | ---------------------------------------------------------------------------------------- |
| type           | string             | **Yes**  | Fulfillment method type this availability applies to. **Enum:** `shipping`, `pickup`     |
| line_item_ids  | Array[string]      | **Yes**  | Line items available for this fulfillment method.                                        |
| fulfillable_on | ['string', 'null'] | No       | 'now' for immediate availability, or ISO 8601 date for future (preorders, transfers).    |
| description    | string             | No       | Human-readable availability info (e.g., 'Available for pickup at Downtown Store today'). |

#### Fulfillment

| Name              | Type          | Required | Description                         |
| ----------------- | ------------- | -------- | ----------------------------------- |
| methods           | Array[object] | No       | Fulfillment methods for cart items. |
| available_methods | Array[object] | No       | Inventory availability hints.       |

#### Checkout with Fulfillment

| Name         | Type                                                       | Required | Description                                                                                                                                                                                                                                                     |
| ------------ | ---------------------------------------------------------- | -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ucp          | any                                                        | **Yes**  | UCP metadata for checkout responses.                                                                                                                                                                                                                            |
| id           | string                                                     | **Yes**  | Unique identifier of the checkout session.                                                                                                                                                                                                                      |
| line_items   | Array[object]                                              | **Yes**  | List of line items being checked out.                                                                                                                                                                                                                           |
| buyer        | object                                                     | No       | Representation of the buyer.                                                                                                                                                                                                                                    |
| status       | string                                                     | **Yes**  | Checkout state indicating the current phase and required action. See Checkout Status lifecycle documentation for state transition details. **Enum:** `incomplete`, `requires_escalation`, `ready_for_complete`, `complete_in_progress`, `completed`, `canceled` |
| currency     | string                                                     | **Yes**  | ISO 4217 currency code reflecting the merchant's market determination. Derived from address, context, and geo IP—buyers provide signals, merchants determine currency.                                                                                          |
| totals       | Array[object]                                              | **Yes**  | Different cart totals.                                                                                                                                                                                                                                          |
| messages     | Array[object]                                              | No       | List of messages with error and info about the checkout session state.                                                                                                                                                                                          |
| links        | Array[object]                                              | **Yes**  | Links to be displayed by the platform (Privacy Policy, TOS). Mandatory for legal compliance.                                                                                                                                                                    |
| expires_at   | string                                                     | No       | RFC 3339 expiry timestamp. Default TTL is 6 hours from creation if not sent.                                                                                                                                                                                    |
| continue_url | string                                                     | No       | URL for checkout handoff and session recovery. MUST be provided when status is requires_escalation. See specification for format and availability requirements.                                                                                                 |
| payment      | object                                                     | No       | Payment configuration containing handlers.                                                                                                                                                                                                                      |
| order        | object                                                     | No       | Details about an order created for this checkout session.                                                                                                                                                                                                       |
| fulfillment  | [Fulfillment](/draft/specification/reference/#fulfillment) | No       | Fulfillment details.                                                                                                                                                                                                                                            |

#### Dev.Ucp.Shopping.Fulfillment

*No properties defined.*

______________________________________________________________________

## UCP Metadata

The following schemas define the structure of UCP metadata used in discovery and responses.

### Platform Discovery Profile

The top-level structure of a platform profile document (hosted at a URI advertised by the platform).

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |
| services                                                                                    | any  | **Yes**  |             |
| capabilities                                                                                | any  | No       |             |
| payment_handlers                                                                            | any  | **Yes**  |             |

### Business Discovery Profile

The top-level structure of a business discovery document (`/.well-known/ucp`).

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |
| services                                                                                    | any  | **Yes**  |             |
| capabilities                                                                                | any  | No       |             |
| payment_handlers                                                                            | any  | **Yes**  |             |

### Checkout Response Metadata

The `ucp` object included in checkout responses.

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |
| services                                                                                    | any  | No       |             |
| capabilities                                                                                | any  | No       |             |
| payment_handlers                                                                            | any  | **Yes**  |             |

### Order Response Metadata

The `ucp` object included in order responses or events.

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |
| capabilities                                                                                | any  | No       |             |

### Capability

This object describes a single capability or extension. It appears in the `capabilities` array in discovery profiles and responses, with slightly different required fields in each context.

#### Capability (Discovery)

As seen in discovery profiles.

**Error:** Definition '#/$defs/discovery' not found in 'source/schemas/capability.json'

#### Capability (Response)

As seen in response messages.

| Name                                                                                        | Type | Required | Description |
| ------------------------------------------------------------------------------------------- | ---- | -------- | ----------- |
| **Error:** Failed to resolve ''. Ensure ucp-schema is installed: `cargo install ucp-schema` |      |          |             |
