{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ucp.dev/draft/schemas/shopping/ap2_mandate.json",
  "name": "dev.ucp.shopping.ap2_mandate",
  "title": "AP2 Mandate Extension",
  "description": "Extends Checkout with cryptographic mandate support for non-repudiable authorization per the AP2 protocol. Uses embedded signature model with ap2 namespace.",
  "$defs": {
    "merchant_authorization": {
      "title": "Merchant Authorization",
      "description": "JWS Detached Content signature (RFC 7515 Appendix F) over the checkout response body (excluding ap2 field). Format: `<base64url-header>..<base64url-signature>`. The header MUST contain 'alg' (ES256/ES384/ES512) and 'kid' claims. The signature covers both the header and JCS-canonicalized checkout payload.",
      "type": "string",
      "pattern": "^[A-Za-z0-9_-]+\\.\\.[A-Za-z0-9_-]+$"
    },
    "checkout_mandate": {
      "title": "Checkout Mandate",
      "description": "SD-JWT+kb credential in `ap2.checkout_mandate`. Proving user authorization for the checkout. Contains the full checkout including `ap2.merchant_authorization`.",
      "type": "string",
      "pattern": "^[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]*\\.[A-Za-z0-9_-]+(~[A-Za-z0-9_-]+)*$"
    },
    "ap2_with_merchant_authorization": {
      "type": "object",
      "description": "AP2 extension data including merchant authorization.",
      "properties": {
        "merchant_authorization": {
          "$ref": "#/$defs/merchant_authorization",
          "description": "Merchant's signature proving checkout terms are authentic.",
          "ucp_request": "omit"
        }
      }
    },
    "ap2_with_checkout_mandate": {
      "type": "object",
      "description": "AP2 extension data including checkout mandate.",
      "properties": {
        "checkout_mandate": {
          "$ref": "#/$defs/checkout_mandate",
          "description": "SD-JWT+kb proving user authorized this checkout.",
          "ucp_request": {
            "create": "omit",
            "update": "omit",
            "complete": "required"
          }
        }
      }
    },
    "dev.ucp.shopping.checkout": {
      "title": "Checkout with AP2 Mandate",
      "description": "Checkout extended with AP2 mandate support.",
      "allOf": [
        {
          "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json"
        },
        {
          "type": "object",
          "properties": {
            "ap2": {
              "allOf": [
                {
                  "$ref": "#/$defs/ap2_with_merchant_authorization"
                },
                {
                  "$ref": "#/$defs/ap2_with_checkout_mandate"
                }
              ],
              "ucp_request": {
                "create": "omit",
                "update": "omit",
                "complete": "required"
              }
            }
          }
        }
      ]
    },
    "error_code": {
      "title": "AP2 Error Code",
      "description": "Error codes specific to AP2 mandate verification.",
      "type": "string",
      "enum": [
        "mandate_required",
        "agent_missing_key",
        "mandate_invalid_signature",
        "mandate_expired",
        "mandate_scope_mismatch",
        "merchant_authorization_invalid",
        "merchant_authorization_missing"
      ]
    }
  },
  "version": "2026-02-11"
}