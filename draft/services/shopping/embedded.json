{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ucp.dev/services/shopping/embedded.json",
  "title": "Embedded Protocol",
  "description": "Embedded Protocol (EP) methods for UCP capabilities. Methods are sent from Merchant to Host via postMessage/JSON-RPC 2.0. Method prefixes indicate capability scope: ec.* (checkout). Future capabilities may define additional prefixes (e.g., eo.* for order).",
  "delegations": [
    "payment.instruments_change",
    "payment.credential"
  ],
  "methods": [
    {
      "name": "ec.ready",
      "summary": "Handshake from merchant to host",
      "description": "Initiates the Embedded Checkout Protocol. Merchant declares which delegations it accepts, host responds with optional channel upgrade and initial checkout state.",
      "params": [
        {
          "name": "delegate",
          "required": true,
          "schema": {
            "type": "array",
            "description": "Delegation types the merchant accepts. Must be subset of checkout.embedded.delegations.",
            "items": {
              "type": "string",
              "pattern": "^[a-z_]+(?:\\.[a-z_]+)*$"
            },
            "uniqueItems": true
          }
        }
      ],
      "result": {
        "name": "readyResult",
        "schema": {
          "type": "object",
          "description": "Handshake response from host.",
          "properties": {
            "upgrade": {
              "type": "object",
              "description": "Channel upgrade instructions. If present, switch to provided MessagePort.",
              "properties": {
                "port": {
                  "type": "object",
                  "description": "MessagePort for upgraded channel. Runtime type is MessagePort."
                }
              }
            },
            "checkout": {
              "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
              "description": "Initial checkout state with host-provided data (saved instruments, addresses)."
            }
          }
        }
      }
    },
    {
      "name": "ec.start",
      "summary": "Checkout visible to buyer",
      "description": "Merchant notifies host that checkout UI is visible and ready for interaction. Sent after successful ec.ready handshake.",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Current checkout state."
          }
        }
      ]
    },
    {
      "name": "ec.complete",
      "summary": "Checkout completed successfully",
      "description": "Merchant notifies host that order has been placed successfully.",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Final checkout state."
          }
        }
      ]
    },
    {
      "name": "ec.messages.change",
      "summary": "Checkout messages changed",
      "description": "Merchant notifies host that checkout.messages has changed. Includes errors, warnings, and info. Host should update UI accordingly.",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Current checkout state with updated messages."
          }
        }
      ]
    },
    {
      "name": "ec.line_items.change",
      "summary": "Line items changed",
      "description": "Merchant notifies host that checkout.line_items has changed (item added, removed, quantity updated).",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Current checkout state with updated line items."
          }
        }
      ]
    },
    {
      "name": "ec.buyer.change",
      "summary": "Buyer information changed",
      "description": "Merchant notifies host that checkout.buyer has changed (email, phone, address updated).",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Current checkout state with updated buyer."
          }
        }
      ]
    },
    {
      "name": "ec.payment.change",
      "summary": "Payment state changed",
      "description": "Merchant notifies host that checkout.payment has changed (instrument selected, status updated).",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Current checkout state with updated payment."
          }
        }
      ]
    },
    {
      "name": "ec.payment.instruments_change_request",
      "summary": "Request payment instrument change",
      "description": "Merchant requests host to present payment instrument selection UI for the buyer to change their payment method.",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Current checkout state."
          }
        }
      ],
      "result": {
        "name": "instrumentsChangeResult",
        "schema": {
          "type": "object",
          "description": "Checkout state after instrument selection.",
          "required": [
            "checkout"
          ],
          "properties": {
            "checkout": {
              "type": "object",
              "description": "Partial checkout update with payment instrument selection.",
              "properties": {
                "payment": {
                  "type": "object",
                  "properties": {
                    "selected_instrument_id": {
                      "type": "string",
                      "description": "ID of the selected payment instrument."
                    },
                    "instruments": {
                      "type": "array",
                      "items": {
                        "$ref": "https://ucp.dev/draft/schemas/shopping/types/payment_instrument.json#/$defs/selected_payment_instrument"
                      },
                      "description": "Available payment instruments after selection."
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "name": "ec.payment.credential_request",
      "summary": "Request payment credential",
      "description": "Merchant requests host to collect payment credential for selected instrument (CVV, 3DS, wallet confirmation).",
      "params": [
        {
          "name": "checkout",
          "required": true,
          "schema": {
            "$ref": "https://ucp.dev/draft/schemas/shopping/checkout.json",
            "description": "Current checkout state with selected instrument."
          }
        }
      ],
      "result": {
        "name": "credentialResult",
        "schema": {
          "type": "object",
          "description": "Checkout state with payment credential ready for completion.",
          "required": [
            "checkout"
          ],
          "properties": {
            "checkout": {
              "type": "object",
              "description": "Partial checkout update with payment credential.",
              "properties": {
                "payment": {
                  "type": "object",
                  "properties": {
                    "instruments": {
                      "type": "array",
                      "items": {
                        "$ref": "https://ucp.dev/draft/schemas/shopping/types/payment_instrument.json#/$defs/selected_payment_instrument"
                      },
                      "description": "Payment instruments with credential populated on selected instrument."
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  ]
}